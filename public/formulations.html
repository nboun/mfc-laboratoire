<!DOCTYPE html>
<html lang="fr">
<head>
<style id="mfc-auth-wall">body{visibility:hidden!important;}</style>
<script>try{if(localStorage.getItem("mfc_operator"))document.getElementById("mfc-auth-wall").remove();}catch(e){}</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#a32d03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Formulations - MFC Laboratoire</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" rel="stylesheet">
    <script src="js/theme-toggle.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="img/logo-mfc-carre.jpg" alt="MFC">
            <div class="brand-text"><h1>LABORATOIRE</h1><span>Ma√Ætre Cirier depuis 1904</span><span id="mfc-v" style="background:#a32d03;color:#fff;padding:0.1rem 0.4rem;border-radius:8px;font-size:0.55rem;font-weight:700;margin-left:0.4rem;letter-spacing:0.5px;"></span></div>
        </div>
        <div class="navbar-menu">
            <a href="index.html">Accueil</a>
            <a href="echantillons.html">√âchantillons</a>
            <a href="formulations.html" class="active">Formulations</a>
            <a href="tests.html">Tests</a>
            <a href="matieres.html">Mati√®res</a>
            <a href="recettes.html">Recettes</a>
            <a href="connaissances.html">Connaissances</a>
            <a href="fds.html">FDS Parfums</a><a href="formulateur.html">Formulateur</a>
            <a href="recherche.html">Recherche</a>
                <a href="analytics.html">üìä Analytics</a>
            <a href="molecules.html">üß¨ Mol√©cules</a>
            <a href="predictif.html">üîÆ Pr√©dictif</a>
            <a href="clients.html">Clients</a>
            <a href="operateurs.html">Op√©rateurs</a>
        </div>
    </nav>

    <div class="toast-container" id="toast-container"></div>

    <div class="container">
        <!-- Workflow -->
        <div class="workflow-bar">
            <div class="workflow-step completed clickable" onclick="location.href='echantillons.html'"><span class="step-num">‚úì</span><span class="step-label">√âchantillon</span></div>
            <div class="workflow-connector" style="background:var(--vert);"></div>
            <div class="workflow-step active"><span class="step-num">2</span><span class="step-label">Formulation</span></div>
            <div class="workflow-connector"></div>
            <div class="workflow-step clickable" onclick="location.href='tests.html'"><span class="step-num">3</span><span class="step-label">Test combustion</span></div>
            <div class="workflow-connector"></div>
            <div class="workflow-step"><span class="step-num">4</span><span class="step-label">Validation</span></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üß™ Formulations</h3>
                <div style="display:flex;gap:0.5rem;">
                    <button class="btn" onclick="openFormModal(null,'valid√©')" style="background:#27ae60;color:#fff;">‚úÖ Enregistrer une formulation valid√©e</button>
                    <button class="btn btn-primary" onclick="openFormModal()">+ Nouvelle formulation</button>
                </div>
            </div>
            <div class="filters">
                <select id="filter-status" class="form-control"><option value="">Tous les statuts</option><option value="en_cours">En cours</option><option value="en_attente">En attente</option><option value="import√©">Import√©</option><option value="valid√©">Valid√©</option></select>
                <input type="text" class="form-control" id="search-input" placeholder="Rechercher..." style="min-width:220px;">
            </div>
            <div class="table-container">
                <table>
                    <thead><tr>
                        <th>Code</th><th>√âchantillon</th><th>Client</th><th>Nom</th>
                        <th>Masse</th><th>Parfum</th><th>Cire</th><th>M√®che</th>
                        <th>Couleur</th><th>Statut</th><th>Actions</th>
                    </tr></thead>
                    <tbody id="formulations-table"><tr><td colspan="11" class="loading"><div class="spinner"></div></td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Rappel calculs -->
        <div class="card mt-2">
            <div class="card-header"><h3 class="card-title">üìê R√®gles de calcul MFC</h3></div>
            <div class="grid grid-3" style="gap:1rem;">
                <div style="background:var(--fond-surface); padding:1rem; border-radius:var(--radius); border-left:3px solid var(--mfc-cire);">
                    <p style="font-weight:600; color:var(--mfc-cire); font-size:0.8rem;">MASSE PARFUM</p>
                    <p style="font-size:0.88rem;">= Masse totale √ó % parfum</p>
                    <p class="text-muted" style="font-size:0.78rem;">Ex: 200g √ó 10% = 20g</p>
                </div>
                <div style="background:var(--fond-surface); padding:1rem; border-radius:var(--radius); border-left:3px solid var(--mfc-cire);">
                    <p style="font-weight:600; color:var(--mfc-cire); font-size:0.8rem;">MASSE CIRE</p>
                    <p style="font-size:0.88rem;">= Masse totale ‚àí Masse parfum</p>
                    <p class="text-muted" style="font-size:0.78rem;">Ex: 200g ‚àí 20g = 180g</p>
                </div>
                <div style="background:var(--fond-surface); padding:1rem; border-radius:var(--radius); border-left:3px solid var(--mfc-cire);">
                    <p style="font-weight:600; color:var(--mfc-cire); font-size:0.8rem;">COLORANT(S)</p>
                    <p style="font-size:0.88rem;">% variable selon la fiche terrain</p>
                    <p class="text-muted" style="font-size:0.78rem;">1 √† 5 colorants possibles (liquide ou solide)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL FORMULATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="form-modal">
        <div class="modal" style="max-width:820px;">
            <div class="modal-header"><h2 id="form-modal-title">Nouvelle formulation</h2><button class="modal-close" onclick="closeFormModal()">&times;</button></div>
            <div class="modal-body">
                <form id="formulation-form" onsubmit="return false;">
                    <input type="hidden" id="edit-id">

                    <div class="alert alert-info"><strong>Code :</strong> <span id="auto-code">...</span></div>

                    <!-- S√©lection √©chantillon -->
                    <div class="form-section">√âchantillon source</div>
                    <div class="form-group">
                        <label>√âchantillon</label>
                        <select class="form-control" id="sample_id" onchange="onSampleSelect()">
                            <option value="">‚Äî S√©lectionner un √©chantillon ‚Äî</option>
                        </select>
                    </div>
                    <div id="sample-inherited" style="display:none;">
                        <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:0.75rem 1rem; margin-bottom:0.75rem;">
                            <p style="font-size:0.68rem; text-transform:uppercase; letter-spacing:1px; color:var(--texte-muted); font-weight:600; margin-bottom:0.4rem;">Donn√©es h√©rit√©es de l'√©chantillon</p>
                            <div class="grid grid-4" style="gap:0.5rem;">
                                <div><span class="text-muted" style="font-size:0.68rem;">CLIENT</span><br><strong id="inh_client">‚Äî</strong></div>
                                <div><span class="text-muted" style="font-size:0.68rem;">TYPE</span><br><span id="inh_type">‚Äî</span></div>
                                <div><span class="text-muted" style="font-size:0.68rem;">DIMENSIONS</span><br><span id="inh_dims">‚Äî</span></div>
                                <div><span class="text-muted" style="font-size:0.68rem;">DEMANDE</span><br><span id="inh_request" style="font-size:0.82rem;">‚Äî</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Identification -->
                    <div class="form-section">Identification</div>
                    <div class="grid grid-2">
                        <div class="form-group"><label>Nom de la formulation *</label><input type="text" class="form-control" id="f_name" placeholder="Ex: Ambre Royal 65mm" required></div>
                        <div class="form-group">
                            <label>Statut</label>
                            <select class="form-control" id="f_status">
                                <option value="en_cours">En cours</option>
                                <option value="en_attente">En attente</option>
                                <option value="valid√©">Valid√©</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sp√©cifications -->
                    <div class="form-section">Sp√©cifications bougie</div>
                    <div class="grid grid-4">
                        <div class="form-group">
                            <label>Type contenant</label>
                            <select class="form-control" id="f_container">
                                <option value="container">Container</option><option value="pilier">Pilier</option>
                                <option value="moulee">Moul√©e</option><option value="chandelle">Chandelle</option><option value="votive">Votive</option><option value="chauffe-plat">Chauffe-plat</option><option value="figurine">Figurine</option><option value="massage">Massage</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Diam√®tre (mm)</label><input type="number" class="form-control" id="f_diameter" placeholder="65"></div>
                        <div class="form-group"><label>Hauteur (mm)</label><input type="number" class="form-control" id="f_height" placeholder="82"></div>
                        <div class="form-group"><label>Version</label><input type="number" class="form-control" id="f_version" value="1" min="1"></div>
                    </div>

                    <!-- Masse et calculs -->
                    <div class="form-section">Masse et d√©composition</div>
                    <div class="form-group">
                        <label>Parfum</label>
                        <div class="input-group">
                            <select class="form-control" id="f_fragrance_id" onchange="onFormFragranceSelect()">
                                <option value="">‚Äî Saisie libre ou s√©lection ‚Äî</option>
                            </select>
                            <button class="btn btn-primary btn-sm" type="button" onclick="openFormFragranceModal()" title="Cr√©er un nouveau parfum">+</button>
                        </div>
                    </div>
                    <div id="f-fragrance-info" style="display:none;">
                        <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:0.5rem 0.75rem; margin-bottom:0.5rem; font-size:0.8rem;">
                            <span id="f-fragrance-detail"></span>
                        </div>
                    </div>
                    <div class="grid grid-2">
                        <div class="form-group"><label>Masse totale (g) *</label><input type="number" class="form-control" id="f_total_mass" placeholder="200" step="0.1" required oninput="recalculate()"></div>
                        <div class="form-group"><label>Parfum ‚Äî % *</label>
                            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                                <input type="number" class="form-control" id="f_fragrance_pct" placeholder="10" step="0.1" min="0" max="15" oninput="recalculate()" style="width:80px;flex:none;">
                                <input type="text" class="form-control" id="f_fragrance_name" placeholder="Nom du parfum" style="flex:1;min-width:150px;">
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-2">
                        <div class="form-group"><label>R√©f√©rence parfum</label><input type="text" class="form-control" id="f_fragrance_ref" placeholder="Ex: DR-30364971"></div>
                        <div class="form-group"><label>Fournisseur parfum</label><input type="text" class="form-control" id="f_fragrance_supplier" placeholder="Ex: Givaudan"></div>
                    </div>

                    <!-- Zone import coupl√© : FDS + Excel -->
                    <div style="margin-bottom:1rem;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.8rem;">
                            <!-- Zone FDS -->
                            <div id="form-fds-drop" style="border:2px dashed #d4a853; border-radius:10px; padding:0.8rem; text-align:center; cursor:pointer; background:#fdfbf6; transition:all 0.2s;"
                                 onclick="document.getElementById('form-fds-input').click()"
                                 ondragover="event.preventDefault(); this.style.background='#f5eedd'; this.style.borderColor='#b8942e';"
                                 ondragleave="this.style.background='#fdfbf6'; this.style.borderColor='#d4a853';"
                                 ondrop="event.preventDefault(); this.style.background='#fdfbf6'; this.style.borderColor='#d4a853'; handleFormFDS(event.dataTransfer.files[0]);">
                                <div id="form-fds-label" style="font-size:0.82rem; color:#999;">
                                    üìÑ FDS du parfum (.pdf)
                                </div>
                                <input type="file" id="form-fds-input" accept=".pdf" style="display:none" onchange="if(this.files[0]) handleFormFDS(this.files[0])">
                            </div>
                            <!-- Zone Excel -->
                            <div id="form-excel-drop" style="border:2px dashed #4a7c4b; border-radius:10px; padding:0.8rem; text-align:center; cursor:pointer; background:#f6fdf6; transition:all 0.2s;"
                                 onclick="document.getElementById('form-excel-input').click()"
                                 ondragover="event.preventDefault(); this.style.background='#e8f5e9'; this.style.borderColor='#2e7d32';"
                                 ondragleave="this.style.background='#f6fdf6'; this.style.borderColor='#4a7c4b';"
                                 ondrop="event.preventDefault(); this.style.background='#f6fdf6'; this.style.borderColor='#4a7c4b'; handleFormExcel(event.dataTransfer.files[0]);">
                                <div id="form-excel-label" style="font-size:0.82rem; color:#999;">
                                    üìä Fiche formule terrain (.xlsx)
                                </div>
                                <input type="file" id="form-excel-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="if(this.files[0]) handleFormExcel(this.files[0])">
                            </div>
                        </div>
                        <div id="form-fds-results" style="display:none; margin-top:0.5rem;"></div>
                        <div id="form-excel-results" style="display:none; margin-top:0.5rem;"></div>
                        <div id="import-coupled-bar" style="display:none; margin-top:0.8rem; padding:0.8rem; background:linear-gradient(135deg, #e8f5e9, #fff3e0); border-radius:10px; text-align:center;">
                            <button onclick="importCoupled()" id="btnImportCoupled" style="background:linear-gradient(135deg, #2e7d32, #e65100); color:#fff; border:none; padding:0.7rem 2rem; border-radius:8px; cursor:pointer; font-size:0.95rem; font-weight:700; letter-spacing:0.5px;">
                                üîó Enregistrer la fiche compl√®te
                            </button>
                            <div style="font-size:0.72rem; color:#666; margin-top:0.3rem;">
                                Cr√©e le client + la formulation + lie cires, m√®che et parfum automatiquement
                            </div>
                            <div id="import-coupled-result" style="display:none; margin-top:0.5rem; font-size:0.82rem;"></div>
                        </div>
                    </div>

                    <!-- R√©sultat calculs auto -->
                    <div id="calc-results" style="display:none;">
                        <div class="grid grid-4" style="gap:0.75rem; margin-bottom:1rem;">
                            <div style="background:var(--fond-surface); padding:0.75rem; border-radius:var(--radius); text-align:center; border:1px solid var(--bordure-legere);">
                                <p style="font-size:0.65rem; text-transform:uppercase; color:var(--texte-muted); letter-spacing:0.8px;">Masse parfum</p>
                                <p id="calc_fragrance" style="font-size:1.2rem; font-weight:700; color:var(--mfc-cire);">‚Äî</p>
                            </div>
                            <div style="background:var(--fond-surface); padding:0.75rem; border-radius:var(--radius); text-align:center; border:1px solid var(--bordure-legere);">
                                <p style="font-size:0.65rem; text-transform:uppercase; color:var(--texte-muted); letter-spacing:0.8px;">Masse cire</p>
                                <p id="calc_wax" style="font-size:1.2rem; font-weight:700; color:var(--texte);">‚Äî</p>
                            </div>
                            <div style="background:var(--fond-surface); padding:0.75rem; border-radius:var(--radius); text-align:center; border:1px solid var(--bordure-legere);">
                                <p style="font-size:0.65rem; text-transform:uppercase; color:var(--texte-muted); letter-spacing:0.8px;">Colorant(s)</p>
                                <p id="calc_colorant" style="font-size:1.2rem; font-weight:700; color:var(--texte);">‚Äî</p>
                            </div>
                            <div style="background:var(--fond-surface); padding:0.75rem; border-radius:var(--radius); text-align:center; border:1px solid var(--bordure-legere);">
                                <p style="font-size:0.65rem; text-transform:uppercase; color:var(--texte-muted); letter-spacing:0.8px;">V√©rification</p>
                                <p id="calc_check" style="font-size:1.2rem; font-weight:700;">‚Äî</p>
                            </div>
                        </div>
                    </div>

                    <!-- Composition des cires -->
                    <div class="form-section">Composition des cires</div>
                    <div id="wax-composition">
                        <div id="wax-list"></div>
                        <div class="grid grid-3" style="gap:0.5rem; align-items:end;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label style="font-size:0.72rem;">Cire</label>
                                <select class="form-control" id="add_wax_id">
                                    <option value="">‚Äî Ajouter une cire ‚Äî</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label style="font-size:0.72rem;">Pourcentage (%)</label>
                                <input type="number" class="form-control" id="add_wax_pct" placeholder="100" step="0.1" min="0" max="100" onkeydown="if(event.key==='Enter'){event.preventDefault();addWaxToComposition();}">
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm" type="button" onclick="addWaxToComposition()">+ Ajouter</button>
                            </div>
                        </div>
                        <div id="wax-total-bar" style="display:none; margin-top:0.5rem;">
                            <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:0.5rem 0.75rem; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-size:0.78rem;">Total cires:</span>
                                <strong id="wax-total-pct" style="font-size:1rem;">0%</strong>
                                <span id="wax-total-mass" class="text-muted" style="font-size:0.82rem;"></span>
                            </div>
                        </div>
                    </div>

                    <!-- M√®che -->
                    <div class="form-section">M√®che</div>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>S√©rie de m√®che</label>
                            <select class="form-control" id="f_wick_series" onchange="filterWicks()">
                                <option value="">‚Äî Toutes les s√©ries ‚Äî</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>R√©f√©rence m√®che</label>
                            <select class="form-control" id="f_wick_id">
                                <option value="">‚Äî S√©lectionner ‚Äî</option>
                            </select>
                        </div>
                    </div>
                    <div id="wick-info" style="display:none;">
                        <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:0.6rem 0.75rem; margin-bottom:0.75rem; font-size:0.82rem;">
                            <span id="wick-detail"></span>
                        </div>
                    </div>

                    <!-- Couleur -->
                    <div class="form-section">Couleur</div>
                    <div class="grid grid-3">
                        <div class="form-group pantone-picker-container">
                            <label>Recherche Pantone</label>
                            <input type="text" class="form-control" id="pantone_search" placeholder="Code ou num√©ro..." autocomplete="off" oninput="searchPantone(this.value)" onfocus="searchPantone(this.value)">
                            <div class="pantone-search-results" id="pantone-results"></div>
                        </div>
                        <div class="form-group"><label>Code Pantone</label><input type="text" class="form-control" id="f_pantone_code" readonly></div>
                        <div class="form-group">
                            <label>Hex</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="f_pantone_hex" placeholder="#000000">
                                <input type="color" id="f_color_picker" value="#000000" style="width:42px; height:36px; padding:0; border:1px solid var(--bordure); border-radius:var(--radius-sm); cursor:pointer;" oninput="document.getElementById('f_pantone_hex').value=this.value; document.getElementById('f_color_bar').style.background=this.value;">
                            </div>
                        </div>
                    </div>
                    <div id="f_color_bar" style="height:24px; border-radius:var(--radius-sm); border:1px solid var(--bordure); margin-bottom:0.75rem;"></div>

                    <!-- Temp√©ratures process -->
                    <div class="form-section">üå°Ô∏è Temp√©ratures</div>
                    <div class="grid grid-3">
                        <div class="form-group"><label>Fonte (¬∞C)</label><input type="number" class="form-control" id="f_temp_fusion" placeholder="82" min="40" max="120"></div>
                        <div class="form-group"><label>Ajout parfum (¬∞C)</label><input type="number" class="form-control" id="f_temp_ajout_parfum" placeholder="65" min="40" max="100"></div>
                        <div class="form-group"><label>Coulage (¬∞C)</label><input type="number" class="form-control" id="f_temp_coulage" placeholder="70" min="35" max="90"></div>
                    </div>
                    <div class="form-group"><label>Notes process</label><input type="text" class="form-control" id="f_temp_notes" placeholder="Ex: Laisser reposer 5min avant coulage, refroidissement lent..."></div>

                    <!-- Notes -->
                    <div class="form-section">Notes</div>
                    <div class="form-group"><textarea class="form-control" id="f_notes" rows="2" placeholder="Notes sur la formulation..."></textarea></div>
                    <div id="change-reason-block" style="display:none;margin-top:0.5rem;padding:0.7rem;background:#fff8e1;border-left:3px solid #f9a825;border-radius:4px;">
                        <div class="form-section" style="color:#f57f17;">üìã Pourquoi cette modification ?</div>
                        <div class="form-group" style="margin-bottom:0.3rem;"><textarea class="form-control" id="f_change_reason" rows="2" placeholder="Ex: Tunnel 8mm apr√®s C2, √ò80mm n√©cessite plus de capillarit√© ‚Üí passage LX14‚ÜíLX18" style="border-color:#f9a825;"></textarea></div>
                        <div style="font-size:0.68rem;color:#795548;">Ce savoir-faire sera enregistr√© dans la base de connaissances MFC</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="goToFormulateur()" style="background:#d4a853;color:#fff;margin-right:auto;" title="Ouvrir l'assistant IA pour une proposition de formulation">üß™ Assistant Formulateur</button>
                <button class="btn btn-secondary" onclick="closeFormModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveFormulation()">üíæ Enregistrer</button>
                <button class="btn btn-success" id="btn-to-test" onclick="saveAndGoTest()" style="display:none;">‚Üí Cr√©er un test</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL D√âTAIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal" style="max-width:860px;">
            <div class="modal-header"><h2 id="detail-title">Formulation</h2><button class="modal-close" onclick="closeDetailModal()">&times;</button></div>
            <div class="modal-body" id="detail-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailModal()">Fermer</button>
                <button class="btn btn-primary" id="btn-detail-edit">‚úé Modifier</button>
                <button class="btn" id="btn-detail-validate" onclick="validateFormulation()" style="background:#27ae60;color:#fff;display:none;">‚úÖ Valider ‚Üí Recette</button>
                <button class="btn" id="btn-detail-print" onclick="printFormSheet()" style="background:var(--mfc-cire);color:#fff;">üñ®Ô∏è Fiche labo</button>
                <a class="btn btn-success" id="btn-detail-test" href="#">‚Üí Lancer un test</a>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL CR√âATION PARFUM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="frag-create-modal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header"><h2>Nouveau parfum</h2><button class="modal-close" onclick="closeFormFragranceModal()">&times;</button></div>
            <div class="modal-body">
                <form id="frag-create-form">
                    <div class="form-section">Identification</div>
                    <div class="grid grid-2">
                        <div class="form-group"><label>Nom *</label><input type="text" class="form-control" id="fc_name" required placeholder="Ex: Rose de Mai"></div>
                        <div class="form-group"><label>R√©f√©rence</label><input type="text" class="form-control" id="fc_reference" placeholder="Ex: GF-ROS-002"></div>
                    </div>
                    <div class="grid grid-2">
                        <div class="form-group"><label>Fournisseur *</label>
                            <div class="input-group">
                                <select class="form-control" id="fc_supplier_id" required><option value="">‚Äî</option></select>
                                <button class="btn btn-primary btn-sm" type="button" onclick="toggleNewSupplierF()" title="Nouveau fournisseur">+</button>
                            </div>
                        </div>
                        <div class="form-group"><label>Famille olfactive</label>
                            <select class="form-control" id="fc_family"><option value="">‚Äî</option>
                                <option>Florale</option><option>Bois√©e</option><option>Ambr√©e</option>
                                <option>Hesp√©rid√©e</option><option>Orientale</option><option>Gourmande</option>
                                <option>Aromatique</option><option>Verte</option><option>Foug√®re</option>
                                <option>Chypr√©e</option><option>Cuir√©e</option><option>Marine</option>
                                <option>Musqu√©e</option><option>Fruit√©e</option></select></div>
                    </div>
                    <div id="fc-new-supplier" style="display:none;">
                        <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:0.75rem; margin-bottom:0.75rem;">
                            <p style="font-size:0.68rem; text-transform:uppercase; letter-spacing:1px; color:var(--mfc-cire); font-weight:600; margin-bottom:0.5rem;">Nouveau fournisseur</p>
                            <div class="grid grid-3" style="gap:0.5rem;">
                                <div class="form-group"><label>Nom *</label><input type="text" class="form-control" id="fc_sup_name" placeholder="Ex: Givaudan"></div>
                                <div class="form-group"><label>Pays</label><input type="text" class="form-control" id="fc_sup_country" placeholder="Ex: Suisse"></div>
                                <div class="form-group"><label>Site web</label><input type="text" class="form-control" id="fc_sup_website" placeholder="https://..."></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">Sp√©cifications techniques</div>
                    <div class="grid grid-3">
                        <div class="form-group"><label>IFRA max (%)</label><input type="number" class="form-control" id="fc_ifra" step="0.1"></div>
                        <div class="form-group"><label>Point √©clair (¬∞C)</label><input type="number" class="form-control" id="fc_flash" step="1"></div>
                        <div class="form-group"><label>% recommand√©</label><input type="number" class="form-control" id="fc_pct" step="0.1"></div>
                    </div>
                    <div class="form-group"><label>Notes</label><textarea class="form-control" id="fc_notes" rows="2" placeholder="Comportement en combustion, compatibilit√©s..."></textarea></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFormFragranceModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveFormFragrance()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <script src="js/pantone-db.js"></script>
    <script>
        let formulations=[], samples=[], wicks=[], allWicks=[], allFragrances=[], allSuppliers=[], allWaxes=[], tempWaxComposition=[];

        function toast(m,t='success'){const c=document.getElementById('toast-container'),d=document.createElement('div');d.className=`toast toast-${t}`;d.textContent=m;c.appendChild(d);setTimeout(()=>d.remove(),3500);}

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadAllWaxes(){
            try{const r=await fetch('/api/waxes');allWaxes=await r.json();
                const s=document.getElementById('add_wax_id');
                s.innerHTML='<option value="">‚Äî Ajouter une cire ‚Äî</option>';
                // Group by category
                const cats={};
                allWaxes.forEach(w=>{const cat=w.category||w.sub_type||'Autre';if(!cats[cat])cats[cat]=[];cats[cat].push(w);});
                Object.keys(cats).sort().forEach(cat=>{
                    const og=document.createElement('optgroup');og.label=cat;
                    cats[cat].forEach(w=>{
                        const o=document.createElement('option');o.value=w.id;
                        const av=(w.available===null||w.available===undefined)?1:w.available;
                        o.textContent=(av===0?'‚äò ':'‚úì ')+w.reference+' ‚Äî '+(w.congealing_point_min?w.congealing_point_min+'-'+w.congealing_point_max+'¬∞C':'')+(w.supplier_name?' ('+w.supplier_name+')':'');
                        if(av===0)o.style.color='#999';
                        o.dataset.ref=w.reference;o.dataset.name=w.name;
                        og.appendChild(o);
                    });
                    s.appendChild(og);
                });
            }catch(e){}
        }

        function addWaxToComposition(){
            const waxId=parseInt(document.getElementById('add_wax_id').value);
            const pct=parseFloat(document.getElementById('add_wax_pct').value);
            if(!waxId||!pct){toast('Cire et pourcentage obligatoires','error');return;}
            if(tempWaxComposition.find(w=>w.wax_id===waxId)){toast('Cette cire est d√©j√† dans la composition','error');return;}
            const fragPct=parseFloat(document.getElementById('f_fragrance_pct').value)||0;
            const maxWaxPct=100-fragPct;
            const totalPct=tempWaxComposition.reduce((s,w)=>s+w.percentage,0)+pct;
            if(totalPct>maxWaxPct+0.1){toast('Total cires ('+totalPct.toFixed(1)+'%) d√©passe '+maxWaxPct.toFixed(1)+'% (100% ‚àí '+fragPct+'% parfum)','error');return;}
            const wax=allWaxes.find(w=>w.id===waxId);
            tempWaxComposition.push({wax_id:waxId,percentage:pct,reference:wax?wax.reference:'?',name:wax?wax.name:'?',supplier:wax?wax.supplier_name:'?',category:wax?wax.category||wax.sub_type:''});
            document.getElementById('add_wax_id').value='';
            document.getElementById('add_wax_pct').value='';
            renderWaxComposition();
        }

        function removeWaxFromComposition(idx){
            tempWaxComposition.splice(idx,1);
            renderWaxComposition();
        }

        function renderWaxComposition(){
            const list=document.getElementById('wax-list');
            const totalBar=document.getElementById('wax-total-bar');
            if(!tempWaxComposition.length){list.innerHTML='';totalBar.style.display='none';return;}
            totalBar.style.display='block';
            const totalMass=parseFloat(document.getElementById('f_total_mass').value)||0;
            const fragPct=parseFloat(document.getElementById('f_fragrance_pct').value)||0;
            const xl = window._excelFormulation;
            const colPct = (xl && xl.colorants) ? xl.colorants.reduce((s,c)=>s+(c.percentage||0),0) : 0;
            const actualWaxMass=totalMass*(1-fragPct/100-colPct/100);
            list.innerHTML='<div class="table-container" style="margin-bottom:0.5rem;"><table style="font-size:0.82rem;"><thead><tr><th>Cire</th><th>Fournisseur</th><th>Cat√©gorie</th><th>%</th><th>Masse (g)</th><th></th></tr></thead><tbody>'+
                tempWaxComposition.map((w,i)=>{
                    const mass=actualWaxMass>0?(actualWaxMass*w.percentage/100).toFixed(1):'‚Äî';
                    return `<tr><td><strong style="color:var(--mfc-cire);">${w.reference}</strong></td><td>${w.supplier||'‚Äî'}</td><td>${w.category||'‚Äî'}</td><td><strong>${w.percentage}%</strong></td><td>${mass}g</td><td><button class="btn btn-danger btn-sm" onclick="removeWaxFromComposition(${i})" style="padding:0.15rem 0.4rem;">‚úï</button></td></tr>`;
                }).join('')+'</tbody></table></div>';
            const totalPct=tempWaxComposition.reduce((s,w)=>s+w.percentage,0);
            const pctEl=document.getElementById('wax-total-pct');
            const expectedWaxPct=100-fragPct-colPct;
            pctEl.textContent=totalPct.toFixed(1)+'%';
            pctEl.style.color=Math.abs(totalPct-expectedWaxPct)<0.1?'var(--vert)':'var(--rouge)';
            document.getElementById('wax-total-mass').textContent=actualWaxMass>0?'= '+actualWaxMass.toFixed(1)+'g de cire ('+expectedWaxPct.toFixed(1)+'%)' + (colPct > 0 ? ' + colorant '+colPct+'%' : ''):'';
            // Mettre √† jour le placeholder avec le % restant
            const remainingPct=expectedWaxPct-totalPct;
            const pctInput=document.getElementById('add_wax_pct');
            if(pctInput)pctInput.placeholder=remainingPct>0?remainingPct.toFixed(1):'0';
        }
        async function loadAllFragrances(){
            try{const r=await fetch('/api/fragrances');allFragrances=await r.json();
                const s=document.getElementById('f_fragrance_id');
                s.innerHTML='<option value="">‚Äî Saisie libre ou s√©lection ‚Äî</option>';
                allFragrances.forEach(f=>{const o=document.createElement('option');o.value=f.id;
                    const av=(f.available===null||f.available===undefined)?1:f.available;
                    o.textContent=(av===0?'‚äò ':'‚úì ')+f.name+(f.reference?' ['+f.reference+']':'')+(f.supplier_name?' ‚Äî '+f.supplier_name:'')+(f.recommended_percentage?' ('+f.recommended_percentage+'%)':'');
                    if(av===0)o.style.color='#999';
                    s.appendChild(o);});
            }catch(e){}
        }

        function onFormFragranceSelect(){
            const fid=document.getElementById('f_fragrance_id').value;
            const div=document.getElementById('f-fragrance-info');
            if(!fid){div.style.display='none';return;}
            const f=allFragrances.find(x=>x.id==fid);
            if(!f){div.style.display='none';return;}
            document.getElementById('f_fragrance_name').value=f.name;
            if(f.recommended_percentage&&!document.getElementById('f_fragrance_pct').value){document.getElementById('f_fragrance_pct').value=f.recommended_percentage;recalculate();}
            div.style.display='block';
            let info='<strong style="color:var(--mfc-cire);">'+f.name+'</strong>';
            if(f.reference)info+=' ‚Äî R√©f: '+f.reference;
            if(f.supplier_name)info+=' | Fournisseur: '+f.supplier_name;
            if(f.family)info+=' | Famille: '+f.family;
            if(f.ifra_max)info+=' | IFRA max: '+f.ifra_max+'%';
            if(f.flash_point){
                const fpColor=f.flash_point<55?'#c62828':f.flash_point<70?'#e65100':'#2e7d32';
                const fpIco=f.flash_point<55?'üî¥':f.flash_point<70?'üü°':'üü¢';
                info+=' | '+fpIco+' Flash: <strong style="color:'+fpColor+';">'+f.flash_point+'¬∞C</strong>';
                if(f.flash_point<70){
                    const tMax=f.flash_point<55?Math.max(f.flash_point-15,35):f.flash_point-10;
                    info+=' <span style="background:#ffebee;padding:1px 5px;border-radius:4px;font-size:0.72rem;">T¬∞ max ajout: '+tMax+'¬∞C</span>';
                }
            }
            document.getElementById('f-fragrance-detail').innerHTML=info;
        }

        async function loadAllSuppliers(){
            try{const r=await fetch('/api/suppliers');allSuppliers=await r.json();
                const s=document.getElementById('fc_supplier_id');
                s.innerHTML='<option value="">‚Äî</option>';
                allSuppliers.filter(x=>x.specialty&&(x.specialty.toLowerCase().includes('parfum')||x.specialty.toLowerCase().includes('ar√¥me')||x.specialty.toLowerCase().includes('composition'))).forEach(sup=>{const o=document.createElement('option');o.value=sup.id;o.textContent=sup.name+' ('+sup.country+')';s.appendChild(o);});
                const others=allSuppliers.filter(x=>!x.specialty||(!x.specialty.toLowerCase().includes('parfum')&&!x.specialty.toLowerCase().includes('ar√¥me')&&!x.specialty.toLowerCase().includes('composition')));
                if(others.length){const og=document.createElement('optgroup');og.label='Autres';others.forEach(sup=>{const o=document.createElement('option');o.value=sup.id;o.textContent=sup.name;og.appendChild(o);});s.appendChild(og);}
            }catch(e){}
        }

        function openFormFragranceModal(){document.getElementById('frag-create-form').reset();document.getElementById('fc-new-supplier').style.display='none';document.getElementById('frag-create-modal').classList.add('active');}
        function closeFormFragranceModal(){document.getElementById('frag-create-modal').classList.remove('active');}

        function toggleNewSupplierF(){
            const div=document.getElementById('fc-new-supplier');
            div.style.display=div.style.display==='none'?'block':'none';
            if(div.style.display==='block'){document.getElementById('fc_supplier_id').value='';document.getElementById('fc_sup_name').focus();}
        }

        async function saveFormFragrance(){
            const name=document.getElementById('fc_name').value.trim();
            let sid=document.getElementById('fc_supplier_id').value;
            if(!name){toast('Nom obligatoire','error');return;}

            // Create supplier inline if needed
            const newSupDiv=document.getElementById('fc-new-supplier');
            if(newSupDiv.style.display!=='none'){
                const supName=document.getElementById('fc_sup_name').value.trim();
                if(!supName){toast('Nom du fournisseur obligatoire','error');return;}
                const supR=await fetch('/api/suppliers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:supName,country:document.getElementById('fc_sup_country').value,specialty:'Parfums et ar√¥mes',website:document.getElementById('fc_sup_website').value})});
                const supRes=await supR.json();
                if(supRes.error){toast(supRes.error,'error');return;}
                sid=supRes.id;
                toast('Fournisseur "'+supName+'" cr√©√©');
                await loadAllSuppliers();
            }

            if(!sid){toast('Fournisseur obligatoire','error');return;}

            const data={name,reference:document.getElementById('fc_reference').value,supplier_id:parseInt(sid),family:document.getElementById('fc_family').value,ifra_max:parseFloat(document.getElementById('fc_ifra').value)||null,flash_point:parseFloat(document.getElementById('fc_flash').value)||null,recommended_percentage:parseFloat(document.getElementById('fc_pct').value)||null,notes:document.getElementById('fc_notes').value};
            const r=await fetch('/api/fragrances',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
            const res=await r.json();
            if(res.error){toast(res.error,'error');return;}
            closeFormFragranceModal();toast('Parfum "'+name+'" cr√©√©');
            await loadAllFragrances();
            document.getElementById('f_fragrance_id').value=res.id;
            onFormFragranceSelect();
        }
        async function loadSamples(){const r=await fetch('/api/samples');samples=await r.json();const s=document.getElementById('sample_id');s.innerHTML='<option value="">‚Äî S√©lectionner un √©chantillon ‚Äî</option>';samples.forEach(x=>{const o=document.createElement('option');o.value=x.id;o.textContent=`${x.sample_number} ‚Äî ${x.client_name||'Sans client'} (${x.total_mass||'?'}g)`;s.appendChild(o);});}

        async function loadWicks(){const r=await fetch('/api/wicks');allWicks=await r.json();
            // S√©ries uniques
            const series=new Set(); allWicks.forEach(w=>{if(w.series)series.add(w.series);});
            const sel=document.getElementById('f_wick_series');
            sel.innerHTML='<option value="">‚Äî Toutes les s√©ries ‚Äî</option>';
            [...series].sort().forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o);});
            filterWicks();
        }

        function filterWicks(){
            const series=document.getElementById('f_wick_series').value;
            wicks=series?allWicks.filter(w=>w.series===series):allWicks;
            const sel=document.getElementById('f_wick_id');
            const cur=sel.value;
            sel.innerHTML='<option value="">‚Äî S√©lectionner ‚Äî</option>';
            wicks.forEach(w=>{const o=document.createElement('option');o.value=w.id;o.textContent=`${w.reference} ‚Äî ${w.series||''} (√ò ${w.diameter_min||'?'}-${w.diameter_max||'?'}mm)${w.meters_per_kg?' ‚Äî '+Math.round(w.meters_per_kg)+' m/kg':''}`;o.dataset.ref=w.reference;sel.appendChild(o);});
            if(cur)sel.value=cur;
            sel.onchange=function(){showWickInfo(this.value);};
        }

        function showWickInfo(wickId){
            const div=document.getElementById('wick-info');
            if(!wickId){div.style.display='none';return;}
            const w=allWicks.find(x=>x.id==wickId);
            if(!w){div.style.display='none';return;}
            div.style.display='block';
            let details=`<strong style="color:var(--mfc-cire);">${w.reference}</strong> ‚Äî S√©rie ${w.series||'?'} | `;
            details+=`Diam√®tre: ${w.diameter_min||'?'}‚Äì${w.diameter_max||'?'} mm`;
            if(w.meters_per_kg) details+=` | <strong>${Math.round(w.meters_per_kg)} m/kg</strong> (${(1000/w.meters_per_kg).toFixed(2)} g/m)`;
            if(w.chemical_treatment&&w.chemical_treatment!=='Aucun') details+=` | Traitement: ${w.chemical_treatment}`;
            if(w.recommended_container_mm) details+=` | Container √ò${w.recommended_container_mm} mm`;
            if(w.self_trimming) details+=` | Auto-rognage ‚úì`;
            if(w.type) details+=`<br><span class="text-muted">${w.type}${w.core&&w.core!=='Sans'?' ‚Äî noyau '+w.core:''}${w.wax_type?' ‚Äî '+w.wax_type:''}${w.application?' ‚Äî '+w.application:''}</span>`;
            if(w.manufacturer_notes) details+=`<br><span class="text-muted" style="font-size:0.75rem;">${w.manufacturer_notes}</span>`;
            document.getElementById('wick-detail').innerHTML=details;
        }

        async function loadFormulations(){
            const st=document.getElementById('filter-status').value;
            let url='/api/formulations';if(st)url+='?status='+encodeURIComponent(st);
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 15000);
                const r=await fetch(url, { signal: controller.signal });
                clearTimeout(timeout);
                if (!r.ok) throw new Error('HTTP ' + r.status);
                formulations=await r.json();
                renderFormulations();
            } catch(e) {
                if (e.name === 'AbortError') {
                    document.getElementById('formulations-table').innerHTML = '<tr><td colspan="11"><div class="empty-state"><div class="icon">‚è≥</div><p>Timeout ‚Äî le serveur met trop de temps</p><button class="btn btn-primary" onclick="loadFormulations()">R√©essayer</button></div></td></tr>';
                } else throw e;
            }
        }

        function renderFormulations(){
            const tb=document.getElementById('formulations-table');
            const q=(document.getElementById('search-input').value||'').toLowerCase();
            let f=formulations;
            if(q)f=f.filter(x=>(x.code||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q)||(x.client_name||'').toLowerCase().includes(q)||(x.sample_number||'').toLowerCase().includes(q));
            if(!f.length){tb.innerHTML='<tr><td colspan="11"><div class="empty-state"><div class="icon">üß™</div><p>Aucune formulation</p><button class="btn btn-primary" onclick="openFormModal()">Cr√©er la premi√®re</button></div></td></tr>';return;}
            tb.innerHTML=f.map(x=>{
                const waxM = x.wax_mass || (x.total_mass && x.fragrance_percentage ? x.total_mass * (1 - x.fragrance_percentage/100 - (x.colorant_total_percentage||0)/100) : 0);
                return `
                <tr onclick="viewDetail(${x.id})" style="cursor:pointer;">
                    <td><strong style="color:var(--mfc-cire);">${x.code}</strong></td>
                    <td>${x.sample_number||'‚Äî'}</td>
                    <td>${x.client_name||'‚Äî'}</td>
                    <td>${x.name}</td>
                    <td><strong>${x.total_mass}g</strong></td>
                    <td>${x.fragrance_name||'‚Äî'} ${x.fragrance_ref?'<span class="text-muted">['+x.fragrance_ref+']</span>':''} ${x.fragrance_percentage?'<span class="text-muted">('+x.fragrance_percentage+'%)</span>':''}</td>
                    <td>${waxM>0?waxM.toFixed(1)+'g':'‚Äî'}</td>
                    <td>${x.wick_reference||'‚Äî'}</td>
                    <td>${x.pantone_hex?'<span class="color-preview" style="background:'+x.pantone_hex+'"></span>':''}${x.pantone_code||'‚Äî'}</td>
                    <td><span class="badge badge-${x.status}">${x.status}</span></td>
                    <td class="actions" onclick="event.stopPropagation()">
                        <button class="btn btn-sm" onclick="window.open('/print.html?type=formulation&id='+${x.id},'_blank')" style="background:#666;color:#fff;" title="Imprimer fiche formulation">üñ®Ô∏è</button>
                        <button class="btn btn-secondary btn-sm" onclick="editFormulation(${x.id})" title="Modifier">‚úé</button>
                        <button class="btn btn-sm" onclick="launchTest(${x.id})" style="background:var(--mfc-cire);color:#fff;" title="Lancer un test de combustion">üî• Test</button>
                        <button class="btn btn-sm" onclick="window.open('/print.html?type=test-vierge&id='+${x.id},'_blank')" style="background:#3498db;color:#fff;" title="Imprimer fiche test vierge">üìã Test</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFormulation(${x.id})" title="Supprimer">‚úï</button>
                    </td>
                </tr>`;
            }).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAMPLE INHERITANCE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function onSampleSelect(){
            const sid=document.getElementById('sample_id').value;
            const div=document.getElementById('sample-inherited');
            if(!sid){div.style.display='none';return;}
            const s=samples.find(x=>x.id==sid);
            if(!s){div.style.display='none';return;}
            div.style.display='block';
            document.getElementById('inh_client').textContent=s.client_name||'‚Äî';
            document.getElementById('inh_type').textContent=s.candle_type||'‚Äî';
            document.getElementById('inh_dims').textContent=(s.diameter&&s.height)?s.diameter+'√ó'+s.height+'mm':'‚Äî';
            document.getElementById('inh_request').textContent=s.client_request||'‚Äî';
            // Auto-fill fields
            if(s.total_mass&&!document.getElementById('f_total_mass').value)document.getElementById('f_total_mass').value=s.total_mass;
            if(s.candle_type)document.getElementById('f_container').value=s.candle_type;
            if(s.diameter)document.getElementById('f_diameter').value=s.diameter;
            if(s.height)document.getElementById('f_height').value=s.height;
            if(s.fragrance_name)document.getElementById('f_fragrance_name').value=s.fragrance_name;
            if(s.fragrance_ref)document.getElementById('f_fragrance_ref').value=s.fragrance_ref;
            if(s.fragrance_supplier)document.getElementById('f_fragrance_supplier').value=s.fragrance_supplier;
            if(s.fragrance_percentage&&!document.getElementById('f_fragrance_pct').value){document.getElementById('f_fragrance_pct').value=s.fragrance_percentage;document.getElementById('f_fragrance_pct').readOnly=true;document.getElementById('f_fragrance_pct').title='H√©rit√© de l\'√©chantillon ‚Äî non modifiable';document.getElementById('f_fragrance_pct').style.background='var(--fond-surface)';}
            if(s.fragrance_id){document.getElementById('f_fragrance_id').value=s.fragrance_id;onFormFragranceSelect();}
            if(s.pantone_code){document.getElementById('f_pantone_code').value=s.pantone_code;document.getElementById('pantone_search').value=s.pantone_code;}
            if(s.pantone_hex){document.getElementById('f_pantone_hex').value=s.pantone_hex;document.getElementById('f_color_picker').value=s.pantone_hex;document.getElementById('f_color_bar').style.background=s.pantone_hex;}
            if(!document.getElementById('f_name').value){
                document.getElementById('f_name').value=(s.fragrance_name||'Formulation')+(s.fragrance_ref?' ['+s.fragrance_ref+']':'');
            }
            // Auto-generate code from sample number: ECH-0206-001 ‚Üí ECH-0206-001-F1
            if(!document.getElementById('edit-id').value){
                generateFormCode(s.sample_number, s.id);
            }
            recalculate();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTO CALCULATIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function generateFormCode(sampleNumber, sampleId) {
            // Count existing formulations for this sample
            try {
                const r = await fetch('/api/samples/' + sampleId + '/formulations');
                const existing = await r.json();
                const num = (existing.length || 0) + 1;
                const code = sampleNumber + '-F' + num;
                document.getElementById('auto-code').textContent = code;
            } catch(e) {
                document.getElementById('auto-code').textContent = sampleNumber + '-F1';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FDS DROP IN FORMULATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function importCoupled() {
            const xl = window._excelFormulation;
            if (!xl) { alert('D√©posez d\'abord un fichier Excel de formulation.'); return; }
            
            const btn = document.getElementById('btnImportCoupled');
            const resultDiv = document.getElementById('import-coupled-result');
            btn.disabled = true;
            btn.textContent = '‚è≥ Import en cours...';
            
            // Get fragrance_id if FDS was parsed and fragrance auto-created
            const fragSelect = document.getElementById('f_fragrance_id');
            const fragranceId = fragSelect ? parseInt(fragSelect.value) || null : null;
            
            try {
                const res = await fetch('/api/formulations/import-coupled', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ formulation: xl, fragrance_id: fragranceId })
                });
                const data = await res.json();
                
                if (data.success) {
                    btn.textContent = '‚úÖ Fiche import√©e !';
                    btn.style.background = '#2e7d32';
                    
                    let html = '<div style="background:#fff;border-radius:6px;padding:0.6rem;text-align:left;">';
                    html += '<strong>‚úÖ Import r√©ussi</strong><br>';
                    
                    // Alertes mati√®res manquantes
                    if (data.alerts && data.alerts.length > 0) {
                        html += '<div style="background:#fff3e0;border:2px solid #e65100;border-radius:6px;padding:0.5rem;margin:0.5rem 0;">';
                        html += '<strong style="color:#e65100;">‚ö†Ô∏è ' + data.alerts.length + ' mati√®re(s) non trouv√©e(s) ‚Äî √† saisir manuellement :</strong><br>';
                        for (const a of data.alerts) {
                            const icon = a.type === 'cire' ? 'üïØÔ∏è' : a.type === 'm√®che' ? 'üî•' : 'üé®';
                            html += icon + ' <strong>' + a.type.toUpperCase() + '</strong> : ' + a.message;
                            if (a.percentage) html += ' (' + a.percentage + '%)';
                            html += '<br>';
                        }
                        html += '<div style="font-size:0.72rem;color:#e65100;margin-top:0.3rem;">‚Üí Allez dans <strong>Mati√®res premi√®res</strong> pour cr√©er ces r√©f√©rences, puis r√©-importez</div>';
                        html += '</div>';
                    }
                    
                    for (const l of (data.log || [])) {
                        const ico = l.startsWith('‚ö†') ? 'üü°' : 'üü¢';
                        html += ico + ' ' + l + '<br>';
                    }
                    html += '<div style="margin-top:0.4rem;">';
                    html += 'üë§ Client: <strong>' + (data.client_name || '‚Äî') + '</strong>';
                    html += ' ¬∑ üïØÔ∏è Cires: ' + data.wax_matches + ' match√©e(s)';
                    html += ' ¬∑ üé® Colorants: ' + (data.colorant_count || 0);
                    html += ' ¬∑ üî• M√®che: ' + (data.wick_matched ? '‚úÖ' : '‚ùå');
                    html += ' ¬∑ üå∏ Parfum: ' + (data.fragrance_linked ? '‚úÖ li√©' : '‚ö† non li√© ‚Äî d√©posez la FDS');
                    if (data.fragrance_ref) html += ' (r√©f: ' + data.fragrance_ref + ')';
                    if (data.recipe) {
                        html += '<br>üìã Recette: parfum ' + data.recipe.fragrance_pct + '% + cire ' + data.recipe.wax_pct + '% + colorants ' + data.recipe.colorant_pct + '%';
                    }
                    html += '</div></div>';
                    
                    resultDiv.innerHTML = html;
                    resultDiv.style.display = 'block';
                    
                    // Reload formulations list
                    setTimeout(() => loadFormulations(), 1500);
                    
                } else {
                    btn.textContent = '‚ùå Erreur';
                    resultDiv.innerHTML = '<div style="color:#c62828;">Erreur: ' + (data.error || 'inconnue') + '</div>';
                    resultDiv.style.display = 'block';
                }
            } catch(e) {
                btn.textContent = '‚ùå ' + e.message;
            }
            
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = 'üîó Enregistrer la fiche compl√®te';
                btn.style.background = 'linear-gradient(135deg, #2e7d32, #e65100)';
            }, 5000);
        }

        async function handleFormExcel(file) {
            if (!file) return;
            const ext = file.name.toLowerCase().split('.').pop();
            if (!['xlsx','xls','csv'].includes(ext)) { alert('Format non support√©. Utilisez .xlsx, .xls ou .csv'); return; }
            
            const label = document.getElementById('form-excel-label');
            label.innerHTML = '‚è≥ Lecture de <strong>' + file.name + '</strong>...';
            label.style.color = '#4a7c4b';
            
            const form = new FormData();
            form.append('excel', file);
            
            try {
                const res = await fetch('/api/formulations/parse-excel', { method: 'POST', body: form });
                const data = await res.json();
                
                if (data.success && data.formulation) {
                    const f = data.formulation;
                    const parts = [];
                    if (f.client) parts.push(f.client);
                    if (f.candle_name) parts.push(f.candle_name);
                    const cires = f.materials.filter(m => m.type === 'cire').map(m => m.reference || m.name);
                    if (cires.length) parts.push('Cire: ' + cires.join('+'));
                    if (f.wick) parts.push('M√®che: ' + f.wick.raw);
                    if (f.fragrance_pct) parts.push(f.fragrance_pct + '%');
                    if (f.fragrance_ref) parts.push('R√©f: ' + f.fragrance_ref);
                    if (f.colorants.length) parts.push(f.colorants.length + ' colorant(s)');
                    
                    label.innerHTML = '‚úÖ <strong>' + file.name + '</strong> ‚Äî ' + parts.join(' ¬∑ ');
                    label.style.color = '#27ae60';
                    
                    // Auto-fill formulation fields
                    if (f.fragrance_pct) {
                        document.getElementById('f_fragrance_pct').value = f.fragrance_pct;
                        recalculate();
                    }
                    if (f.candle_name) {
                        const nameField = document.getElementById('f_name');
                        if (nameField) nameField.value = f.candle_name;
                    }
                    if (f.fragrance_name && !document.getElementById('f_fragrance_name').value) {
                        document.getElementById('f_fragrance_name').value = f.fragrance_name;
                    }
                    if (f.fragrance_ref) {
                        const refField = document.getElementById('f_fragrance_ref');
                        if (refField && !refField.value) refField.value = f.fragrance_ref;
                    }
                    if (f.total_mass) {
                        const tmField = document.getElementById('f_total_mass');
                        if (tmField) tmField.value = f.total_mass;
                        recalculate();
                    }
                    
                    // Show structured preview
                    const resultsDiv = document.getElementById('form-excel-results');
                    let html = '<div style="background:#e8f5e9;border-radius:8px;padding:0.8rem;font-size:0.78rem;">';
                    html += '<strong>üìä Fiche MFC extraite :</strong><br>';
                    if (f.date) html += 'üìÖ Date : ' + f.date + '<br>';
                    if (f.client) html += 'üë§ Client : <strong>' + f.client + '</strong><br>';
                    if (f.candle_name) html += 'üïØÔ∏è Bougie : <strong>' + f.candle_name + '</strong><br>';
                    if (f.code_mfc) html += 'üè∑Ô∏è Code MFC : ' + f.code_mfc + ' | Lot : ' + (f.lot_mfc || '‚Äî') + '<br>';
                    if (f.container_ref) html += 'üì¶ Contenant : ' + f.container_ref + (f.container_mass ? ' (' + f.container_mass + 'g)' : '') + '<br>';
                    
                    // Materials table
                    html += '<table style="width:100%;font-size:0.75rem;border-collapse:collapse;margin-top:0.5rem;">';
                    html += '<tr style="background:#a5d6a7;"><th style="padding:3px 6px;text-align:left;">Mati√®re</th><th>R√©f</th><th>%</th><th>Masse</th><th>Type</th></tr>';
                    for (const m of f.materials) {
                        const typeIcon = m.type === 'parfum' ? 'üå∏' : m.type === 'cire' ? 'üïØÔ∏è' : 'üì¶';
                        html += '<tr><td style="border:1px solid #c8e6c9;padding:2px 6px;">' + (m.name||'‚Äî') + '</td>';
                        html += '<td style="border:1px solid #c8e6c9;padding:2px 6px;text-align:center;">' + (m.reference||'‚Äî') + '</td>';
                        html += '<td style="border:1px solid #c8e6c9;padding:2px 6px;text-align:center;">' + (m.percentage!=null?m.percentage+'%':'‚Äî') + '</td>';
                        html += '<td style="border:1px solid #c8e6c9;padding:2px 6px;text-align:center;">' + (m.mass!=null?m.mass+'g':'‚Äî') + '</td>';
                        html += '<td style="border:1px solid #c8e6c9;padding:2px 6px;text-align:center;">' + typeIcon + '</td></tr>';
                    }
                    // Colorants dans le m√™me tableau
                    for (const c of (f.colorants || [])) {
                        const form = (c.name||'').toLowerCase().includes('liquide') ? 'liquide' : (c.name||'').toLowerCase().includes('solide') ? 'solide' : '';
                        html += '<tr style="background:#fff8e1;"><td style="border:1px solid #c8e6c9;padding:2px 6px;">üé® ' + (c.name||'Colorant') + (form ? ' <em>('+form+')</em>' : '') + '</td>';
                        html += '<td style="border:1px solid #c8e6c9;padding:2px 6px;text-align:center;">' + (c.reference||'‚Äî') + '</td>';
                        html += '<td style="border:1px solid #c8e6c9;padding:2px 6px;text-align:center;">' + (c.percentage!=null?c.percentage+'%':'‚Äî') + '</td>';
                        html += '<td style="border:1px solid #c8e6c9;padding:2px 6px;text-align:center;">' + (c.mass!=null?c.mass+'g':'‚Äî') + '</td>';
                        html += '<td style="border:1px solid #c8e6c9;padding:2px 6px;text-align:center;">üé®</td></tr>';
                    }
                    if (f.total_mass) {
                        html += '<tr style="background:#c8e6c9;font-weight:bold;"><td colspan="3" style="padding:2px 6px;">TOTAL (masse cuve)</td>';
                        html += '<td style="padding:2px 6px;text-align:center;">' + f.total_mass + 'g</td><td></td></tr>';
                    }
                    html += '</table>';
                    
                    // Wick
                    if (f.wick) {
                        html += '<div style="margin-top:0.3rem;">üî• M√®che : <strong>' + f.wick.raw + '</strong>';
                        if (f.wick.series) html += ' (s√©rie ' + f.wick.series + ', taille ' + f.wick.size + ')';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                    
                    // Store for formulation creation
                    window._excelFormulation = f;
                    
                    // Recalculate with actual colorant data
                    recalculate();
                    
                    // Show import button
                    document.getElementById('import-coupled-bar').style.display = 'block';
                    
                } else {
                    label.innerHTML = '‚ùå Erreur : ' + (data.error || 'Lecture impossible');
                    label.style.color = '#c62828';
                }
            } catch(e) {
                label.innerHTML = '‚ùå ' + e.message;
                label.style.color = '#c62828';
            }
        }

        async function handleFormFDS(file) {
            if (!file || !file.name.toLowerCase().endsWith('.pdf')) return;
            const label = document.getElementById('form-fds-label');
            label.innerHTML = '‚è≥ Extraction de <strong>' + file.name + '</strong>...';
            label.style.color = '#d4a853';

            const form = new FormData();
            form.append('fds', file);
            const fname = document.getElementById('f_fragrance_name').value;
            if (fname) form.append('fragrance_name', fname);
            const ctype = document.getElementById('f_container').value;
            if (ctype) form.append('candle_type', ctype);

            try {
                const res = await fetch('/api/formulateur/parse-and-analyze', { method: 'POST', body: form });
                const data = await res.json();
                if (data.success && data.fds) {
                    const id = data.fds.identification || {};
                    const props = data.fds.proprietes_physiques || {};
                    const nb = data.fds.nb_composants || (data.fds.composition||[]).length || 0;
                    const fp = props.flash_point_c || '?';

                    label.innerHTML = '‚úÖ <strong>' + (id.nom || file.name) + '</strong> ‚Äî ' + nb + ' mol√©cules ¬∑ Flash ' + fp + '¬∞C';
                    label.style.color = '#27ae60';

                    // Auto-fill parfum
                    if (id.nom) document.getElementById('f_fragrance_name').value = id.nom;
                    if (id.code) document.getElementById('f_fragrance_ref').value = id.code;
                    if (id.fournisseur) document.getElementById('f_fragrance_supplier').value = id.fournisseur;
                    
                    // Auto-s√©lectionner le parfum dans le dropdown si cr√©√©/trouv√© en DB
                    if (data.fragrance_id) {
                        await loadAllFragrances();
                        document.getElementById('f_fragrance_id').value = data.fragrance_id;
                        onFormFragranceSelect();
                    }

                    // Show FDS details + full crossref
                    const resultsDiv = document.getElementById('form-fds-results');
                    let html = '<div style="background:#f5f0e8;border-radius:8px;padding:0.8rem;font-size:0.82rem;">';
                    html += '<strong>Donn√©es FDS extraites :</strong><br>';
                    if (id.nom) html += 'üå∏ Parfum : ' + id.nom + '<br>';
                    if (id.code) html += 'üè∑Ô∏è R√©f : ' + id.code + '<br>';
                    if (id.fournisseur) html += 'üè≠ Fournisseur : ' + id.fournisseur + '<br>';
                    if (fp !== '?') html += 'üî• Point √©clair : ' + fp + '¬∞C<br>';
                    html += '</div>';

                    // ‚ïê‚ïê‚ïê CROISEMENT FDS √ó FORMULATIONS ‚ïê‚ïê‚ïê
                    if (data.crossref) {
                        const cr = data.crossref;
                        html += '<div style="margin-top:0.6rem;">';

                        // Flash point safety
                        if (cr.flash_safety && cr.flash_safety.length) {
                            const fs = cr.flash_safety[0];
                            const bg = fs.severity==='danger'?'#ffebee':fs.severity==='warning'?'#fff8e1':'#e8f5e9';
                            const ico = fs.severity==='danger'?'üî¥':fs.severity==='warning'?'üü°':'üü¢';
                            html += '<div style="background:'+bg+';border-radius:8px;padding:0.5rem 0.7rem;margin-bottom:0.4rem;">';
                            html += '<strong>'+ico+' '+fs.message+'</strong><br><span style="font-size:0.75rem;">'+fs.detail+'</span>';
                            if (fs.temp_max_ajout) html += '<br><strong style="color:#c62828;">‚ö†Ô∏è T¬∞ max ajout parfum : '+fs.temp_max_ajout+'¬∞C</strong>';
                            html += '</div>';
                            // Mol√©cules responsables du flash bas
                            cr.flash_safety.slice(1).forEach(f=>{
                                html += '<div style="font-size:0.75rem;padding:0.2rem 0.7rem;color:#555;">‚Ü≥ '+f.message+'</div>';
                            });
                        }

                        // Alertes mol√©cules (DPG, lourdes, etc.)
                        if (cr.molecule_analysis && cr.molecule_analysis.length) {
                            html += '<div style="background:#fff3e0;border-radius:8px;padding:0.5rem 0.7rem;margin-top:0.4rem;">';
                            html += '<strong>üß™ Analyse mol√©culaire ('+cr.molecule_analysis.length+' mol√©cules √† surveiller)</strong>';
                            cr.molecule_analysis.forEach(m=>{
                                m.impact.forEach(imp=>{
                                    const ico = imp.severity==='danger'?'üî¥':imp.severity==='warning'?'üü†':'‚ÑπÔ∏è';
                                    html += '<div style="font-size:0.75rem;padding:0.2rem 0;border-bottom:1px dotted #e0d5c3;">';
                                    html += ico+' <strong>'+m.nom+'</strong> ('+m.concentration+'%) ‚Äî '+imp.message;
                                    html += '</div>';
                                });
                            });
                            html += '</div>';
                        }

                        // R√®gles apprises
                        if (cr.learned_insights && cr.learned_insights.length) {
                            html += '<div style="background:#e3f2fd;border-radius:8px;padding:0.5rem 0.7rem;margin-top:0.4rem;">';
                            html += '<strong>üß† Alertes & r√®gles</strong>';
                            cr.learned_insights.forEach(r=>{
                                const ico = r.severity==='danger'?'üî¥':r.severity==='warning'?'üü†':'‚ÑπÔ∏è';
                                html += '<div style="font-size:0.75rem;padding:0.2rem 0;">'+ico+' <strong>'+r.rule+'</strong> ‚Äî '+r.detail+'</div>';
                            });
                            html += '</div>';
                        }

                        // Matchs valid√©s (parfum d√©j√† produit)
                        if (cr.validated_matches && cr.validated_matches.length) {
                            html += '<div style="background:#e8f5e9;border-radius:8px;padding:0.5rem 0.7rem;margin-top:0.4rem;">';
                            html += '<strong>‚úÖ Parfum d√©j√† valid√© en production ('+cr.validated_matches.length+' formulation'+(cr.validated_matches.length>1?'s':'')+')</strong>';
                            cr.validated_matches.slice(0,5).forEach(v=>{
                                html += '<div style="font-size:0.75rem;padding:0.2rem 0;">‚Ä¢ <strong>'+v.parfum+'</strong> ‚Äî '+v.recette+' @ '+v.pct_parfum+'% ‚Äî '+v.client+' ('+v.contenant+', '+v.meche+')'+(v.notes?' <em>'+v.notes+'</em>':'')+'</div>';
                            });
                            if (cr.validated_matches.length > 5) html += '<div style="font-size:0.72rem;color:#555;">... et '+(cr.validated_matches.length-5)+' autre(s)</div>';
                            html += '</div>';
                        }

                        // Recommandation finale
                        if (cr.recommendation) {
                            const rc = cr.recommendation;
                            const confColor = rc.confidence==='haute'?'#2e7d32':rc.confidence==='moyenne'?'#e65100':'#555';
                            html += '<div style="background:linear-gradient(135deg,#fdf6e3,#f5efe0);border:2px solid var(--mfc-cire);border-radius:8px;padding:0.6rem 0.7rem;margin-top:0.5rem;">';
                            html += '<strong style="color:var(--mfc-cire);">üìã Recommandation : '+rc.recette+'</strong>';
                            html += '<br><span style="font-size:0.78rem;">'+rc.message+'</span>';
                            if (rc.pct_parfum) html += '<br>Parfum : <strong>'+rc.pct_parfum+'%</strong>';
                            if (rc.meche) html += ' ‚Äî M√®che : <strong>'+rc.meche+'</strong>';
                            html += '<br><span style="font-size:0.7rem;color:'+confColor+';">Confiance : '+rc.confidence+'</span>';
                            html += '</div>';
                        }

                        html += '</div>';
                    }

                    // ‚ïê‚ïê‚ïê PROFIL MOL√âCULAIRE ‚ïê‚ïê‚ïê
                    if (data.molecule_profile) {
                        const mp = data.molecule_profile;
                        const p = mp.profile;
                        html += '<div style="margin-top:0.6rem;background:linear-gradient(135deg,#f3e8ff,#ede7f6);border:2px solid #7c4dff;border-radius:8px;padding:0.7rem;">';
                        html += '<strong style="color:#7c4dff;">üß¨ Profil mol√©culaire</strong>';
                        
                        // Jauges visuelles
                        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem;margin-top:0.4rem;font-size:0.75rem;">';
                        const bar = (label, val, max, color) => {
                            const w = Math.min(100, (val/max)*100);
                            return '<div><span>'+label+'</span><div style="background:#e0d5f5;border-radius:3px;height:12px;margin-top:2px;"><div style="background:'+color+';height:100%;border-radius:3px;width:'+w+'%;min-width:2px;"></div></div><span style="font-size:0.68rem;">'+val.toFixed(1)+'%</span></div>';
                        };
                        html += bar('Tr√®s volatil', p.pct_tres_volatil, 50, '#e53935');
                        html += bar('Volatil', p.pct_volatil, 50, '#ff9800');
                        html += bar('Moyen', p.pct_moyen, 50, '#4caf50');
                        html += bar('Lourd/fixateur', p.pct_lourd + p.pct_fixateur, 50, '#5c6bc0');
                        html += bar('Terp√®nes', p.pct_terpenes, 60, '#26a69a');
                        html += bar('Sesquiterp√®nes', p.pct_sesquiterpenes, 30, '#009688');
                        html += bar('Alcools', p.pct_alcools, 40, '#42a5f5');
                        html += bar('Muscs', p.pct_muscs, 30, '#ab47bc');
                        html += '</div>';
                        
                        // Indices
                        const combColor = p.idx_combustion < -20 ? '#c62828' : p.idx_combustion < -5 ? '#e65100' : '#2e7d32';
                        const diffColor = p.idx_diffusion > 30 ? '#2e7d32' : p.idx_diffusion > 15 ? '#e65100' : '#c62828';
                        html += '<div style="display:flex;gap:1rem;margin-top:0.4rem;font-size:0.78rem;">';
                        html += '<span>üî• Combustion: <strong style="color:'+combColor+';">'+p.idx_combustion+'</strong></span>';
                        html += '<span>üå¨Ô∏è Diffusion: <strong style="color:'+diffColor+';">'+p.idx_diffusion+'</strong></span>';
                        html += '<span>‚öñÔ∏è PM moyen: <strong>'+Math.round(p.mw_weighted)+'</strong> g/mol</span>';
                        html += '<span>üìä '+p.nb_known+'/'+p.nb_total+' mol√©cules connues</span>';
                        html += '</div>';
                        
                        // R√®gles d√©clench√©es
                        if (mp.triggered_rules && mp.triggered_rules.length) {
                            html += '<div style="margin-top:0.4rem;border-top:1px solid #d1c4e9;padding-top:0.3rem;">';
                            mp.triggered_rules.forEach(r => {
                                const ico = r.severity==='bloquant'?'‚õî':r.severity==='securite'?'üî¥':r.severity==='important'?'üü†':r.severity==='warning'?'üü°':r.severity==='positif'?'üü¢':'‚ÑπÔ∏è';
                                html += '<div style="font-size:0.72rem;padding:0.15rem 0;">'+ico+' <strong>'+r.name+'</strong>';
                                if (r.recette) html += ' ‚Üí <span style="color:#7c4dff;">'+r.recette+'</span>';
                                html += '<br><span style="color:#555;">'+r.detail+'</span></div>';
                            });
                            html += '</div>';
                        }
                        
                        // Pr√©diction
                        if (mp.prediction) {
                            const pred = mp.prediction;
                            const confColor = pred.confidence==='haute'?'#2e7d32':'#e65100';
                            html += '<div style="margin-top:0.4rem;background:rgba(124,77,255,0.08);border-radius:6px;padding:0.4rem 0.5rem;">';
                            html += '<strong style="color:#7c4dff;">Pr√©diction : '+pred.recipe+'</strong>';
                            html += ' <span style="font-size:0.7rem;color:'+confColor+';">('+pred.confidence+')</span>';
                            if (pred.reasoning.length) html += '<br><span style="font-size:0.72rem;color:#555;">'+pred.reasoning.join(' | ')+'</span>';
                            if (pred.wick) html += '<br><span style="font-size:0.72rem;">M√®che : '+pred.wick.base+pred.wick.adjustment+'</span>';
                            html += '</div>';
                        }
                        
                        html += '</div>';
                    }
                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';

                    // Update nom formulation if empty
                    if (!document.getElementById('f_name').value) {
                        document.getElementById('f_name').value = (id.nom || 'Formulation') + (id.code ? ' [' + id.code + ']' : '');
                    }

                    recalculate();
                } else {
                    label.innerHTML = '‚ùå ' + (data.error || 'Erreur extraction');
                    label.style.color = '#c62828';
                }
            } catch (e) {
                label.innerHTML = '‚ùå Erreur : ' + e.message;
                label.style.color = '#c62828';
            }
        }

        function recalculate(){
            const total=parseFloat(document.getElementById('f_total_mass').value)||0;
            const pct=parseFloat(document.getElementById('f_fragrance_pct').value)||0;
            const div=document.getElementById('calc-results');
            if(!total){div.style.display='none';return;}
            div.style.display='block';
            
            // Use actual colorant data from Excel if available
            const xl = window._excelFormulation;
            let colPct = 0;
            let colDetail = '';
            if (xl && xl.colorants && xl.colorants.length > 0) {
                colPct = xl.colorants.reduce((s, c) => s + (c.percentage || 0), 0);
                colDetail = xl.colorants.map(c => (c.name || c.reference || '?') + ' ' + (c.percentage || '?') + '%').join(' + ');
            }
            
            const fragMass=total*(pct/100);
            const colMass=total*(colPct/100);
            const waxPct=100-pct-colPct;
            const waxMass=total-fragMass-colMass;
            document.getElementById('calc_fragrance').textContent=fragMass.toFixed(1)+'g ('+pct+'%)';
            document.getElementById('calc_wax').textContent=waxMass.toFixed(1)+'g ('+waxPct.toFixed(1)+'%)';
            if (colPct > 0) {
                document.getElementById('calc_colorant').textContent=colMass.toFixed(2)+'g ('+colPct+'%)';
            } else {
                document.getElementById('calc_colorant').textContent='‚Äî (d√©posez Excel)';
            }
            const checkEl=document.getElementById('calc_check');
            const totalPct = pct + waxPct + colPct;
            if(pct>100){checkEl.textContent='‚úó Parfum > 100%';checkEl.style.color='var(--rouge)';}
            else if(waxMass<0){checkEl.textContent='‚úó Plus de place pour la cire';checkEl.style.color='var(--rouge)';}
            else{
                let msg = '‚úì ' + pct + '% parfum + ' + waxPct.toFixed(1) + '% cire';
                if (colPct > 0) msg += ' + ' + colPct + '% colorant';
                msg += ' = ' + totalPct.toFixed(2) + '%';
                checkEl.textContent = msg;
                checkEl.style.color='var(--vert)';
            }
            renderWaxComposition();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANTONE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function searchPantone(query){
            const c=document.getElementById('pantone-results');
            if(!query||query.length<1){c.classList.remove('active');return;}
            const q=query.toLowerCase();
            const m=(typeof PANTONE_DB!=='undefined'?PANTONE_DB:[]).filter(p=>p.code.toLowerCase().includes(q)||p.hex.toLowerCase().includes(q)).slice(0,12);
            if(!m.length){c.classList.remove('active');return;}
            c.innerHTML=m.map(p=>`<div class="pantone-item" onclick="selectPantone('${p.code}','${p.hex}')"><div class="swatch" style="background:${p.hex}"></div><div class="info"><span class="name">${p.code}</span><br><span class="hex">${p.hex}</span></div></div>`).join('');
            c.classList.add('active');
        }
        function selectPantone(code,hex){
            document.getElementById('f_pantone_code').value=code;
            document.getElementById('f_pantone_hex').value=hex;
            document.getElementById('f_color_picker').value=hex;
            document.getElementById('f_color_bar').style.background=hex;
            document.getElementById('pantone_search').value=code;
            document.getElementById('pantone-results').classList.remove('active');
        }
        document.addEventListener('click',e=>{if(!e.target.closest('.pantone-picker-container'))document.getElementById('pantone-results').classList.remove('active');});

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function openFormModal(id=null, defaultStatus=null){
          try {
            document.getElementById('edit-id').value=id||'';
            document.getElementById('formulation-form').reset();
            document.getElementById('sample-inherited').style.display='none';
            document.getElementById('calc-results').style.display='none';
            document.getElementById('wick-info').style.display='none';
            document.getElementById('f_color_bar').style.background='transparent';
            document.getElementById('f-fragrance-info').style.display='none';
            document.getElementById('f_fragrance_pct').readOnly=false;
            document.getElementById('f_fragrance_pct').style.background='';
            document.getElementById('f_fragrance_pct').title='';
            tempWaxComposition=[];renderWaxComposition();

            if(id){
                // Edit mode
                const r=await fetch('/api/formulations/'+id);const f=await r.json();
                document.getElementById('form-modal-title').textContent='Modifier ‚Äî '+f.code;
                document.getElementById('auto-code').textContent=f.code;
                document.getElementById('sample_id').value=f.sample_id||'';
                document.getElementById('f_name').value=f.name||'';
                document.getElementById('f_status').value=f.status||'en_cours';
                document.getElementById('f_container').value=f.container_type||'container';
                document.getElementById('f_diameter').value=f.diameter||'';
                document.getElementById('f_height').value=f.height||'';
                document.getElementById('f_version').value=f.version||1;
                document.getElementById('f_total_mass').value=f.total_mass||'';
                document.getElementById('f_fragrance_pct').value=f.fragrance_percentage||'';
                // Lock if inherited from sample
                if(f.sample_id){const sm=samples.find(x=>x.id==f.sample_id);if(sm&&sm.fragrance_percentage){document.getElementById('f_fragrance_pct').readOnly=true;document.getElementById('f_fragrance_pct').style.background='var(--fond-surface)';document.getElementById('f_fragrance_pct').title='H√©rit√© de l\'√©chantillon';}}
                document.getElementById('f_fragrance_name').value=f.fragrance_name||'';
                document.getElementById('f_fragrance_ref').value=f.fragrance_ref||'';
                document.getElementById('f_fragrance_supplier').value=f.fragrance_supplier||'';
                if(f.fragrance_id){document.getElementById('f_fragrance_id').value=f.fragrance_id;onFormFragranceSelect();}
                document.getElementById('f_pantone_code').value=f.pantone_code||'';
                document.getElementById('f_pantone_hex').value=f.pantone_hex||'';
                if(f.pantone_hex){document.getElementById('f_color_picker').value=f.pantone_hex;document.getElementById('f_color_bar').style.background=f.pantone_hex;document.getElementById('pantone_search').value=f.pantone_code||'';}
                document.getElementById('f_notes').value=f.notes||'';
                document.getElementById('f_temp_fusion').value=f.temp_fusion||'';
                document.getElementById('f_temp_ajout_parfum').value=f.temp_ajout_parfum||'';
                document.getElementById('f_temp_coulage').value=f.temp_coulage||'';
                document.getElementById('f_temp_notes').value=f.temp_notes||'';
                // Wick
                if(f.wick_id)document.getElementById('f_wick_id').value=f.wick_id;
                if(f.sample_id)onSampleSelect();
                recalculate();
                // Load existing wax composition
                if(f.waxes&&f.waxes.length){
                    tempWaxComposition=f.waxes.map(w=>({wax_id:w.wax_id,percentage:w.percentage,reference:w.wax_name||w.reference||'?',name:w.wax_name||'?',supplier:w.supplier_name||'?',category:w.wax_type||''}));
                    renderWaxComposition();
                }
                document.getElementById('btn-to-test').style.display='';
                document.getElementById('change-reason-block').style.display='';
                document.getElementById('f_change_reason').value='';
            } else {
                // New mode
                document.getElementById('change-reason-block').style.display='none';
                if (defaultStatus === 'valid√©') {
                    document.getElementById('form-modal-title').textContent='‚úÖ Enregistrer une formulation valid√©e';
                    document.getElementById('f_status').value='valid√©';
                } else {
                    document.getElementById('form-modal-title').textContent='Nouvelle formulation';
                }
                document.getElementById('auto-code').textContent='S√©lectionnez un √©chantillon...';
                document.getElementById('btn-to-test').style.display='none';
                // Pre-select sample from URL
                const p=new URLSearchParams(location.search);
                if(p.get('sample')){document.getElementById('sample_id').value=p.get('sample');onSampleSelect();}
            }
            document.getElementById('form-modal').classList.add('active');
          } catch(err) {
            console.error('Erreur openFormModal:', err);
            toast('Erreur ouverture formulaire: ' + err.message, 'error');
            // Ouvrir quand m√™me le modal pour ne pas bloquer l'utilisateur
            document.getElementById('form-modal').classList.add('active');
          }
        }
        function closeFormModal(){document.getElementById('form-modal').classList.remove('active');}

        function goToFormulateur() {
            // Passer le contexte actuel au formulateur via URL params
            const params = new URLSearchParams();
            const sid = document.getElementById('sample_id').value;
            if (sid) params.set('sample', sid);
            const ct = document.getElementById('f_container').value;
            if (ct) params.set('type', ct);
            const d = document.getElementById('f_diameter').value;
            if (d) params.set('diameter', d);
            const h = document.getElementById('f_height').value;
            if (h) params.set('height', h);
            const m = document.getElementById('f_total_mass').value;
            if (m) params.set('mass', m);
            const fn = document.getElementById('f_fragrance_name').value;
            if (fn) params.set('fragrance', fn);
            const fr = document.getElementById('f_fragrance_ref').value;
            if (fr) params.set('ref', fr);
            const fs = document.getElementById('f_fragrance_supplier').value;
            if (fs) params.set('supplier', fs);
            const fp = document.getElementById('f_fragrance_pct').value;
            if (fp) params.set('pct', fp);
            window.location.href = 'formulateur.html?' + params.toString();
        }

        async function saveFormulation(){
            const total=parseFloat(document.getElementById('f_total_mass').value);
            const name=document.getElementById('f_name').value.trim();
            if(!name||!total){toast('Nom et masse obligatoires','error');return;}
            const fragPct=parseFloat(document.getElementById('f_fragrance_pct').value)||0;
            const xlSub = window._excelFormulation;
            const colPct = (xlSub && xlSub.colorants) ? xlSub.colorants.reduce((s,c)=>s+(c.percentage||0),0) : 0;
            if(fragPct>=100){toast('Le parfum ne peut pas √™tre ‚â• 100%','error');return;}
            const expectedWaxPct=100-fragPct-colPct;
            const waxTotalPct=tempWaxComposition.reduce((s,w)=>s+w.percentage,0);
            if(tempWaxComposition.length>0&&Math.abs(waxTotalPct-expectedWaxPct)>0.5){toast('La composition cires doit totaliser '+expectedWaxPct.toFixed(1)+'% (100% ‚àí '+fragPct+'% parfum'+(colPct>0?' ‚àí '+colPct+'% colorant':'')+')'+'. Actuellement '+waxTotalPct.toFixed(1)+'%','error');return;}
            const editId=document.getElementById('edit-id').value;
            const code=document.getElementById('auto-code').textContent;
            const wickSel=document.getElementById('f_wick_id');
            const wickId=wickSel.value||null;
            const wickRef=wickId?wickSel.options[wickSel.selectedIndex].dataset.ref||null:null;

            const data={
                code, name,
                sample_id:document.getElementById('sample_id').value||null,
                client_id:null,
                container_type:document.getElementById('f_container').value,
                diameter:document.getElementById('f_diameter').value||null,
                height:document.getElementById('f_height').value||null,
                total_mass:total,
                fragrance_name:document.getElementById('f_fragrance_name').value,
                fragrance_ref:document.getElementById('f_fragrance_ref').value,
                fragrance_supplier:document.getElementById('f_fragrance_supplier').value,
                fragrance_percentage:document.getElementById('f_fragrance_pct').value||null,
                fragrance_id:document.getElementById('f_fragrance_id').value||null,
                pantone_code:document.getElementById('f_pantone_code').value,
                pantone_hex:document.getElementById('f_pantone_hex').value,
                wick_reference:wickRef,
                wick_id:wickId,
                status:document.getElementById('f_status').value,
                version:parseInt(document.getElementById('f_version').value)||1,
                notes:document.getElementById('f_notes').value,
                change_reason:document.getElementById('f_change_reason').value||null,
                temp_fusion:document.getElementById('f_temp_fusion').value||null,
                temp_ajout_parfum:document.getElementById('f_temp_ajout_parfum').value||null,
                temp_coulage:document.getElementById('f_temp_coulage').value||null,
                temp_notes:document.getElementById('f_temp_notes').value||null
            };
            // Inherit client_id from sample
            const s=samples.find(x=>x.id==data.sample_id);
            if(s)data.client_id=s.client_id;

            const url=editId?'/api/formulations/'+editId:'/api/formulations';
            const method=editId?'PUT':'POST';
            const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
            const res=await r.json();
            if(res.error){toast(res.error,'error');return;}
            
            // Save wax composition
            const formId=editId||res.id;
            // Delete existing waxes first (on edit)
            if(editId){
                const existingR=await fetch('/api/formulations/'+formId);
                const existing=await existingR.json();
                if(existing.waxes){for(const w of existing.waxes){await fetch('/api/formulations/'+formId+'/waxes/'+w.id,{method:'DELETE'});}}
            }
            // Insert new composition
            for(const w of tempWaxComposition){
                await fetch('/api/formulations/'+formId+'/waxes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({wax_id:w.wax_id,percentage:w.percentage})});
            }
            
            closeFormModal();loadFormulations();toast(editId?'Formulation modifi√©e':'Formulation cr√©√©e');
            // Log activit√© op√©rateur
            mfcLogActivity(editId ? 'modification' : 'cr√©ation', 'formulation', formId, data.code, data.fragrance_name || data.name);
            
            // Si statut valid√© ‚Üí cr√©er recette + fiche savoir automatiquement
            if (data.status === 'valid√©') {
                try {
                    const vr = await fetch('/api/formulations/' + formId + '/validate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ notes: data.notes || '' })
                    });
                    const vd = await vr.json();
                    if (vd.success) {
                        toast('‚úÖ Recette ' + vd.recipe_code + ' cr√©√©e + patrimoine enrichi', 'success');
                    }
                } catch(ve) { console.error('Auto-validation:', ve); }
            }
            
            return {id:formId, success:true};
        }

        async function saveAndGoTest(){
            const res=await saveFormulation();
            if(res&&!res.error){
                const id=document.getElementById('edit-id').value||res.id;
                window.location.href='tests.html?formulation='+id;
            }
        }

        function editFormulation(id){openFormModal(id);}

        function launchTest(id){
            window.location.href='tests.html?formulation='+id;
        }

        async function deleteFormulation(id){
            const f=formulations.find(x=>x.id===id);
            if(confirm('Supprimer '+(f?f.code:'')+' ?')){
                await fetch('/api/formulations/'+id,{method:'DELETE'});loadFormulations();toast('Supprim√©');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function viewDetail(id){
            const r=await fetch('/api/formulations/'+id);const f=await r.json();
            if(f.error){toast('Non trouv√©','error');return;}
            window._currentFormDetail = f;
            document.getElementById('detail-title').textContent=f.code+' ‚Äî '+f.name;
            const pct=f.fragrance_percentage||0;
            const colPct = (f.colorants && f.colorants.length) ? f.colorants.reduce((s,c)=>s+(c.percentage||0),0) : (f.colorant_mass && f.total_mass ? (f.colorant_mass/f.total_mass*100) : 0);
            const fragMass=f.total_mass*(pct/100);
            const colMass = (f.colorants && f.colorants.length) ? f.colorants.reduce((s,c)=>s+(c.mass||0),0) : (f.colorant_mass||0);
            const waxMass=f.total_mass-fragMass-colMass;
            let html=`
                <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:0.75rem 1rem; margin-bottom:1rem;">
                    <p style="font-size:0.68rem; text-transform:uppercase; letter-spacing:1px; color:var(--texte-muted); font-weight:600; margin-bottom:0.4rem;">Tra√ßabilit√©</p>
                    <div class="grid grid-4" style="gap:0.5rem;">
                        <div><span class="text-muted" style="font-size:0.68rem;">√âCHANTILLON</span><br><strong style="color:var(--mfc-cire);">${f.sample_number||'‚Äî'}</strong></div>
                        <div><span class="text-muted" style="font-size:0.68rem;">CLIENT</span><br><strong>${f.client_name||'‚Äî'}</strong> ${f.client_company?'('+f.client_company+')':''}</div>
                        <div><span class="text-muted" style="font-size:0.68rem;">STATUT</span><br><span class="badge badge-${f.status}">${f.status}</span></div>
                        <div><span class="text-muted" style="font-size:0.68rem;">VERSION</span><br><strong>v${f.version||1}</strong></div>
                    </div>
                </div>
                <div class="grid grid-4" style="gap:0.75rem; margin-bottom:1rem; text-align:center;">
                    <div style="background:var(--fond-surface); padding:1rem; border-radius:var(--radius); border:1px solid var(--bordure-legere);">
                        <p style="font-size:0.65rem; text-transform:uppercase; color:var(--texte-muted);">Masse totale</p>
                        <p style="font-size:1.5rem; font-weight:700; color:var(--mfc-cire); font-family:var(--font-display);">${f.total_mass} g</p>
                    </div>
                    <div style="background:var(--fond-surface); padding:1rem; border-radius:var(--radius); border:1px solid var(--bordure-legere);">
                        <p style="font-size:0.65rem; text-transform:uppercase; color:var(--texte-muted);">Parfum (${pct}%)</p>
                        <p style="font-size:1.5rem; font-weight:700; font-family:var(--font-display);">${fragMass.toFixed(1)} g</p>
                        <p style="font-size:0.78rem; color:var(--texte-secondary);">${f.fragrance_name||'‚Äî'}${f.fragrance_ref?' <span style="color:var(--mfc-cire);">['+f.fragrance_ref+']</span>':''}${f.fragrance_supplier?' ‚Äî '+f.fragrance_supplier:''}</p>
                    </div>
                    <div style="background:var(--fond-surface); padding:1rem; border-radius:var(--radius); border:1px solid var(--bordure-legere);">
                        <p style="font-size:0.65rem; text-transform:uppercase; color:var(--texte-muted);">Masse cire</p>
                        <p style="font-size:1.5rem; font-weight:700; font-family:var(--font-display);">${waxMass.toFixed(1)} g</p>
                    </div>
                    <div style="background:var(--fond-surface); padding:1rem; border-radius:var(--radius); border:1px solid var(--bordure-legere);">
                        <p style="font-size:0.65rem; text-transform:uppercase; color:var(--texte-muted);">Colorant(s) (${colPct ? colPct.toFixed(2)+'%' : '‚Äî'})</p>
                        <p style="font-size:1.5rem; font-weight:700; font-family:var(--font-display);">${colMass.toFixed(2)} g</p>
                    </div>
                </div>
                <div class="grid grid-4" style="gap:0.75rem; margin-bottom:1rem;">
                    <div style="background:var(--fond-surface); padding:0.75rem; border-radius:var(--radius); border:1px solid var(--bordure-legere);">
                        <span class="text-muted" style="font-size:0.68rem;">TYPE</span><br><strong>${f.container_type||'‚Äî'}</strong>
                    </div>
                    <div style="background:var(--fond-surface); padding:0.75rem; border-radius:var(--radius); border:1px solid var(--bordure-legere);">
                        <span class="text-muted" style="font-size:0.68rem;">DIMENSIONS</span><br><strong>${f.diameter&&f.height?f.diameter+'√ó'+f.height+' mm':'‚Äî'}</strong>
                    </div>
                    <div style="background:var(--fond-surface); padding:0.75rem; border-radius:var(--radius); border:1px solid var(--bordure-legere);">
                        <span class="text-muted" style="font-size:0.68rem;">M√àCHE</span><br><strong style="color:var(--mfc-cire);">${f.wick_reference||'‚Äî'}</strong>
                    </div>
                    <div style="background:var(--fond-surface); padding:0.75rem; border-radius:var(--radius); border:1px solid var(--bordure-legere);">
                        <span class="text-muted" style="font-size:0.68rem;">COULEUR</span><br>
                        ${f.pantone_hex?'<span class="color-preview" style="background:'+f.pantone_hex+'"></span>':''}
                        <strong>${f.pantone_code||'‚Äî'}</strong>
                    </div>
                </div>`;
            // Waxes composition
            if(f.waxes&&f.waxes.length){
                html+=`<h4 style="font-family:var(--font-display); font-weight:500; margin:0.75rem 0 0.5rem;">Composition des cires</h4>
                <div class="table-container"><table><thead><tr><th>Cire</th><th>Fournisseur</th><th>Type</th><th>%</th><th>Masse</th></tr></thead><tbody>`;
                f.waxes.forEach(w=>{const wMass=f.total_mass&&w.percentage?(f.total_mass*w.percentage/100).toFixed(1)+'g':'‚Äî';html+=`<tr><td><strong>${w.wax_name||w.reference}</strong></td><td>${w.supplier_name||'‚Äî'}</td><td>${w.wax_type||'‚Äî'}</td><td>${w.percentage}%</td><td>${wMass}</td></tr>`;});
                html+='</tbody></table></div>';
            }
            if(f.notes)html+=`<div class="divider"></div><p class="text-muted" style="font-size:0.68rem; text-transform:uppercase;">Notes</p><p style="font-size:0.88rem;">${f.notes}</p>`;
            document.getElementById('detail-body').innerHTML=html;
            document.getElementById('btn-detail-edit').onclick=()=>{closeDetailModal();editFormulation(id);};
            document.getElementById('btn-detail-test').href='tests.html?formulation='+id;
            // Afficher bouton valider si pas encore valid√©
            document.getElementById('btn-detail-validate').style.display = (f.status !== 'valid√©') ? '' : 'none';
            document.getElementById('btn-detail-validate').dataset.id = id;
            document.getElementById('detail-modal').classList.add('active');
        }

        async function validateFormulation() {
            const f = window._currentFormDetail;
            if (!f) return;
            const id = document.getElementById('btn-detail-validate').dataset.id;
            const warnings = [];
            if (!f.fragrance_id) warnings.push('‚Ä¢ Parfum non li√© √† la base (fragrance_id manquant)');
            if (!f.sample_id) warnings.push('‚Ä¢ Pas d\'√©chantillon source li√©');
            if (!f.client_name && !f.client_id) warnings.push('‚Ä¢ Pas de client attribu√©');
            if (!f.waxes || !f.waxes.length) warnings.push('‚Ä¢ Pas de composition cires');
            let msg = 'Valider cette formulation ?\n\nCela va :\n‚Ä¢ Passer la formulation en statut "valid√©"\n‚Ä¢ Cr√©er une recette dans la base\n‚Ä¢ Ajouter une fiche au patrimoine num√©rique';
            if (warnings.length) {
                msg += '\n\n‚ö†Ô∏è ATTENTION ‚Äî Donn√©es incompl√®tes :\n' + warnings.join('\n') + '\n\nLa recette sera cr√©√©e avec ces donn√©es manquantes.';
            }
            if (!confirm(msg)) return;
            try {
                const r = await fetch('/api/formulations/' + id + '/validate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ notes: f.notes || '' })
                });
                const d = await r.json();
                if (d.success) {
                    toast('‚úÖ Formulation valid√©e ! Recette ' + d.recipe_code + ' cr√©√©e', 'success');
                    mfcLogActivity('validation', 'formulation', id, f.code, 'Recette ' + d.recipe_code + ' cr√©√©e');
                    closeDetailModal();
                    loadFormulations();
                } else {
                    toast('Erreur : ' + d.error, 'error');
                }
            } catch(e) { toast('Erreur : ' + e.message, 'error'); }
        }
        function closeDetailModal(){document.getElementById('detail-modal').classList.remove('active');}

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FICHE LABO IMPRIMABLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function printFormSheet() {
            const f = window._currentFormDetail;
            if (!f) { toast('Aucune formulation','error'); return; }
            const pct = f.fragrance_percentage || 0;
            const colPct = (f.colorants && f.colorants.length) ? f.colorants.reduce((s,c)=>s+(c.percentage||0),0) : (f.colorant_mass && f.total_mass ? (f.colorant_mass/f.total_mass*100) : 0);
            const fragMass = f.total_mass * (pct / 100);
            const colMass = (f.colorants && f.colorants.length) ? f.colorants.reduce((s,c)=>s+(c.mass||0),0) : (f.colorant_mass||0);
            const waxMass = f.total_mass - fragMass - colMass;
            const date = new Date().toLocaleDateString('fr-FR', {day:'numeric',month:'long',year:'numeric'});

            let waxRows = '';
            if (f.waxes && f.waxes.length) {
                f.waxes.forEach(w => {
                    waxRows += '<tr><td style="font-weight:600;">' + (w.wax_name||w.reference) + '</td><td>' + (w.supplier_name||'') + '</td><td>' + w.percentage + '%</td><td>' + (w.mass ? w.mass.toFixed(1) + 'g' : '') + '</td><td style="width:100px;border-bottom:1px dotted #999;"></td></tr>';
                });
            } else {
                waxRows = '<tr><td colspan="4">Cire totale</td><td>' + waxMass.toFixed(1) + 'g</td><td style="width:100px;"></td></tr>';
            }

            const content = '<div style="max-width:700px;margin:0 auto;font-family:Open Sans,Arial,sans-serif;font-size:11pt;">' +
                // Header
                '<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #a32d03;padding-bottom:8px;margin-bottom:12px;">' +
                '<div><p style="font-size:8pt;text-transform:uppercase;letter-spacing:3px;color:#a32d03;margin:0;">Maison Fran√ßaise des Cires</p><h2 style="margin:2px 0;font-size:16pt;">FICHE FORMULATION ‚Äî LABO</h2></div>' +
                '<div style="text-align:right;"><p style="font-size:9pt;color:#666;margin:0;">' + date + '</p><p style="font-size:14pt;font-weight:700;color:#a32d03;margin:2px 0;">' + f.code + '</p></div></div>' +
                // Traceability
                '<table style="width:100%;font-size:9pt;margin-bottom:10px;border-collapse:collapse;"><tr>' +
                '<td style="padding:4px 8px;background:#f5f0eb;border:1px solid #ddd;width:25%;"><span style="color:#999;font-size:7pt;text-transform:uppercase;">√âchantillon</span><br><strong style="color:#a32d03;">' + (f.sample_number||'‚Äî') + '</strong></td>' +
                '<td style="padding:4px 8px;background:#f5f0eb;border:1px solid #ddd;width:25%;"><span style="color:#999;font-size:7pt;text-transform:uppercase;">Client</span><br><strong>' + (f.client_name||'‚Äî') + '</strong></td>' +
                '<td style="padding:4px 8px;background:#f5f0eb;border:1px solid #ddd;width:25%;"><span style="color:#999;font-size:7pt;text-transform:uppercase;">Type</span><br><strong>' + (f.container_type||'‚Äî') + ' ' + (f.diameter&&f.height?f.diameter+'√ó'+f.height+'mm':'') + '</strong></td>' +
                '<td style="padding:4px 8px;background:#f5f0eb;border:1px solid #ddd;width:25%;"><span style="color:#999;font-size:7pt;text-transform:uppercase;">M√®che initiale</span><br><strong style="color:#a32d03;">' + (f.wick_reference||'‚Äî') + '</strong></td>' +
                '</tr></table>' +
                // Temp√©ratures process
                '<h3 style="font-size:11pt;border-bottom:2px solid #a32d03;padding-bottom:3px;margin:12px 0 6px;">üå°Ô∏è TEMP√âRATURES PROCESS</h3>' +
                '<table style="width:100%;font-size:9pt;border-collapse:collapse;">' +
                '<tr style="background:#a32d03;color:#fff;"><th style="padding:4px 6px;text-align:left;width:25%;">√âtape</th><th style="width:20%;">Consigne</th><th style="width:20%;">R√©elle</th><th style="width:35%;">Observations</th></tr>' +
                '<tr><td style="font-weight:600;border:1px solid #ddd;padding:6px;">Fonte des cires</td><td style="border:1px solid #ddd;padding:6px;font-weight:700;color:#a32d03;">' + (f.temp_fusion ? f.temp_fusion + '¬∞C' : '82¬∞C') + '</td><td style="border:1px solid #ddd;padding:6px;border-bottom:1px dotted #999;height:25px;"></td><td style="border:1px solid #ddd;padding:6px;"></td></tr>' +
                '<tr><td style="font-weight:600;border:1px solid #ddd;padding:6px;">Ajout parfum</td><td style="border:1px solid #ddd;padding:6px;font-weight:700;color:#a32d03;">' + (f.temp_ajout_parfum ? f.temp_ajout_parfum + '¬∞C' : '65¬∞C') + '</td><td style="border:1px solid #ddd;padding:6px;border-bottom:1px dotted #999;height:25px;"></td><td style="border:1px solid #ddd;padding:6px;"></td></tr>' +
                '<tr><td style="font-weight:600;border:1px solid #ddd;padding:6px;">Coulage</td><td style="border:1px solid #ddd;padding:6px;font-weight:700;color:#a32d03;">' + (f.temp_coulage ? f.temp_coulage + '¬∞C' : '70¬∞C') + '</td><td style="border:1px solid #ddd;padding:6px;border-bottom:1px dotted #999;height:25px;"></td><td style="border:1px solid #ddd;padding:6px;"></td></tr>' +
                '</table>' +
                (f.temp_notes ? '<p style="font-size:8pt;color:#666;margin:4px 0 0 2px;">üìã ' + f.temp_notes + '</p>' : '') +
                // Composition
                '<h3 style="font-size:11pt;border-bottom:2px solid #a32d03;padding-bottom:3px;margin:12px 0 6px;">COMPOSITION</h3>' +
                '<table style="width:100%;font-size:9pt;border-collapse:collapse;">' +
                '<tr style="background:#a32d03;color:#fff;"><th style="padding:4px 6px;text-align:left;">Mati√®re</th><th>Fournisseur</th><th>%</th><th>Masse</th><th>Pes√©e r√©elle</th></tr>' +
                waxRows +
                '<tr style="background:#fef3e8;"><td style="font-weight:600;">Parfum ‚Äî ' + (f.fragrance_name||'?') + (f.fragrance_ref ? ' ['+f.fragrance_ref+']' : '') + '</td><td>' + (f.fragrance_supplier||'') + '</td><td>' + pct + '%</td><td>' + fragMass.toFixed(1) + 'g</td><td style="border-bottom:1px dotted #999;"></td></tr>' +
                '<tr><td style="font-weight:600;">Colorant' + (f.pantone_code ? ' ‚Äî ' + f.pantone_code : '') + '</td><td></td><td>' + colPct + '%</td><td>' + colMass.toFixed(2) + 'g</td><td style="border-bottom:1px dotted #999;"></td></tr>' +
                '<tr style="background:#f5f0eb;font-weight:700;font-size:10pt;"><td>TOTAL</td><td></td><td>100%</td><td>' + f.total_mass + 'g</td><td style="border-bottom:1px dotted #999;"></td></tr>' +
                '</table>' +
                // Notes formulation
                '<div style="margin:12px 0;padding:8px;background:#f5f0eb;border:1px solid #ddd;border-radius:4px;">' +
                '<p style="font-size:8pt;text-transform:uppercase;color:#999;margin:0 0 3px;">Notes formulation</p>' +
                '<p style="margin:0;min-height:25px;">' + (f.notes||'') + '</p></div>' +
                // Section modifications au labo
                '<h3 style="font-size:11pt;border-bottom:2px solid #a32d03;padding-bottom:3px;margin:15px 0 6px;">MODIFICATIONS AU LABO (√† remplir √† la main)</h3>' +
                '<table style="width:100%;font-size:9pt;border-collapse:collapse;">' +
                '<tr style="background:#a32d03;color:#fff;"><th style="padding:4px 6px;text-align:left;width:15%;">Param√®tre</th><th style="width:25%;">Valeur initiale</th><th style="width:25%;">Modification</th><th style="width:35%;">Raison</th></tr>' +
                '<tr><td style="font-weight:600;border:1px solid #ddd;padding:6px;">M√®che</td><td style="border:1px solid #ddd;padding:6px;">' + (f.wick_reference||'') + '</td><td style="border:1px solid #ddd;padding:6px;border-bottom:1px dotted #999;height:30px;"></td><td style="border:1px solid #ddd;padding:6px;"></td></tr>' +
                '<tr><td style="font-weight:600;border:1px solid #ddd;padding:6px;">% Parfum</td><td style="border:1px solid #ddd;padding:6px;">' + pct + '% (' + fragMass.toFixed(1) + 'g)</td><td style="border:1px solid #ddd;padding:6px;height:30px;"></td><td style="border:1px solid #ddd;padding:6px;"></td></tr>' +
                '<tr><td style="font-weight:600;border:1px solid #ddd;padding:6px;">Cire(s)</td><td style="border:1px solid #ddd;padding:6px;">' + (f.waxes?f.waxes.map(w=>w.reference+' '+w.percentage+'%').join(', '):'') + '</td><td style="border:1px solid #ddd;padding:6px;height:30px;"></td><td style="border:1px solid #ddd;padding:6px;"></td></tr>' +
                '<tr><td style="font-weight:600;border:1px solid #ddd;padding:6px;">Colorant</td><td style="border:1px solid #ddd;padding:6px;">' + (f.pantone_code||'') + ' ' + colMass.toFixed(2) + 'g</td><td style="border:1px solid #ddd;padding:6px;height:30px;"></td><td style="border:1px solid #ddd;padding:6px;"></td></tr>' +
                '<tr><td style="font-weight:600;border:1px solid #ddd;padding:6px;">Autre</td><td style="border:1px solid #ddd;padding:6px;"></td><td style="border:1px solid #ddd;padding:6px;height:30px;"></td><td style="border:1px solid #ddd;padding:6px;"></td></tr>' +
                '</table>' +
                // Observations libres
                '<div style="margin:12px 0;border:1px solid #ddd;border-radius:4px;padding:8px;min-height:80px;">' +
                '<p style="font-size:8pt;text-transform:uppercase;color:#999;margin:0 0 3px;">Observations libres</p>' +
                '<div style="min-height:60px;border-top:1px dotted #ccc;"></div></div>' +
                // Footer
                '<div style="text-align:center;margin-top:8px;font-size:7pt;color:#999;border-top:1px solid #ddd;padding-top:4px;">' +
                'MFC Laboratoire ‚Äî Fiche formulation ' + f.code + ' ‚Äî Imprim√© le ' + date +
                '</div></div>';

            const w = window.open('', '_blank');
            w.document.write('<!DOCTYPE html><html><head><style>@page{size:A4;margin:1.5cm;}body{margin:0;font-family:Open Sans,Arial,sans-serif;}table th,table td{text-align:left;}@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}</style></head><body>' + content + '<scr' + 'ipt src="/js/cache-buster.js"></scr' + 'ipt><scr' + 'ipt>fetch("/api/version").then(r=>r.json()).then(d=>{var v="v"+d.version;if(document.getElementById("mfc-v"))document.getElementById("mfc-v").textContent=v;if(document.getElementById("mfc-vf"))document.getElementById("mfc-vf").textContent=v;document.title=document.title.replace(/MFC Laboratoire/,"MFC Laboratoire "+v)}).catch(()=>{})</scr' + 'ipt></body></html>');
            w.document.close();
            setTimeout(() => w.print(), 400);
        }

        // Escape + overlay
        document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeFormModal();closeDetailModal();}});
        document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active');}));

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('DOMContentLoaded',async()=>{
            const status = (msg, ok) => { console.log((ok?'‚úì':'‚úó') + ' ' + msg); };
            const loaders = [
                { name: '√âchantillons', fn: loadSamples },
                { name: 'M√®ches', fn: loadWicks },
                { name: 'Parfums', fn: loadAllFragrances },
                { name: 'Fournisseurs', fn: loadAllSuppliers },
                { name: 'Cires', fn: loadAllWaxes }
            ];
            for (const loader of loaders) {
                try { await loader.fn(); status(loader.name, true); }
                catch(e) { status(loader.name + ' ERREUR: ' + e.message, false); }
            }
            try {
                await loadFormulations();
                status('Formulations', true);
            } catch(e) {
                status('Formulations ERREUR: ' + e.message, false);
                document.getElementById('formulations-table').innerHTML = '<tr><td colspan="11"><div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Erreur : ' + e.message + '</p><p style="font-size:0.78rem;color:var(--texte-muted);margin-top:0.5rem;">Ouvrir la console (F12) pour plus de d√©tails</p><button class="btn btn-primary" onclick="loadFormulations()">R√©essayer</button></div></td></tr>';
            }
            document.getElementById('filter-status').addEventListener('change',loadFormulations);
            document.getElementById('search-input').addEventListener('input',renderFormulations);
            
            // ‚ïê‚ïê‚ïê AUTO-OUVERTURE DEPUIS AUTRES PAGES ‚ïê‚ïê‚ïê
            // On lit les params AVANT de nettoyer l'URL
            const params = new URLSearchParams(window.location.search);
            const autoSampleId = params.get('sample');
            const autoFromFds = params.get('from') === 'fds';
            const autoFragName = params.get('fragrance_name');
            const autoFragRef = params.get('fragrance_ref');
            const autoFragSup = params.get('fragrance_supplier');
            
            // Nettoyer l'URL imm√©diatement (les valeurs sont sauvegard√©es ci-dessus)
            if (autoSampleId || autoFromFds) {
                window.history.replaceState({}, '', 'formulations.html');
            }
            
            // Auto-ouverture depuis √âchantillons (?sample=ID)
            if (autoSampleId && !autoFromFds) {
                await openFormModal();
                const sel = document.getElementById('sample_id');
                if (sel) { sel.value = autoSampleId; onSampleSelect(); }
            }
            
            // Auto-ouverture depuis FDS
            if (autoFromFds) {
                await openFormModal();
                if (autoFragName) document.getElementById('f_fragrance_name').value = autoFragName;
                if (autoFragRef) document.getElementById('f_fragrance_ref').value = autoFragRef;
                if (autoFragSup) document.getElementById('f_fragrance_supplier').value = autoFragSup;
            }
        });
    </script>
<script src="/js/operator-selector.js"></script>
<script src="/js/cache-buster.js"></script>
<script>fetch("/api/version").then(r=>r.json()).then(d=>{var v="v"+d.version;if(document.getElementById("mfc-v"))document.getElementById("mfc-v").textContent=v;if(document.getElementById("mfc-vf"))document.getElementById("mfc-vf").textContent=v;document.title=document.title.replace(/MFC Laboratoire/,"MFC Laboratoire "+v)}).catch(()=>{})</script>
</body>
</html>
