<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impression â€” MFC Laboratoire</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Open+Sans:wght@300;400;600;700&display=swap');

        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Open Sans',sans-serif; font-size:11pt; color:#1a1a1a; background:#fff; padding:0; }

        /* â•â•â• HEADER MFC â•â•â• */
        .print-header { display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #a32d03; padding-bottom:12px; margin-bottom:16px; }
        .print-header .logo { display:flex; align-items:center; gap:12px; }
        .print-header .logo img { height:45px; border-radius:6px; }
        .print-header .logo h1 { font-family:'Playfair Display',serif; font-size:16pt; color:#a32d03; letter-spacing:1px; }
        .print-header .logo .sub { font-size:8pt; color:#666; letter-spacing:2px; text-transform:uppercase; }
        .print-header .doc-info { text-align:right; font-size:9pt; color:#666; }
        .print-header .doc-info .doc-type { font-size:12pt; font-weight:700; color:#a32d03; text-transform:uppercase; letter-spacing:1px; }
        .print-header .doc-info .doc-code { font-family:monospace; font-size:11pt; font-weight:700; color:#1a1a1a; margin-top:2px; }

        /* â•â•â• SECTIONS â•â•â• */
        .section { margin-bottom:14px; }
        .section-title { font-family:'Playfair Display',serif; font-size:12pt; color:#a32d03; border-bottom:1px solid #e0d8cc; padding-bottom:4px; margin-bottom:8px; }

        /* â•â•â• TABLES â•â•â• */
        table { width:100%; border-collapse:collapse; font-size:10pt; margin-bottom:10px; }
        th { background:#f8f6f1; text-align:left; padding:5px 8px; font-size:8pt; text-transform:uppercase; letter-spacing:0.5px; color:#666; border-bottom:2px solid #a32d03; }
        td { padding:5px 8px; border-bottom:1px solid #e8e4dc; }
        .mass-cell { font-weight:700; font-family:monospace; font-size:11pt; }
        .total-row { background:#fdfbf6; font-weight:700; border-top:2px solid #a32d03; }
        .check-cell { width:60px; text-align:center; }

        /* â•â•â• INFO GRID â•â•â• */
        .info-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px 20px; margin-bottom:10px; font-size:10pt; }
        .info-grid.three { grid-template-columns:1fr 1fr 1fr; }
        .info-grid.four { grid-template-columns:1fr 1fr 1fr 1fr; }
        .info-item { display:flex; gap:6px; }
        .info-label { color:#888; font-size:8pt; text-transform:uppercase; letter-spacing:0.5px; min-width:90px; }
        .info-value { font-weight:600; }

        /* â•â•â• PARAM CARDS â•â•â• */
        .params-row { display:flex; gap:10px; margin-bottom:12px; }
        .param-box { flex:1; text-align:center; border:1.5px solid #a32d03; border-radius:8px; padding:8px 4px; }
        .param-box .val { font-size:16pt; font-weight:700; color:#a32d03; }
        .param-box .lbl { font-size:7pt; text-transform:uppercase; letter-spacing:1px; color:#666; margin-top:2px; }

        /* â•â•â• NOTES / ZONES Ã‰CRITURE â•â•â• */
        .write-zone { border:1.5px solid #ccc; border-radius:6px; min-height:60px; padding:6px 8px; margin-bottom:8px; position:relative; }
        .write-zone.tall { min-height:100px; }
        .write-zone .placeholder { font-size:8pt; color:#bbb; font-style:italic; }
        .write-lines { background: repeating-linear-gradient(transparent, transparent 22px, #e8e4dc 22px, #e8e4dc 23px); min-height:66px; padding-top:4px; }
        .write-lines.tall { min-height:110px; }

        /* â•â•â• OBSERVATION GRID â•â•â• */
        .obs-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:6px; margin-bottom:10px; }
        .obs-item { border:1px solid #ddd; border-radius:6px; padding:6px; text-align:center; font-size:8pt; }
        .obs-item .icon { font-size:16pt; }
        .obs-item .name { margin-top:2px; font-weight:600; }
        .obs-checkbox { width:14px; height:14px; border:1.5px solid #a32d03; border-radius:3px; display:inline-block; margin-top:4px; }

        /* â•â•â• CYCLE TABLE â•â•â• */
        .cycle-header { background:#a32d03; color:#fff; font-weight:700; text-align:center; padding:6px; font-size:10pt; border-radius:6px 6px 0 0; }

        /* â•â•â• FOOTER â•â•â• */
        .print-footer { border-top:1px solid #e0d8cc; padding-top:8px; margin-top:16px; display:flex; justify-content:space-between; font-size:7pt; color:#999; }

        /* â•â•â• SIGNATURE â•â•â• */
        .signature-row { display:flex; gap:30px; margin-top:14px; }
        .signature-box { flex:1; }
        .signature-box .sig-label { font-size:8pt; color:#888; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
        .signature-box .sig-line { border-bottom:1px solid #999; height:30px; }

        /* â•â•â• ALERTES â•â•â• */
        .alert-print { padding:6px 10px; border-radius:6px; font-size:9pt; margin-bottom:6px; }
        .alert-print.warning { background:#fef9e7; border-left:3px solid #f39c12; }
        .alert-print.danger { background:#fde8e8; border-left:3px solid #e74c3c; }
        .alert-print.info { background:#eaf2f8; border-left:3px solid #3498db; }

        /* â•â•â• COULEUR SWATCH â•â•â• */
        .color-swatch { width:30px; height:30px; border-radius:4px; border:1px solid #ccc; display:inline-block; vertical-align:middle; margin-right:6px; }

        /* â•â•â• SCREEN CONTROLS â•â•â• */
        .screen-controls { text-align:center; padding:20px; background:#f8f6f1; margin-bottom:20px; border-radius:12px; }
        .screen-controls button { padding:10px 24px; font-size:12pt; border:none; border-radius:8px; cursor:pointer; margin:0 6px; font-weight:600; }
        .btn-print { background:#a32d03; color:#fff; }
        .btn-pdf { background:#27ae60; color:#fff; }
        .btn-save { background:#8e44ad; color:#fff; }

        /* â•â•â• PAGE BREAK â•â•â• */
        .page-break { page-break-before:always; }

        /* â•â•â• PRINT SPECIFICS â•â•â• */
        @media print {
            body { padding:10mm; font-size:10pt; }
            .screen-controls { display:none !important; }
            .print-header { padding-bottom:8px; margin-bottom:12px; }
            table { page-break-inside:avoid; }
            .section { page-break-inside:avoid; }
            @page { margin:8mm; size:A4; }
        }

        @media screen {
            body { max-width:210mm; margin:20px auto; padding:20px; background:#f0ebe3; }
            .print-page { background:#fff; padding:20mm; box-shadow:0 2px 20px rgba(0,0,0,0.1); border-radius:4px; margin-bottom:20px; }
        }
    </style>
<script src="/js/cache-buster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="screen-controls" id="controls">
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Imprimer</button>
        <button class="btn-pdf" onclick="downloadPDF()">ğŸ“¥ TÃ©lÃ©charger PDF</button>
        <button class="btn-save" onclick="saveToApp()">ğŸ’¾ Sauvegarder dans l'appli</button>
        <button class="btn-back" onclick="history.back()">â† Retour</button>
    </div>

    <div id="print-content"></div>

    <script>
    // Metadata du document (rempli par les fonctions render)
    let docMeta = { entity_type: 'divers', entity_id: null, doc_type: 'fiche', filename: 'document' };

    function downloadPDF() {
        const el = document.getElementById('print-content');
        const filename = (docMeta.filename || document.title.replace(/[^a-zA-Z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§\s-]/g, '').trim() || 'MFC-Fiche').replace(/\s+/g, '_') + '.pdf';
        
        const btn = event.target;
        btn.textContent = 'â³ GÃ©nÃ©ration...';
        btn.disabled = true;
        
        html2pdf().set({
            margin: 8,
            filename: filename,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { scale: 2, useCORS: true, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        }).from(el).save().then(() => {
            btn.textContent = 'ğŸ“¥ TÃ©lÃ©charger PDF';
            btn.disabled = false;
        }).catch(err => {
            btn.textContent = 'ğŸ“¥ TÃ©lÃ©charger PDF';
            btn.disabled = false;
            alert('Erreur PDF : ' + err.message);
        });
    }

    async function saveToApp() {
        const btn = event.target;
        btn.textContent = 'â³ Sauvegarde...';
        btn.disabled = true;
        
        try {
            const content = document.getElementById('print-content').innerHTML;
            const operator = localStorage.getItem('mfc_operator') || 'inconnu';
            const opData = JSON.parse(operator);
            
            const res = await fetch('/api/documents/save-pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    entity_type: docMeta.entity_type,
                    entity_id: docMeta.entity_id,
                    doc_type: docMeta.doc_type,
                    filename: docMeta.filename || 'MFC-Document',
                    html_content: `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${document.title}</title>
                        <style>${document.querySelector('style').textContent}</style></head>
                        <body>${content}</body></html>`,
                    generated_by: opData?.name || opData || 'SystÃ¨me'
                })
            });
            const data = await res.json();
            if (data.success) {
                btn.textContent = 'âœ… SauvegardÃ© !';
                btn.style.background = '#27ae60';
                const savedPath = data.save_path || 'mfc-data/documents/';
                btn.title = 'SauvÃ© dans : ' + savedPath;
                setTimeout(() => { btn.textContent = 'ğŸ’¾ Sauvegarder dans l\'appli'; btn.style.background = '#8e44ad'; btn.disabled = false; }, 3000);
            } else {
                throw new Error(data.error || 'Erreur inconnue');
            }
        } catch(e) {
            btn.textContent = 'ğŸ’¾ Sauvegarder dans l\'appli';
            btn.style.background = '#8e44ad';
            btn.disabled = false;
            alert('Erreur sauvegarde : ' + e.message);
        }
    }
    // â•â•â• PARSE URL PARAMS â•â•â•
    const params = new URLSearchParams(location.search);
    const type = params.get('type');   // formulation | test | echantillon | production
    const id = params.get('id');       // ID from DB
    const fromFormulateur = params.get('formulateur'); // JSON data from formulateur

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            if (fromFormulateur) {
                let data;
                if (fromFormulateur === 'local') {
                    const raw = localStorage.getItem('mfc_print_data');
                    if (!raw) throw new Error('DonnÃ©es impression non trouvÃ©es');
                    data = JSON.parse(raw);
                    localStorage.removeItem('mfc_print_data');
                } else {
                    data = JSON.parse(decodeURIComponent(fromFormulateur));
                }
                renderFormulationSheet(data);
            } else if (type === 'formulation' && id) {
                const f = await (await fetch('/api/formulations/' + id)).json();
                renderFormulationFromDB(f);
            } else if (type === 'test' && id) {
                const t = await (await fetch('/api/burn-tests/' + id)).json();
                const f = t.formulation_id ? await (await fetch('/api/formulations/' + t.formulation_id)).json() : null;
                renderTestSheet(t, f);
            } else if (type === 'test-vierge' && id) {
                const f = await (await fetch('/api/formulations/' + id)).json();
                renderBlankTestSheet(f);
            } else if (type === 'echantillon' && id) {
                const s = await (await fetch('/api/samples/' + id)).json();
                renderEchantillonSheet(s);
            } else if (type === 'production' && id) {
                const f = await (await fetch('/api/formulations/' + id)).json();
                renderProductionSheet(f);
            } else {
                document.getElementById('print-content').innerHTML = '<p style="text-align:center;padding:40px;color:#999;">Aucun document Ã  afficher. ParamÃ¨tres manquants.</p>';
            }
        } catch(e) {
            document.getElementById('print-content').innerHTML = '<p style="color:#e74c3c;text-align:center;padding:40px;">Erreur : ' + e.message + '</p>';
        }
    });

    const today = new Date().toLocaleDateString('fr-FR');

    function header(docType, code) {
        return `<div class="print-header">
            <div class="logo">
                <img src="/img/logo-mfc-carre.jpg" alt="MFC">
                <div><h1>MFC LABORATOIRE</h1><div class="sub">Maison FranÃ§aise des Cires Â· MaÃ®tre Cirier depuis 1904</div></div>
            </div>
            <div class="doc-info">
                <div class="doc-type">${docType}</div>
                <div class="doc-code">${code || ''}</div>
                <div>Date : ${today}</div>
            </div>
        </div>`;
    }

    function footer() {
        return `<div class="print-footer">
            <span>MFC Laboratoire â€” Document interne</span>
            <span>ImprimÃ© le ${today}</span>
        </div>`;
    }

    function signatureRow(labels) {
        return `<div class="signature-row">${labels.map(l => `<div class="signature-box"><div class="sig-label">${l}</div><div class="sig-line"></div></div>`).join('')}</div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1. FICHE FORMULATION (depuis formulateur)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderFormulationSheet(data) {
        const f = data.formulation;
        const fds = data.fds;
        const fdsId = fds?.identification || {};
        const parfum = data.fragrance_name || fdsId.nom || 'â€”';
        const ref = data.fragrance_ref || fdsId.code || '';
        const supplier = data.fragrance_supplier || fdsId.fournisseur || '';
        docMeta = { entity_type: 'formulation', entity_id: null, doc_type: 'fiche_formulation', filename: `Formulation_${f.recipe_code || 'FORM'}_${parfum}` };
        document.title = `Fiche Formulation â€” ${parfum}`;

        let html = '<div class="print-page">';
        html += header('Fiche Formulation', f.recipe_code || '');

        // Infos gÃ©nÃ©rales
        html += `<div class="section">
            <div class="section-title">Identification</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Recette</span><span class="info-value">${f.recipe_name || ''} (${f.recipe_code || ''})</span></div>
                <div class="info-item"><span class="info-label">Parfum</span><span class="info-value">${parfum}${ref ? ' [' + ref + ']' : ''}</span></div>
                <div class="info-item"><span class="info-label">Fournisseur</span><span class="info-value">${supplier}</span></div>
                <div class="info-item"><span class="info-label">Type</span><span class="info-value">${data.candle_type || 'container'}</span></div>
                <div class="info-item"><span class="info-label">DiamÃ¨tre</span><span class="info-value">${data.diameter || 'â€”'} mm</span></div>
                <div class="info-item"><span class="info-label">Masse totale</span><span class="info-value">${f.total_mass || 'â€”'} g</span></div>
            </div>
        </div>`;

        // ParamÃ¨tres clÃ©s
        html += `<div class="section">
            <div class="section-title">ParamÃ¨tres de fabrication</div>
            <div class="params-row">
                <div class="param-box"><div class="val">${f.temp_ajout_parfum || 'â€”'}Â°C</div><div class="lbl">Ajout parfum</div></div>
                <div class="param-box"><div class="val">${f.temp_coulage || 'â€”'}Â°C</div><div class="lbl">Coulage</div></div>
                <div class="param-box"><div class="val">${f.cure_hours || 'â€”'}h</div><div class="lbl">Cure minimum</div></div>
                <div class="param-box"><div class="val">${f.fragrance_pct || 'â€”'}%</div><div class="lbl">% Parfum</div></div>
            </div>
        </div>`;

        // Tableau pesÃ©e
        html += `<div class="section">
            <div class="section-title">PesÃ©e des composants</div>
            <table>
                <thead><tr><th>Composant</th><th>RÃ´le</th><th>%</th><th>Masse thÃ©orique</th><th style="width:80px;">PesÃ©e rÃ©elle</th><th class="check-cell">âœ“</th></tr></thead>
                <tbody>`;
        if (f.waxes) {
            f.waxes.forEach(w => {
                html += `<tr><td><strong>${w.name}</strong></td><td style="color:#888;font-size:9pt;">${w.role || ''}</td><td>${w.percentage}%</td><td class="mass-cell">${(w.mass || (w.percentage * f.total_mass / 100)).toFixed(1)} g</td><td class="write-zone" style="min-height:auto;padding:2px 6px;border:1px solid #ccc;"></td><td class="check-cell"><span class="obs-checkbox"></span></td></tr>`;
            });
        }
        html += `<tr style="border-top:2px solid #d4a853;"><td><strong>ğŸŒ¸ Parfum</strong> â€” ${parfum}</td><td style="color:#888;font-size:9pt;">${ref}</td><td>${f.fragrance_pct}%</td><td class="mass-cell">${(f.fragrance_mass || (f.fragrance_pct * f.total_mass / 100)).toFixed(1)} g</td><td class="write-zone" style="min-height:auto;padding:2px 6px;border:1px solid #ccc;"></td><td class="check-cell"><span class="obs-checkbox"></span></td></tr>`;
        html += `<tr><td><strong>ğŸ¨ Colorant</strong></td><td></td><td>${f.colorant_pct}%</td><td class="mass-cell">${f.colorant_mass} g</td><td class="write-zone" style="min-height:auto;padding:2px 6px;border:1px solid #ccc;"></td><td class="check-cell"><span class="obs-checkbox"></span></td></tr>`;
        html += `<tr class="total-row"><td>TOTAL</td><td></td><td>100%</td><td class="mass-cell">${f.total_mass} g</td><td></td><td></td></tr>`;
        html += '</tbody></table></div>';

        // Guide mÃ¨che
        if (f.wick_guide) {
            html += `<div class="section">
                <div class="section-title">Guide mÃ¨che (${f.wick_series || ''})</div>
                <div style="font-size:9pt;white-space:pre-line;background:#fdfbf6;padding:8px 10px;border-radius:6px;border-left:3px solid #d4a853;">${f.wick_guide}</div>
            </div>`;
        }

        // Points d'attention
        if (f.pitfalls) {
            html += `<div class="alert-print warning"><strong>âš ï¸ Points d'attention :</strong> ${f.pitfalls}</div>`;
        }

        // FDS rÃ©sumÃ©
        if (fds?.composition?.length) {
            html += `<div class="section">
                <div class="section-title">FDS Parfum â€” ${fdsId.nom || ''} (${fds.nb_composants || 0} molÃ©cules Â· Flash ${fds.proprietes_physiques?.flash_point_c || '?'}Â°C)</div>
                <div style="font-size:8pt;color:#666;">Principales molÃ©cules : ${fds.composition.slice(0,6).map(m => m.nom_chimique + ' ' + m.concentration + '%').join(' Â· ')}</div>
            </div>`;
        }

        // Zone notes
        html += `<div class="section">
            <div class="section-title">Notes & observations</div>
            <div class="write-lines tall"></div>
        </div>`;

        html += signatureRow(['FormulÃ© par', 'Date / Heure', 'VÃ©rifiÃ© par']);
        html += footer();
        html += '</div>';

        document.getElementById('print-content').innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1b. FICHE FORMULATION (depuis BDD)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderFormulationFromDB(f) {
        docMeta = { entity_type: 'formulation', entity_id: f.id, doc_type: 'fiche_formulation', filename: `Formulation_${f.code}_${f.fragrance_name || ''}` };
        document.title = `Fiche Formulation â€” ${f.code}`;
        let html = '<div class="print-page">';
        html += header('Fiche Formulation', f.code);

        html += `<div class="section">
            <div class="section-title">Identification</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Code</span><span class="info-value">${f.code}</span></div>
                <div class="info-item"><span class="info-label">Nom</span><span class="info-value">${f.name}</span></div>
                <div class="info-item"><span class="info-label">Parfum</span><span class="info-value">${f.fragrance_name || 'â€”'}${f.fragrance_ref ? ' [' + f.fragrance_ref + ']' : ''}</span></div>
                <div class="info-item"><span class="info-label">Fournisseur</span><span class="info-value">${f.fragrance_supplier || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">Client</span><span class="info-value">${f.client_name || 'â€”'}${f.client_company ? ' â€” ' + f.client_company : ''}</span></div>
                <div class="info-item"><span class="info-label">Type</span><span class="info-value">${f.container_type || 'container'} Â· ${f.diameter || 'â€”'}Ã—${f.height || 'â€”'}mm</span></div>
                <div class="info-item"><span class="info-label">Masse totale</span><span class="info-value">${f.total_mass} g</span></div>
                <div class="info-item"><span class="info-label">MÃ¨che</span><span class="info-value">${f.wick_reference || 'â€”'}</span></div>
            </div>
        </div>`;

        // Couleur
        if (f.pantone_hex) {
            html += `<div class="info-item" style="margin-bottom:10px;"><span class="info-label">Couleur</span><span class="color-swatch" style="background:${f.pantone_hex};"></span><span class="info-value">${f.pantone_code || ''} ${f.pantone_hex}</span></div>`;
        }

        // ParamÃ¨tres
        html += `<div class="section">
            <div class="section-title">ParamÃ¨tres de fabrication</div>
            <div class="params-row">
                <div class="param-box"><div class="val">${f.temp_ajout_parfum || 'â€”'}Â°C</div><div class="lbl">Ajout parfum</div></div>
                <div class="param-box"><div class="val">${f.temp_coulage || 'â€”'}Â°C</div><div class="lbl">Coulage</div></div>
                <div class="param-box"><div class="val">${f.fragrance_percentage || 'â€”'}%</div><div class="lbl">% Parfum</div></div>
            </div>
        </div>`;

        // Tableau pesÃ©e
        html += `<div class="section">
            <div class="section-title">PesÃ©e des composants</div>
            <table>
                <thead><tr><th>Composant</th><th>RÃ©f.</th><th>%</th><th>Masse thÃ©orique</th><th style="width:80px;">PesÃ©e rÃ©elle</th><th class="check-cell">âœ“</th></tr></thead>
                <tbody>`;
        if (f.waxes) {
            f.waxes.forEach(w => {
                html += `<tr><td><strong>${w.wax_name || w.name}</strong>${w.supplier_name ? '<br><span style="font-size:8pt;color:#888;">' + w.supplier_name + '</span>' : ''}</td><td style="font-size:9pt;">${w.reference || ''}</td><td>${w.percentage}%</td><td class="mass-cell">${(w.mass || (w.percentage * f.total_mass / 100)).toFixed(1)} g</td><td style="border:1px solid #ccc;min-width:60px;"></td><td class="check-cell"><span class="obs-checkbox"></span></td></tr>`;
            });
        }
        html += `<tr style="border-top:2px solid #d4a853;"><td><strong>ğŸŒ¸ Parfum</strong> â€” ${f.fragrance_name || 'â€”'}</td><td>${f.fragrance_ref || ''}</td><td>${f.fragrance_percentage || 'â€”'}%</td><td class="mass-cell">${(f.fragrance_mass || (f.fragrance_percentage * f.total_mass / 100)).toFixed(1)} g</td><td style="border:1px solid #ccc;"></td><td class="check-cell"><span class="obs-checkbox"></span></td></tr>`;
        html += `<tr><td><strong>ğŸ¨ Colorant</strong></td><td></td><td></td><td class="mass-cell">${f.colorant_mass ? f.colorant_mass.toFixed(1) : 'â€”'} g</td><td style="border:1px solid #ccc;"></td><td class="check-cell"><span class="obs-checkbox"></span></td></tr>`;
        html += `<tr class="total-row"><td>TOTAL</td><td></td><td>100%</td><td class="mass-cell">${f.total_mass} g</td><td></td><td></td></tr>`;
        html += '</tbody></table></div>';

        // Notes
        html += `<div class="section">
            <div class="section-title">Notes</div>
            <div style="font-size:9pt;white-space:pre-line;margin-bottom:6px;">${f.notes || ''}</div>
            <div class="write-lines tall"></div>
        </div>`;

        html += signatureRow(['FormulÃ© par', 'Date / Heure', 'VÃ©rifiÃ© par']);
        html += footer();
        html += '</div>';
        document.getElementById('print-content').innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2. FICHE TEST DE COMBUSTION (vierge)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderBlankTestSheet(f) {
        docMeta = { entity_type: 'formulation', entity_id: f.id, doc_type: 'fiche_test_vierge', filename: `Test_vierge_${f.code}` };
        document.title = `Fiche Test Vierge â€” ${f.code}`;
        let html = '<div class="print-page">';
        html += header('Fiche Test de Combustion', f.code);

        // â”€â”€ BLOC 1 : Identification complÃ¨te â”€â”€
        html += `<div class="section">
            <div class="section-title">Identification</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Code formulation</span><span class="info-value">${f.code}</span></div>
                <div class="info-item"><span class="info-label">Nom</span><span class="info-value">${f.name}</span></div>
                <div class="info-item"><span class="info-label">Client</span><span class="info-value">${f.client_name || 'â€”'}${f.client_company ? ' â€” ' + f.client_company : ''}</span></div>
                <div class="info-item"><span class="info-label">Ã‰chantillon</span><span class="info-value">${f.sample_number || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">Version</span><span class="info-value">V${f.version || 1}</span></div>
                <div class="info-item"><span class="info-label">Statut</span><span class="info-value">${f.status || 'en_cours'}</span></div>
            </div>
        </div>`;

        // â”€â”€ BLOC 2 : Parfum (complet) â”€â”€
        html += `<div class="section">
            <div class="section-title">Parfum</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Nom parfum</span><span class="info-value" style="color:#a32d03;font-size:11pt;">${f.fragrance_name || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">RÃ©fÃ©rence</span><span class="info-value">${f.fragrance_ref || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">Fournisseur</span><span class="info-value">${f.fragrance_supplier || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">Pourcentage</span><span class="info-value">${f.fragrance_percentage || 'â€”'}%</span></div>
                <div class="info-item"><span class="info-label">Masse parfum</span><span class="info-value">${f.fragrance_mass ? f.fragrance_mass.toFixed(1) : 'â€”'} g</span></div>
                <div class="info-item"><span class="info-label">Flash point</span><span class="info-value">${f.flash_point || 'â€”'}Â°C</span></div>
            </div>
        </div>`;

        // â”€â”€ BLOC 3 : SpÃ©cifications bougie â”€â”€
        html += `<div class="section">
            <div class="section-title">SpÃ©cifications bougie</div>
            <div class="info-grid four">
                <div class="info-item"><span class="info-label">Type</span><span class="info-value">${f.container_type || 'container'}</span></div>
                <div class="info-item"><span class="info-label">DiamÃ¨tre</span><span class="info-value">${f.diameter || 'â€”'} mm</span></div>
                <div class="info-item"><span class="info-label">Hauteur</span><span class="info-value">${f.height || 'â€”'} mm</span></div>
                <div class="info-item"><span class="info-label">Masse totale</span><span class="info-value">${f.total_mass} g</span></div>
            </div>
        </div>`;

        // â”€â”€ BLOC 4 : Couleur â”€â”€
        if (f.pantone_hex || f.pantone_code) {
            html += `<div class="section">
                <div class="section-title">Couleur</div>
                <div class="info-item">${f.pantone_hex ? '<span class="color-swatch" style="background:' + f.pantone_hex + ';"></span>' : ''}<span class="info-value">${f.pantone_code || ''} ${f.pantone_hex || ''}</span></div>
            </div>`;
        }

        // â”€â”€ BLOC 5 : Composition complÃ¨te â”€â”€
        html += `<div class="section">
            <div class="section-title">Composition</div>
            <table>
                <thead><tr><th>Composant</th><th>RÃ©f.</th><th>%</th><th>Masse</th></tr></thead>
                <tbody>`;
        if (f.waxes) {
            f.waxes.forEach(w => {
                html += `<tr><td><strong>${w.wax_name || w.name}</strong>${w.supplier_name ? ' <span style="font-size:8pt;color:#888;">(' + w.supplier_name + ')</span>' : ''}</td><td style="font-size:9pt;">${w.reference || ''}</td><td>${w.percentage}%</td><td class="mass-cell">${(w.mass || (w.percentage * f.total_mass / 100)).toFixed(1)} g</td></tr>`;
            });
        }
        html += `<tr style="border-top:2px solid #d4a853;"><td><strong>ğŸŒ¸ Parfum</strong> â€” ${f.fragrance_name || 'â€”'}</td><td>${f.fragrance_ref || ''}</td><td>${f.fragrance_percentage || 'â€”'}%</td><td class="mass-cell">${(f.fragrance_mass || (f.fragrance_percentage * f.total_mass / 100)).toFixed(1)} g</td></tr>`;
        if (f.colorant_mass) {
            html += `<tr><td><strong>ğŸ¨ Colorant</strong></td><td></td><td></td><td class="mass-cell">${f.colorant_mass.toFixed(1)} g</td></tr>`;
        }
        html += `<tr class="total-row"><td>TOTAL</td><td></td><td>100%</td><td class="mass-cell">${f.total_mass} g</td></tr>`;
        html += '</tbody></table></div>';

        // â”€â”€ BLOC 6 : MÃ¨che + ParamÃ¨tres â”€â”€
        html += `<div class="section">
            <div class="section-title">MÃ¨che & ParamÃ¨tres</div>
            <div class="params-row">
                <div class="param-box"><div class="val">${f.wick_reference || 'â€”'}</div><div class="lbl">MÃ¨che</div></div>
                <div class="param-box"><div class="val">${f.temp_ajout_parfum || 'â€”'}Â°C</div><div class="lbl">TÂ° ajout parfum</div></div>
                <div class="param-box"><div class="val">${f.temp_coulage || 'â€”'}Â°C</div><div class="lbl">TÂ° coulage</div></div>
                <div class="param-box"><div class="val">${f.fragrance_percentage || 'â€”'}%</div><div class="lbl">% Parfum</div></div>
            </div>
        </div>`;

        // â”€â”€ BLOC 7 : Infos test Ã  remplir â”€â”€
        html += `<div class="section" style="background:#fdfbf6;padding:10px;border-radius:8px;border:1.5px solid #d4a853;">
            <div class="section-title" style="color:#a32d03;">Ã€ remplir par l'opÃ©rateur</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">NÂ° test</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:140px;">&nbsp;</span></div>
                <div class="info-item"><span class="info-label">Masse initiale</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:80px;">&nbsp;</span> g</div>
                <div class="info-item"><span class="info-label">Date dÃ©but</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:100px;">&nbsp;</span></div>
                <div class="info-item"><span class="info-label">MÃ¨che utilisÃ©e</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:120px;">&nbsp;</span></div>
                <div class="info-item"><span class="info-label">TÂ° ambiante</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:60px;">&nbsp;</span> Â°C</div>
                <div class="info-item"><span class="info-label">OpÃ©rateur</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:120px;">&nbsp;</span></div>
            </div>
        </div>`;

        // â”€â”€ BLOC 8 : Cycles de combustion â”€â”€
        for (let c = 1; c <= 4; c++) {
            if (c === 3) html += '<div class="page-break"></div>';
            html += `<div class="section">
                <div class="cycle-header">Cycle ${c} â€” 4 heures</div>
                <table>
                    <thead><tr>
                        <th style="width:40%;">Mesure</th><th style="width:25%;">Valeur</th><th>Notes / Observations</th>
                    </tr></thead>
                    <tbody>
                        <tr><td>Heure allumage</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                        <tr><td>Heure extinction</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                        <tr><td>DurÃ©e rÃ©elle (min)</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                        <tr><td>Masse avant (g)</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                        <tr><td>Masse aprÃ¨s (g)</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                        <tr><td><strong>Masse consommÃ©e (g)</strong></td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                        <tr><td>Ã˜ bain de fusion (mm)</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;">Ã˜ contenant : ${f.diameter || 'â€”'} mm</td></tr>
                        <tr><td>Profondeur bain (mm)</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                        <tr><td>Hauteur flamme (mm)</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                        <tr><td>TÂ° surface contenant (Â°C)</td><td style="border:1px solid #ccc;"></td><td style="border:1px solid #ccc;"></td></tr>
                    </tbody>
                </table>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-top:6px;margin-bottom:4px;">
                    <div class="obs-item">
                        <div class="name">Flamme</div>
                        <div style="font-size:7pt;line-height:1.4;">â˜ stable<br>â˜ agitÃ©e<br>â˜ trop haute<br>â˜ trop basse</div>
                    </div>
                    <div class="obs-item">
                        <div class="name">FumÃ©e</div>
                        <div style="font-size:7pt;line-height:1.4;">â˜ aucune<br>â˜ lÃ©gÃ¨re<br>â˜ modÃ©rÃ©e<br>â˜ forte</div>
                    </div>
                    <div class="obs-item">
                        <div class="name">Suie</div>
                        <div style="font-size:7pt;line-height:1.4;">â˜ aucune<br>â˜ lÃ©gÃ¨re<br>â˜ contenant noirci<br>â˜ forte</div>
                    </div>
                    <div class="obs-item">
                        <div class="name">Champignon</div>
                        <div style="font-size:7pt;line-height:1.4;">â˜ aucun<br>â˜ lÃ©ger<br>â˜ modÃ©rÃ©<br>â˜ important</div>
                    </div>
                    <div class="obs-item">
                        <div class="name">Diffusion</div>
                        <div style="font-size:7pt;line-height:1.4;">â˜ nulle<br>â˜ faible<br>â˜ moyenne<br>â˜ forte</div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:4px;">
                    <div class="obs-item"><div class="name">Tunneling</div><div style="font-size:7pt;">â˜ oui â˜ non</div></div>
                    <div class="obs-item"><div class="name">Surface</div><div style="font-size:7pt;">â˜ lisse â˜ irrÃ©guliÃ¨re</div></div>
                    <div class="obs-item"><div class="name">Retrait</div><div style="font-size:7pt;">â˜ oui â˜ non</div></div>
                    <div class="obs-item"><div class="name">Odeur Ã  froid</div><div style="font-size:7pt;">â˜ faible â˜ moyenne â˜ forte</div></div>
                </div>
                <div style="font-size:8pt;font-weight:600;margin-top:6px;margin-bottom:2px;">Observations libres :</div>
                <div class="write-lines" style="min-height:44px;"></div>
            </div>`;
        }

        // â”€â”€ BLOC 9 : Masse finale + Calculs â”€â”€
        html += `<div class="section">
            <div class="section-title">Bilan</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Masse finale (g)</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:80px;">&nbsp;</span></div>
                <div class="info-item"><span class="info-label">Masse totale consommÃ©e (g)</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:80px;">&nbsp;</span></div>
                <div class="info-item"><span class="info-label">DurÃ©e totale combustion</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:80px;">&nbsp;</span> h</div>
                <div class="info-item"><span class="info-label">Consommation / heure</span><span class="info-value" style="border-bottom:1.5px solid #a32d03;min-width:80px;">&nbsp;</span> g/h</div>
            </div>
        </div>`;

        // â”€â”€ BLOC 10 : Conclusion â”€â”€
        html += `<div class="section">
            <div class="section-title">Conclusion</div>
            <div style="display:flex;gap:20px;margin-bottom:10px;font-size:11pt;">
                <label>â˜ <strong style="color:#27ae60;">ValidÃ©</strong> â€” prÃªt pour production</label>
                <label>â˜ <strong style="color:#f39c12;">Ã€ reprendre</strong> â€” ajustement nÃ©cessaire</label>
                <label>â˜ <strong style="color:#e74c3c;">RejetÃ©</strong></label>
            </div>
            <div style="font-size:8pt;font-weight:600;margin-bottom:2px;">Si Ã  reprendre, modifications Ã  apporter :</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;">
                <div class="info-item"><span class="info-label">MÃ¨che</span><span style="border-bottom:1px solid #ccc;flex:1;">&nbsp;</span></div>
                <div class="info-item"><span class="info-label">% Parfum</span><span style="border-bottom:1px solid #ccc;flex:1;">&nbsp;</span></div>
                <div class="info-item"><span class="info-label">Cire</span><span style="border-bottom:1px solid #ccc;flex:1;">&nbsp;</span></div>
                <div class="info-item"><span class="info-label">Autre</span><span style="border-bottom:1px solid #ccc;flex:1;">&nbsp;</span></div>
            </div>
            <div style="font-size:8pt;font-weight:600;margin-bottom:2px;">Commentaire final :</div>
            <div class="write-lines tall"></div>
        </div>`;

        html += signatureRow(['TestÃ© par', 'Date fin test', 'ValidÃ© par']);
        html += footer();
        html += '</div>';
        document.getElementById('print-content').innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2b. FICHE TEST (remplie depuis BDD)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderTestSheet(t, f) {
        docMeta = { entity_type: 'burn_test', entity_id: t.id, doc_type: 'fiche_test', filename: `Test_${t.test_number}` };
        document.title = `Fiche Test â€” ${t.test_number}`;
        // MÃªme structure que vierge mais prÃ©-rempli
        if (f) renderBlankTestSheet(f);
        else {
            let html = '<div class="print-page">';
            html += header('Fiche Test de Combustion', t.test_number);
            html += '<p>Test ' + t.test_number + ' â€” DonnÃ©es disponibles dans l\'application</p>';
            html += footer() + '</div>';
            document.getElementById('print-content').innerHTML = html;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3. FICHE Ã‰CHANTILLON CLIENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderEchantillonSheet(s) {
        docMeta = { entity_type: 'sample', entity_id: s.id, doc_type: 'fiche_echantillon', filename: `Echantillon_${s.sample_number}` };
        document.title = `Fiche Ã‰chantillon â€” ${s.sample_number}`;
        let html = '<div class="print-page">';
        html += header('Fiche Ã‰chantillon', s.sample_number);

        html += `<div class="section">
            <div class="section-title">Identification</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">NÂ° Ã‰chantillon</span><span class="info-value">${s.sample_number}</span></div>
                <div class="info-item"><span class="info-label">Statut</span><span class="info-value">${s.status || 'demande'}</span></div>
                <div class="info-item"><span class="info-label">Client</span><span class="info-value">${s.client_name || 'â€”'}${s.client_company ? ' â€” ' + s.client_company : ''}</span></div>
                <div class="info-item"><span class="info-label">Date demande</span><span class="info-value">${s.date_request || s.created_at?.split('T')[0] || today}</span></div>
            </div>
        </div>`;

        // Demande
        html += `<div class="section">
            <div class="section-title">Demande client</div>
            <div style="background:#fdfbf6;padding:10px;border-radius:6px;font-size:10pt;min-height:40px;">${s.client_request || 'â€”'}</div>
        </div>`;

        // SpÃ©cifications
        html += `<div class="section">
            <div class="section-title">SpÃ©cifications bougie</div>
            <div class="info-grid four">
                <div class="info-item"><span class="info-label">Type</span><span class="info-value">${s.candle_type || 'container'}</span></div>
                <div class="info-item"><span class="info-label">DiamÃ¨tre</span><span class="info-value">${s.diameter || 'â€”'} mm</span></div>
                <div class="info-item"><span class="info-label">Hauteur</span><span class="info-value">${s.height || 'â€”'} mm</span></div>
                <div class="info-item"><span class="info-label">Masse</span><span class="info-value">${s.total_mass || 'â€”'} g</span></div>
            </div>
        </div>`;

        // Parfum
        html += `<div class="section">
            <div class="section-title">Parfum</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Nom</span><span class="info-value">${s.fragrance_name || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">RÃ©fÃ©rence</span><span class="info-value">${s.fragrance_ref || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">Fournisseur</span><span class="info-value">${s.fragrance_supplier || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">Pourcentage</span><span class="info-value">${s.fragrance_percentage || 'â€”'}%</span></div>
            </div>
        </div>`;

        // Couleur
        if (s.pantone_hex || s.pantone_code) {
            html += `<div class="section">
                <div class="section-title">Couleur</div>
                ${s.pantone_hex ? '<span class="color-swatch" style="background:' + s.pantone_hex + ';"></span>' : ''}
                <span>${s.pantone_code || ''} ${s.pantone_hex || ''}</span>
            </div>`;
        }

        // Zone actions labo
        html += `<div class="section">
            <div class="section-title">Actions laboratoire</div>
            <div class="write-lines tall"></div>
        </div>`;

        // Notes
        html += `<div class="section">
            <div class="section-title">Notes</div>
            <div style="font-size:9pt;white-space:pre-line;margin-bottom:6px;">${s.notes || ''}</div>
            <div class="write-lines"></div>
        </div>`;

        html += signatureRow(['Pris en charge par', 'Date', 'ValidÃ© par']);
        html += footer();
        html += '</div>';
        document.getElementById('print-content').innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4. BON DE PRODUCTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderProductionSheet(f) {
        docMeta = { entity_type: 'formulation', entity_id: f.id, doc_type: 'bon_production', filename: `Production_${f.code}` };
        document.title = `Bon de Production â€” ${f.code}`;
        let html = '<div class="print-page">';
        html += header('Bon de Production', f.code);

        html += `<div class="alert-print info" style="text-align:center;font-weight:700;font-size:11pt;">FORMULATION VALIDÃ‰E â€” PrÃªte pour production</div>`;

        html += `<div class="section">
            <div class="section-title">Identification</div>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Code</span><span class="info-value">${f.code}</span></div>
                <div class="info-item"><span class="info-label">Nom</span><span class="info-value">${f.name}</span></div>
                <div class="info-item"><span class="info-label">Client</span><span class="info-value">${f.client_name || 'â€”'}${f.client_company ? ' â€” ' + f.client_company : ''}</span></div>
                <div class="info-item"><span class="info-label">Parfum</span><span class="info-value">${f.fragrance_name || 'â€”'}${f.fragrance_ref ? ' [' + f.fragrance_ref + ']' : ''}</span></div>
                <div class="info-item"><span class="info-label">Fournisseur parfum</span><span class="info-value">${f.fragrance_supplier || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">Type contenant</span><span class="info-value">${f.container_type || 'container'} Â· ${f.diameter || 'â€”'}Ã—${f.height || 'â€”'}mm</span></div>
                <div class="info-item"><span class="info-label">MÃ¨che</span><span class="info-value">${f.wick_reference || 'â€”'}</span></div>
                <div class="info-item"><span class="info-label">Version</span><span class="info-value">V${f.version || 1}</span></div>
            </div>
        </div>`;

        // Couleur
        if (f.pantone_hex) {
            html += `<div class="info-item" style="margin-bottom:10px;"><span class="info-label">Couleur</span><span class="color-swatch" style="background:${f.pantone_hex};"></span><span class="info-value">${f.pantone_code || ''} ${f.pantone_hex}</span></div>`;
        }

        // Tableau production â€” avec colonne x10 et x50
        html += `<div class="section">
            <div class="section-title">Formule de production</div>
            <table>
                <thead><tr><th>Composant</th><th>RÃ©f.</th><th>%</th><th>Ã—1 (${f.total_mass}g)</th><th>Ã—10 (${(f.total_mass*10/1000).toFixed(1)}kg)</th><th>Ã—50 (${(f.total_mass*50/1000).toFixed(1)}kg)</th></tr></thead>
                <tbody>`;
        if (f.waxes) {
            f.waxes.forEach(w => {
                const m1 = w.mass ? w.mass : (w.percentage * f.total_mass / 100);
                html += `<tr><td><strong>${w.wax_name || w.name}</strong></td><td style="font-size:9pt;">${w.reference || ''}</td><td>${w.percentage}%</td><td class="mass-cell">${m1.toFixed(1)} g</td><td class="mass-cell">${(m1*10).toFixed(0)} g</td><td class="mass-cell">${(m1*50/1000).toFixed(2)} kg</td></tr>`;
            });
        }
        const fm = f.fragrance_mass || (f.fragrance_percentage * f.total_mass / 100);
        html += `<tr style="border-top:2px solid #d4a853;"><td><strong>ğŸŒ¸ Parfum</strong></td><td>${f.fragrance_ref || ''}</td><td>${f.fragrance_percentage}%</td><td class="mass-cell">${fm.toFixed(1)} g</td><td class="mass-cell">${(fm*10).toFixed(0)} g</td><td class="mass-cell">${(fm*50/1000).toFixed(2)} kg</td></tr>`;
        if (f.colorant_mass) {
            html += `<tr><td><strong>ğŸ¨ Colorant</strong></td><td></td><td></td><td class="mass-cell">${f.colorant_mass.toFixed(1)} g</td><td class="mass-cell">${(f.colorant_mass*10).toFixed(0)} g</td><td class="mass-cell">${(f.colorant_mass*50/1000).toFixed(2)} kg</td></tr>`;
        }
        html += `<tr class="total-row"><td>TOTAL</td><td></td><td>100%</td><td class="mass-cell">${f.total_mass} g</td><td class="mass-cell">${(f.total_mass*10/1000).toFixed(1)} kg</td><td class="mass-cell">${(f.total_mass*50/1000).toFixed(1)} kg</td></tr>`;
        html += '</tbody></table></div>';

        // Instructions
        html += `<div class="section">
            <div class="section-title">Instructions de fabrication</div>
            <div style="font-size:9pt;line-height:1.8;">
                1. Faire fondre les cires Ã  tempÃ©rature adaptÃ©e<br>
                2. Ajouter le parfum Ã  <strong>${f.temp_ajout_parfum || 'â€”'}Â°C</strong> â€” mÃ©langer 2 min<br>
                3. Ajouter le colorant â€” mÃ©langer jusqu'Ã  homogÃ©nÃ©itÃ©<br>
                4. Couler Ã  <strong>${f.temp_coulage || 'â€”'}Â°C</strong><br>
                5. Laisser refroidir Ã  tempÃ©rature ambiante<br>
                6. Cure minimum : <strong>${f.cure_hours || '48'}h</strong>
            </div>
        </div>`;

        // Notes
        if (f.notes) {
            html += `<div class="section"><div class="section-title">Notes</div><div style="font-size:9pt;white-space:pre-line;">${f.notes}</div></div>`;
        }

        html += signatureRow(['Responsable production', 'Date', 'ContrÃ´le qualitÃ©']);
        html += footer();
        html += '</div>';
        document.getElementById('print-content').innerHTML = html;
    }
    </script>
</body>
</html>
