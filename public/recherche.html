<!DOCTYPE html>
<html lang="fr">
<head>
<style id="mfc-auth-wall">body{visibility:hidden!important;}</style>
<script>try{if(localStorage.getItem("mfc_operator"))document.getElementById("mfc-auth-wall").remove();}catch(e){}</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFC Lab ‚Äî Recherche & Veille</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .research-tabs { display: flex; gap: 0; border-bottom: 2px solid #e0d5c7; margin-bottom: 1.5rem; }
        .research-tab { padding: 0.8rem 1.5rem; cursor: pointer; border: none; background: none; font-size: 0.95rem; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .research-tab.active { color: #a32d03; border-bottom-color: #a32d03; font-weight: 600; }
        .research-tab:hover { color: #a32d03; background: #fef9f3; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        
        .search-bar { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .search-bar input { flex: 1; padding: 0.8rem 1rem; border: 1px solid #d4c5b0; border-radius: 8px; font-size: 0.95rem; }
        .search-bar button { padding: 0.8rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-search { background: #a32d03; color: #fff; }
        .btn-search:hover { background: #8a2503; }
        
        .result-card { background: #fff; border: 1px solid #e8e0d5; border-radius: 10px; padding: 1.2rem; margin-bottom: 1rem; transition: all 0.2s; }
        .result-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .result-title { font-weight: 600; color: #1a1a1a; margin-bottom: 0.3rem; font-size: 1rem; }
        .result-meta { font-size: 0.8rem; color: #888; margin-bottom: 0.5rem; }
        .result-abstract { font-size: 0.88rem; color: #444; line-height: 1.5; margin-bottom: 0.8rem; }
        .result-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn-import { background: #e8f5e9; color: #2e7d32; padding: 0.4rem 0.8rem; border-radius: 6px; border: none; font-size: 0.78rem; cursor: pointer; }
        .btn-import:hover { background: #c8e6c9; }
        .btn-link { background: #e3f2fd; color: #1565c0; text-decoration: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.78rem; }
        .btn-link:hover { background: #bbdefb; }
        .btn-extract { background: #fff3e0; color: #e65100; padding: 0.4rem 0.8rem; border-radius: 6px; border: none; font-size: 0.78rem; cursor: pointer; }
        .btn-extract:hover { background: #ffe0b2; }
        
        .molecule-card { background: #fff; border: 1px solid #e8e0d5; border-radius: 10px; padding: 1rem; margin-bottom: 0.8rem; }
        .molecule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .molecule-name { font-weight: 600; color: #1a1a1a; }
        .molecule-cas { font-size: 0.8rem; color: #a32d03; font-family: monospace; }
        .molecule-props { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; }
        .mol-prop { font-size: 0.82rem; padding: 0.3rem 0.5rem; background: #fef9f3; border-radius: 4px; }
        .mol-prop-label { font-size: 0.7rem; color: #888; display: block; }
        .mol-prop-value { font-weight: 600; color: #333; }
        
        .import-area textarea { width: 100%; min-height: 200px; border: 1px solid #e0d5c7; border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 0.85rem; resize: vertical; }
        
        .extraction-results { background: #f5f0e8; border-radius: 10px; padding: 1.2rem; }
        .extraction-section { margin-bottom: 1rem; }
        .extraction-section h4 { font-size: 0.9rem; color: #a32d03; margin-bottom: 0.5rem; }
        .tag { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.78rem; margin: 0.2rem; }
        .tag-cas { background: #e3f2fd; color: #1565c0; }
        .tag-mol { background: #e8f5e9; color: #2e7d32; }
        .tag-warn { background: #ffebee; color: #c62828; }
        .tag-allergen { background: #fff3e0; color: #e65100; }
        .tag-bp { background: #f3e5f5; color: #6a1b9a; }
        
        .stats-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .stat-mini { background: #fff; border: 1px solid #e8e0d5; border-radius: 8px; padding: 0.6rem 1rem; text-align: center; min-width: 80px; }
        .stat-mini-value { font-size: 1.3rem; font-weight: 700; color: #a32d03; }
        .stat-mini-label { font-size: 0.7rem; color: #888; }
        
        .loading { text-align: center; padding: 2rem; color: #888; }
        
        .ai-response { background: #fff; border: 1px solid #e0d5c7; border-radius: 10px; padding: 1.5rem; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.6; }
        .ai-badge { display: inline-block; background: #a32d03; color: #fff; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.7rem; margin-bottom: 0.5rem; }
        
        .filter-chips { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .chip { padding: 0.3rem 0.8rem; border-radius: 16px; font-size: 0.78rem; cursor: pointer; border: 1px solid #d4c5b0; background: #fff; transition: all 0.2s; }
        .chip.active { background: #a32d03; color: #fff; border-color: #a32d03; }
    </style>
    <script src="js/theme-toggle.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="img/logo-mfc-carre.jpg" alt="MFC">
            <div class="brand-text"><h1>LABORATOIRE</h1><span>Recherche & Veille</span></div>
        </div>
        <div class="navbar-menu">
            <a href="index.html">Accueil</a>
            <a href="echantillons.html">√âchantillons</a>
            <a href="formulations.html">Formulations</a>
            <a href="tests.html">Tests</a>
            <a href="matieres.html">Mati√®res</a>
            <a href="recettes.html">Recettes</a>
            <a href="connaissances.html">Connaissances</a>
            <a href="fds.html">FDS Parfums</a>
            <a href="formulateur.html">Formulateur</a>
            <a href="recherche.html" class="active">Recherche</a>
            <a href="analytics.html">üìä Analytics</a>
            <a href="molecules.html">üß¨ Mol√©cules</a>
            <a href="predictif.html">üîÆ Pr√©dictif</a>
            <a href="clients.html">Clients</a>
            <a href="operateurs.html">Op√©rateurs</a>
        </div>
    </nav>

    <div class="container">
        <h1 style="margin-bottom:0.3rem;">üî¨ Recherche & Veille Scientifique</h1>
        <p style="color:#888;margin-bottom:1.5rem;font-size:0.9rem;">Enrichissez la base de connaissances MFC avec les derni√®res √©tudes</p>

        <!-- Stats -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-mini"><div class="stat-mini-value" id="statMolecules">-</div><div class="stat-mini-label">Mol√©cules connues</div></div>
            <div class="stat-mini"><div class="stat-mini-value" id="statKB">-</div><div class="stat-mini-label">Fiches KB</div></div>
            <div class="stat-mini"><div class="stat-mini-value" id="statAllergens">-</div><div class="stat-mini-label">Allerg√®nes IFRA</div></div>
            <div class="stat-mini"><div class="stat-mini-value" id="statSources">-</div><div class="stat-mini-label">Sources</div></div>
        </div>

        <!-- Tabs -->
        <div class="research-tabs">
            <button class="research-tab active" data-tab="pubmed">üìö PubMed</button>
            <button class="research-tab" data-tab="molecules">üß™ Mol√©cules</button>
            <button class="research-tab" data-tab="import">üìã Import texte</button>
            <button class="research-tab" data-tab="ai">ü§ñ Recherche IA</button>
        </div>

        <!-- TAB: PubMed -->
        <div class="tab-panel active" id="tab-pubmed">
            <div class="search-bar">
                <input type="text" id="pubmedQuery" placeholder="Ex: fragrance evaporation candle wax boiling point..." 
                       onkeypress="if(event.key==='Enter')searchPubMed()">
                <button class="btn-search" onclick="searchPubMed()">üîç Chercher</button>
            </div>
            <div class="filter-chips">
                <span class="chip active" onclick="addPubMedFilter(this,'candle')">üïØÔ∏è Candle</span>
                <span class="chip" onclick="addPubMedFilter(this,'fragrance')">üå∏ Fragrance</span>
                <span class="chip" onclick="addPubMedFilter(this,'wax')">üßä Wax</span>
                <span class="chip" onclick="addPubMedFilter(this,'olfactory')">üëÉ Olfactory</span>
                <span class="chip" onclick="addPubMedFilter(this,'essential oil')">üåø Essential oil</span>
                <span class="chip" onclick="addPubMedFilter(this,'combustion')">üî• Combustion</span>
                <span class="chip" onclick="addPubMedFilter(this,'volatile compounds')">üí® Volatile</span>
            </div>
            <div id="pubmedResults"></div>
        </div>

        <!-- TAB: Molecules (PubChem + local DB) -->
        <div class="tab-panel" id="tab-molecules">
            <div class="search-bar">
                <input type="text" id="moleculeQuery" placeholder="Nom ou CAS... Ex: linalool, 78-70-6, vanilline" 
                       onkeypress="if(event.key==='Enter')searchMolecule()">
                <button class="btn-search" onclick="searchMolecule()">üîç Chercher</button>
            </div>
            <h3 style="font-size:0.95rem;color:#666;margin-bottom:0.8rem;">Base de mol√©cules MFC :</h3>
            <div id="moleculeResults"></div>
        </div>

        <!-- TAB: Import texte -->
        <div class="tab-panel" id="tab-import">
            <p style="font-size:0.9rem;color:#666;margin-bottom:1rem;">
                Collez un texte (article, FDS, page web, notes) et le syst√®me extrait automatiquement les donn√©es exploitables.
            </p>
            <div class="import-area">
                <textarea id="importText" placeholder="Collez ici le contenu d'une FDS, d'un article scientifique, d'une page web...&#10;&#10;Le syst√®me d√©tecte automatiquement :&#10;‚Ä¢ Num√©ros CAS&#10;‚Ä¢ Noms de mol√©cules&#10;‚Ä¢ Points d'√©bullition (Bp)&#10;‚Ä¢ Masses mol√©culaires (Mw)&#10;‚Ä¢ Points √©clair&#10;‚Ä¢ Pourcentages&#10;‚Ä¢ Allerg√®nes IFRA&#10;‚Ä¢ Solvants probl√©matiques (DPG, PG)"></textarea>
            </div>
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;">
                <input type="text" id="importSource" placeholder="Source (URL ou titre)" style="flex:1;padding:0.6rem;border:1px solid #d4c5b0;border-radius:6px;">
                <button class="btn-search" onclick="analyzeImportText()">üî¨ Analyser</button>
            </div>
            <div id="importResults"></div>
        </div>

        <!-- TAB: AI Research -->
        <div class="tab-panel" id="tab-ai">
            <div id="aiNoKey" style="background:#fff3e0;padding:1.5rem;border-radius:10px;margin-bottom:1rem;">
                <h3 style="margin:0 0 0.5rem 0;font-size:1rem;">üîë Configuration requise</h3>
                <p style="font-size:0.88rem;color:#555;margin-bottom:0.8rem;">
                    Pour utiliser la recherche IA, cr√©ez un fichier <code>.env</code> dans le dossier MFC avec :
                </p>
                <pre style="background:#1a1a1a;color:#e8e0d5;padding:1rem;border-radius:6px;font-size:0.85rem;">ANTHROPIC_API_KEY=sk-ant-api03-VOTRE-CLE-ICI</pre>
                <p style="font-size:0.82rem;color:#888;margin-top:0.5rem;">
                    Obtenez votre cl√© sur <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> (~0.02‚Ç¨ par recherche)
                </p>
            </div>
            <div class="search-bar">
                <input type="text" id="aiQuery" placeholder="Posez une question scientifique... Ex: Quel est l'effet du benzyl benzoate sur le polymorphisme de la cire de soja ?"
                       onkeypress="if(event.key==='Enter')searchAI()">
                <button class="btn-search" onclick="searchAI()">ü§ñ Rechercher</button>
            </div>
            <div id="aiResults"></div>
        </div>
    </div>

    <script>
    // === TAB NAVIGATION ===
    document.querySelectorAll('.research-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.research-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        });
    });

    // === STATS ===
    async function loadStats() {
        try {
            const [molRes, kbRes] = await Promise.all([
                fetch('/api/molecules-db').then(r => r.json()).catch(() => ({ molecules: [] })),
                fetch('/api/knowledge').then(r => r.json()).catch(() => [])
            ]);
            document.getElementById('statMolecules').textContent = molRes.count || molRes.molecules?.length || '-';
            document.getElementById('statKB').textContent = Array.isArray(kbRes) ? kbRes.length : '-';
            document.getElementById('statAllergens').textContent = molRes.allergen_count || '-';
            const sources = new Set();
            if (Array.isArray(kbRes)) kbRes.forEach(k => { if (k.source) sources.add(k.source.split(',')[0].trim()); });
            document.getElementById('statSources').textContent = sources.size || '-';
        } catch(e) { console.error(e); }
    }
    loadStats();

    // === PUBMED SEARCH ===
    async function searchPubMed() {
        const q = document.getElementById('pubmedQuery').value.trim();
        if (!q) return;
        const div = document.getElementById('pubmedResults');
        div.innerHTML = '<div class="loading">Recherche PubMed en cours</div>';
        
        try {
            const res = await fetch('/api/research/pubmed?q=' + encodeURIComponent(q));
            const data = await res.json();
            if (!data.articles || data.articles.length === 0) {
                div.innerHTML = '<p style="color:#888;text-align:center;padding:2rem;">Aucun r√©sultat trouv√©. Essayez d\'autres termes en anglais.</p>';
                return;
            }
            div.innerHTML = `<p style="font-size:0.82rem;color:#888;margin-bottom:1rem;">${data.total || data.articles.length} r√©sultats trouv√©s</p>`;
            data.articles.forEach(a => {
                div.innerHTML += `
                    <div class="result-card">
                        <div class="result-title">${a.title}</div>
                        <div class="result-meta">
                            ${a.authors || ''} ${a.journal ? '‚Äî ' + a.journal : ''} ${a.year ? '(' + a.year + ')' : ''}
                            ${a.doi ? ' ‚Äî DOI: ' + a.doi : ''}
                        </div>
                        <div class="result-abstract">${(a.abstract || 'Pas d\'abstract disponible').substring(0, 400)}${(a.abstract||'').length > 400 ? '...' : ''}</div>
                        <div class="result-actions">
                            ${a.doi ? `<a href="https://doi.org/${a.doi}" target="_blank" class="btn-sm btn-link">üìÑ Article</a>` : ''}
                            <a href="https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/" target="_blank" class="btn-sm btn-link">üîó PubMed</a>
                            <button class="btn-sm btn-extract" onclick="importPubMedToText('${a.pmid}')">üî¨ Analyser</button>
                            <button class="btn-sm btn-import" onclick="importPubMedToKB(${JSON.stringify(a).replace(/'/g, "\\'")})">üì• Importer en KB</button>
                        </div>
                    </div>`;
            });
        } catch(e) {
            div.innerHTML = `<p style="color:#c62828;padding:1rem;">Erreur : ${e.message}</p>`;
        }
    }

    function addPubMedFilter(el, term) {
        el.classList.toggle('active');
        // Rebuild query from active chips
        const input = document.getElementById('pubmedQuery');
        if (el.classList.contains('active') && !input.value.includes(term)) {
            input.value = (input.value + ' ' + term).trim();
        }
    }

    async function importPubMedToKB(article) {
        const text = `${article.title}\n\n${article.abstract || ''}\n\nAuthors: ${article.authors || ''}\nJournal: ${article.journal || ''}\nYear: ${article.year || ''}\nDOI: ${article.doi || ''}\nPMID: ${article.pmid || ''}`;
        document.getElementById('importText').value = text;
        document.getElementById('importSource').value = article.doi ? `DOI: ${article.doi}` : `PubMed: ${article.pmid}`;
        // Switch to import tab
        document.querySelectorAll('.research-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-tab="import"]').classList.add('active');
        document.getElementById('tab-import').classList.add('active');
        analyzeImportText();
    }

    function importPubMedToText(pmid) {
        importPubMedToKB({ pmid, title: '', abstract: '', authors: '', journal: '', year: '', doi: '' });
    }

    // === MOLECULE SEARCH ===
    async function searchMolecule() {
        const q = document.getElementById('moleculeQuery').value.trim();
        const div = document.getElementById('moleculeResults');
        
        try {
            // Search local DB first
            const localRes = await fetch('/api/molecules-db').then(r => r.json());
            let molecules = localRes.molecules || [];
            
            if (q) {
                const ql = q.toLowerCase();
                molecules = molecules.filter(m => 
                    m.name.toLowerCase().includes(ql) || 
                    m.cas === q ||
                    (m.notes_type && m.notes_type.includes(ql))
                );
            }
            
            if (molecules.length === 0 && q) {
                // Try PubChem
                div.innerHTML = '<div class="loading">Recherche PubChem</div>';
                try {
                    const pcRes = await fetch('/api/research/pubchem?q=' + encodeURIComponent(q));
                    const pcData = await pcRes.json();
                    if (pcData.found) {
                        molecules = [pcData];
                    }
                } catch(e) {}
            }
            
            if (molecules.length === 0) {
                div.innerHTML = '<p style="color:#888;text-align:center;padding:2rem;">Aucune mol√©cule trouv√©e.</p>';
                return;
            }
            
            div.innerHTML = '';
            molecules.forEach(m => {
                const solColor = m.solubility_wax === 'insoluble' ? '#ffebee' : 
                                 m.solubility_wax === 'soluble' ? '#e8f5e9' : 
                                 m.solubility_wax === 'partiel' ? '#fff3e0' : '#f5f5f5';
                div.innerHTML += `
                    <div class="molecule-card">
                        <div class="molecule-header">
                            <span class="molecule-name">${m.allergen ? '‚ö†Ô∏è ' : ''}${m.name}</span>
                            <span class="molecule-cas">CAS ${m.cas}</span>
                        </div>
                        <div class="molecule-props">
                            ${m.bp ? `<div class="mol-prop"><span class="mol-prop-label">Point √©bullition</span><span class="mol-prop-value">${m.bp}¬∞C</span></div>` : ''}
                            ${m.mw ? `<div class="mol-prop"><span class="mol-prop-label">Masse mol.</span><span class="mol-prop-value">${m.mw} g/mol</span></div>` : ''}
                            ${m.volatility ? `<div class="mol-prop"><span class="mol-prop-label">Volatilit√©</span><span class="mol-prop-value">${m.volatility}</span></div>` : ''}
                            <div class="mol-prop" style="background:${solColor}"><span class="mol-prop-label">Solub. cire</span><span class="mol-prop-value">${m.solubility_wax || '?'}</span></div>
                            ${m.type ? `<div class="mol-prop"><span class="mol-prop-label">Type</span><span class="mol-prop-value">${m.type}</span></div>` : ''}
                            ${m.notes_type ? `<div class="mol-prop"><span class="mol-prop-label">Note</span><span class="mol-prop-value">${m.notes_type}</span></div>` : ''}
                        </div>
                    </div>`;
            });
        } catch(e) {
            div.innerHTML = `<p style="color:#c62828;">Erreur : ${e.message}</p>`;
        }
    }
    // Load all molecules on init
    searchMolecule();

    // === IMPORT TEXT ANALYSIS ===
    async function analyzeImportText() {
        const text = document.getElementById('importText').value.trim();
        const source = document.getElementById('importSource').value.trim();
        if (!text || text.length < 20) { alert('Texte trop court (min 20 caract√®res)'); return; }
        
        const div = document.getElementById('importResults');
        div.innerHTML = '<div class="loading">Analyse en cours</div>';
        
        try {
            const res = await fetch('/api/knowledge/import-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, source_title: source, auto_create_kb: false })
            });
            const data = await res.json();
            
            let html = '<div class="extraction-results">';
            html += '<h3 style="margin:0 0 1rem 0;font-size:1.05rem;">üìä R√©sultats de l\'extraction</h3>';
            
            // CAS numbers
            if (data.cas_numbers?.length) {
                html += '<div class="extraction-section"><h4>üî¨ Num√©ros CAS d√©tect√©s (' + data.cas_numbers.length + ')</h4>';
                data.cas_numbers.forEach(c => {
                    html += `<span class="tag tag-cas">${c.cas}${c.known ? ' ‚úì ' + c.name : ' (inconnu)'}</span>`;
                });
                html += '</div>';
            }
            
            // Molecules by name
            if (data.molecules?.length) {
                html += '<div class="extraction-section"><h4>üß™ Mol√©cules identifi√©es (' + data.molecules.length + ')</h4>';
                data.molecules.forEach(m => {
                    html += `<span class="tag tag-mol">${m.name} (${m.cas}) Bp:${m.bp||'?'}¬∞C</span>`;
                });
                html += '</div>';
            }
            
            // Warnings
            if (data.warnings?.length) {
                html += '<div class="extraction-section"><h4>‚ö†Ô∏è Alertes</h4>';
                data.warnings.forEach(w => {
                    html += `<span class="tag tag-warn">${w}</span>`;
                });
                html += '</div>';
            }
            
            // Allergens
            if (data.allergens?.length) {
                html += '<div class="extraction-section"><h4>üè∑Ô∏è Allerg√®nes IFRA</h4>';
                data.allergens.forEach(a => {
                    html += `<span class="tag tag-allergen">${a.name} (${a.cas})</span>`;
                });
                html += '</div>';
            }
            
            // Boiling points
            if (data.boiling_points?.length) {
                html += '<div class="extraction-section"><h4>üå°Ô∏è Points d\'√©bullition</h4>';
                data.boiling_points.forEach(bp => {
                    html += `<span class="tag tag-bp">${bp.value}¬∞C</span>`;
                });
                html += '</div>';
            }
            
            // Suggested KB entries
            if (data.suggested_kb_entries?.length) {
                html += '<div class="extraction-section"><h4>üìù Fiches KB sugg√©r√©es</h4>';
                data.suggested_kb_entries.forEach((s, i) => {
                    html += `<div class="result-card" style="margin-top:0.5rem;">
                        <div class="result-title">${s.title}</div>
                        <div class="result-abstract">${(s.content || '').substring(0, 200)}...</div>
                        <button class="btn-sm btn-import" onclick="createKBEntry(${i})">üì• Cr√©er fiche KB</button>
                    </div>`;
                });
                html += '</div>';
            }
            
            // Enrichment
            if (data.enrichment_data?.length) {
                html += '<div class="extraction-section"><h4>üîó Enrichissement crois√©</h4>';
                data.enrichment_data.forEach(e => {
                    html += `<div style="font-size:0.85rem;padding:0.3rem 0;">${e.message || JSON.stringify(e)}</div>`;
                });
                html += '</div>';
            }
            
            // Summary
            const total = (data.cas_numbers?.length || 0) + (data.molecules?.length || 0);
            if (total === 0 && !data.warnings?.length) {
                html += '<p style="color:#888;text-align:center;padding:1rem;">Aucune donn√©e exploitable d√©tect√©e dans ce texte.</p>';
            }
            
            html += '</div>';
            div.innerHTML = html;
            
            // Store for KB creation
            window._lastImportData = data;
            
        } catch(e) {
            div.innerHTML = `<p style="color:#c62828;padding:1rem;">Erreur : ${e.message}</p>`;
        }
    }

    async function createKBEntry(index) {
        const entry = window._lastImportData?.suggested_kb_entries?.[index];
        if (!entry) return;
        try {
            await fetch('/api/knowledge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category: entry.category || 'Science',
                    subcategory: entry.subcategory || 'recherche',
                    title: entry.title,
                    content: entry.content,
                    source: entry.source || document.getElementById('importSource').value,
                    verified: 0,
                    keywords: entry.keywords || ''
                })
            });
            alert('‚úì Fiche KB cr√©√©e : ' + entry.title);
            loadStats();
        } catch(e) {
            alert('Erreur : ' + e.message);
        }
    }

    // === AI RESEARCH ===
    async function searchAI() {
        const q = document.getElementById('aiQuery').value.trim();
        if (!q) return;
        const div = document.getElementById('aiResults');
        div.innerHTML = '<div class="loading">Claude r√©fl√©chit</div>';
        
        try {
            const res = await fetch('/api/knowledge/ai-research', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: q })
            });
            const data = await res.json();
            
            if (data.error) {
                div.innerHTML = `<div style="background:#fff3e0;padding:1rem;border-radius:8px;color:#e65100;">${data.error}</div>`;
                return;
            }
            
            let html = '';
            if (data.ai_response) {
                html += `<div class="ai-badge">ü§ñ Claude</div>`;
                html += `<div class="ai-response">${data.ai_response}</div>`;
            }
            if (data.extracted) {
                html += '<div style="margin-top:1rem;">';
                const ext = data.extracted;
                if (ext.cas_numbers?.length) {
                    html += '<p><strong>CAS d√©tect√©s :</strong> ';
                    ext.cas_numbers.forEach(c => html += `<span class="tag tag-cas">${c.cas} ${c.name||''}</span>`);
                    html += '</p>';
                }
                if (ext.warnings?.length) {
                    html += '<p><strong>Alertes :</strong> ';
                    ext.warnings.forEach(w => html += `<span class="tag tag-warn">${w}</span>`);
                    html += '</p>';
                }
                html += '</div>';
            }
            div.innerHTML = html;
        } catch(e) {
            div.innerHTML = `<p style="color:#c62828;">Erreur : ${e.message}</p>`;
        }
    }
    </script>
<script src="/js/operator-selector.js"></script>
<script src="/js/cache-buster.js"></script>
</body>
</html>
