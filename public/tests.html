<!DOCTYPE html>
<html lang="fr">
<head>
<style id="mfc-auth-wall">body{visibility:hidden!important;}</style>
<script>try{if(localStorage.getItem("mfc_operator"))document.getElementById("mfc-auth-wall").remove();}catch(e){}</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#a32d03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tests de combustion - MFC Laboratoire</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" rel="stylesheet">
    <script src="js/theme-toggle.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="img/logo-mfc-carre.jpg" alt="MFC">
            <div class="brand-text"><h1>LABORATOIRE</h1><span>Ma√Ætre Cirier depuis 1904</span><span id="mfc-v" style="background:#a32d03;color:#fff;padding:0.1rem 0.4rem;border-radius:8px;font-size:0.55rem;font-weight:700;margin-left:0.4rem;letter-spacing:0.5px;"></span></div>
        </div>
        <div class="navbar-menu">
            <a href="index.html">Accueil</a>
            <a href="echantillons.html">√âchantillons</a>
            <a href="formulations.html">Formulations</a>
            <a href="tests.html" class="active">Tests</a>
            <a href="matieres.html">Mati√®res</a>
            <a href="recettes.html">Recettes</a>
            <a href="connaissances.html">Connaissances</a>
            <a href="fds.html">FDS Parfums</a><a href="formulateur.html">Formulateur</a>
            <a href="recherche.html">Recherche</a>
                <a href="analytics.html">üìä Analytics</a>
            <a href="molecules.html">üß¨ Mol√©cules</a>
            <a href="predictif.html">üîÆ Pr√©dictif</a>
            <a href="clients.html">Clients</a>
            <a href="operateurs.html">Op√©rateurs</a>
        </div>
    </nav>

    <div class="toast-container" id="toast-container"></div>

    <div class="container">
        <!-- Workflow -->
        <div class="workflow-bar">
            <div class="workflow-step completed clickable" onclick="location.href='echantillons.html'"><span class="step-num">‚úì</span><span class="step-label">√âchantillon</span></div>
            <div class="workflow-connector" style="background:var(--vert);"></div>
            <div class="workflow-step completed clickable" onclick="location.href='formulations.html'"><span class="step-num">‚úì</span><span class="step-label">Formulation</span></div>
            <div class="workflow-connector" style="background:var(--vert);"></div>
            <div class="workflow-step active"><span class="step-num">3</span><span class="step-label">Test combustion</span></div>
            <div class="workflow-connector"></div>
            <div class="workflow-step"><span class="step-num">4</span><span class="step-label">Validation</span></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üî• Tests de combustion</h3>
                <button class="btn btn-primary" onclick="openNewTestModal()">+ Nouveau test</button>
            </div>
            <div class="filters">
                <select id="filter-status" class="form-control"><option value="">Tous</option><option value="en_cours">En cours</option><option value="termin√©">Termin√©</option><option value="valid√©_client">‚úì Valid√© client</option><option value="refus√©_client">‚úó Refus√© client</option></select>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr>
                        <th>N¬∞ Test</th><th>√âchantillon</th><th>Client</th><th>Formulation</th>
                        <th>M√®che</th><th>Masse initiale</th><th>Masse actuelle</th>
                        <th>Cycles</th><th>Statut</th><th>Actions</th>
                    </tr></thead>
                    <tbody id="tests-table"><tr><td colspan="10" class="loading"><div class="spinner"></div></td></tr></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><h3 class="card-title">üìã Protocole de test</h3></div>
            <p style="color:var(--texte-secondary); line-height:1.9;">
                <strong style="color:var(--mfc-cire);">Cycles de 4 heures</strong> ‚Äî La masse initiale est h√©rit√©e automatiquement de la formulation (elle-m√™me li√©e √† l'√©chantillon client).
                La masse apr√®s extinction du cycle N devient la masse de d√©part du cycle N+1.
                <br><strong style="color:var(--mfc-cire);">4 cycles minimum</strong> pour une √©valuation compl√®te. Observations : bassin de fusion, flamme, champignonnage, tunnel, diffusion parfum.
            </p>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL NOUVEAU TEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="new-test-modal">
        <div class="modal" style="max-width:720px;">
            <div class="modal-header"><h2>Nouveau test de combustion</h2><button class="modal-close" onclick="closeNewTestModal()">&times;</button></div>
            <div class="modal-body">
                <form id="test-form">
                    <div class="alert alert-info"><strong>N¬∞ Test :</strong> <span id="auto-test-number">...</span></div>

                    <div class="form-section">S√©lection de la formulation</div>
                    <div class="form-group">
                        <label>Formulation *</label>
                        <select class="form-control" id="formulation_id" required onchange="onFormulationSelect()">
                            <option value="">S√©lectionner une formulation...</option>
                        </select>
                    </div>

                    <!-- Tra√ßabilit√© compl√®te -->
                    <div id="inherited-data" style="display:none;">
                        <div class="alert alert-success" style="margin-top:0.75rem;">
                            ‚úì Donn√©es h√©rit√©es automatiquement ‚Äî Tra√ßabilit√© compl√®te
                        </div>

                        <!-- Origine : Client + √âchantillon -->
                        <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:1rem; margin-top:0.75rem;">
                            <p style="font-size:0.72rem; text-transform:uppercase; letter-spacing:1px; color:var(--texte-muted); margin-bottom:0.5rem; font-weight:600;">Origine de la demande</p>
                            <div class="grid grid-3">
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">√âCHANTILLON</label><p id="inh_sample" style="font-weight:600; color:var(--mfc-cire);">‚Äî</p></div>
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">CLIENT</label><p id="inh_client" style="font-weight:500;">‚Äî</p></div>
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">DEMANDE</label><p id="inh_request" style="font-size:0.85rem; color:var(--texte-secondary);">‚Äî</p></div>
                            </div>
                        </div>

                        <!-- Sp√©cifications h√©rit√©es -->
                        <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:1rem; margin-top:0.5rem;">
                            <p style="font-size:0.72rem; text-transform:uppercase; letter-spacing:1px; color:var(--texte-muted); margin-bottom:0.5rem; font-weight:600;">Sp√©cifications de la formulation</p>
                            <div class="grid grid-4">
                                <div>
                                    <label style="font-size:0.68rem; color:var(--texte-muted);">MASSE INITIALE</label>
                                    <p id="inh_mass" style="font-size:1.3rem; font-weight:700; color:var(--mfc-cire);">‚Äî</p>
                                </div>
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">M√àCHE</label><p id="inh_wick" style="font-weight:600;">‚Äî</p></div>
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">TYPE</label><p id="inh_type">‚Äî</p></div>
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">DIMENSIONS</label><p id="inh_dims">‚Äî</p></div>
                            </div>
                            <div class="grid grid-3" style="margin-top:0.5rem;">
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">PARFUM</label><p id="inh_fragrance">‚Äî</p></div>
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">COULEUR</label>
                                    <div class="d-flex align-center gap-1"><span class="color-preview" id="inh_color" style="display:none;"></span><span id="inh_pantone">‚Äî</span></div>
                                </div>
                                <div><label style="font-size:0.68rem; color:var(--texte-muted);">FORMULATION</label><p id="inh_formcode">‚Äî</p></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">Informations du test</div>
                    <div class="form-group"><label>Date de d√©but</label><input type="date" class="form-control" id="start_date"></div>
                    <div class="form-group"><label>Notes</label><textarea class="form-control" id="test_notes" rows="2" placeholder="Notes..."></textarea></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNewTestModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveNewTest()">üî• Cr√©er le test</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL D√âTAIL TEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal" style="max-width:960px;">
            <div class="modal-header"><h2 id="detail-title">Test</h2><button class="modal-close" onclick="closeDetailModal()">&times;</button></div>
            <div class="modal-body" id="detail-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailModal()">Fermer</button>
                <button class="btn btn-primary" id="btn-add-cycle" onclick="openCycleModal()">+ Cycle 1/4</button>
                <button class="btn btn-success" id="btn-finish" onclick="finishTest()" style="display:none;">‚úì Terminer le test</button>
                <button class="btn" id="btn-report" onclick="generateReport()" style="display:none; background:var(--mfc-cire); color:#fff;">üìä Rapport</button>
                <button class="btn" id="btn-pdf" onclick="downloadPDF()" style="display:none; background:#1565c0; color:#fff;">üìÑ PDF</button>
                <button class="btn" id="btn-photo" onclick="document.getElementById('photo-input').click();" style="background:#7b1fa2; color:#fff;">üì∑ Photo</button>
                <input type="file" id="photo-input" accept="image/*" multiple capture="environment" style="display:none;" onchange="uploadPhotos(this.files)">
                <button class="btn" id="btn-client-val" onclick="openClientModal('valid√©')" style="display:none; background:#388e3c; color:#fff;">üë§ Client valide</button>
                <button class="btn" id="btn-client-ref" onclick="openClientModal('refus√©')" style="display:none; background:#c62828; color:#fff;">üë§ Client refuse</button>
                <button class="btn" id="btn-retry" onclick="retryTest()" style="display:none; background:#e67e22; color:#fff;">üîÑ Reprendre essai</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL CYCLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="cycle-modal">
        <div class="modal" style="max-width:660px;">
            <div class="modal-header"><h2 id="cycle-title">Cycle</h2><button class="modal-close" onclick="closeCycleModal()">&times;</button></div>
            <div class="modal-body">
                <form id="cycle-form">
                    <div class="alert alert-info"><strong>Cycle <span id="cycle-num">1</span></strong> ‚Äî Dur√©e : 4 heures</div>

                    <!-- Masse de d√©part auto -->
                    <div style="background:var(--fond-surface); border:2px solid var(--mfc-cire); border-radius:var(--radius); padding:1rem; margin-bottom:1rem;">
                        <p style="font-size:0.62rem; text-transform:uppercase; letter-spacing:1.5px; color:var(--mfc-cire); font-weight:700; margin-bottom:0.3rem;">MASSE DE D√âPART DU CYCLE</p>
                        <div style="display:flex; align-items:center; gap:1rem;">
                            <p id="mass-before-display" style="font-size:2rem; font-weight:700; color:var(--mfc-cire); font-family:var(--font-display); margin:0;">‚Äî g</p>
                            <div>
                                <p id="mass-hint" style="font-size:0.78rem; color:var(--texte-secondary); margin:0;"></p>
                                <p style="font-size:0.68rem; color:var(--texte-muted); margin:0.15rem 0 0;">Valeur report√©e automatiquement ‚Äî non modifiable</p>
                            </div>
                        </div>
                        <input type="hidden" id="c_mass_before">
                    </div>

                    <div class="form-section">Masse apr√®s extinction (4h)</div>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Masse apr√®s extinction (g) * <span style="font-size:0.72rem; color:var(--texte-muted);">‚Äî peser la bougie</span></label>
                            <input type="number" class="form-control" id="c_mass_after" step="0.1" required oninput="calcConsumed()" style="font-size:1.1rem; font-weight:700;" placeholder="Entrer la masse pes√©e...">
                        </div>
                        <div class="form-group">
                            <label>Consomm√© ce cycle</label>
                            <input type="text" class="form-control" id="c_consumed" readonly style="background:var(--fond-surface); font-weight:700; font-size:1.1rem; color:var(--rouge);">
                            <small id="consumed-pct" style="font-size:0.72rem; color:var(--texte-muted);"></small>
                        </div>
                    </div>

                    <div class="form-section">Observations</div>
                    <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:0.75rem; margin-bottom:0.75rem;">
                        <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.5rem;">
                            <label style="font-weight:600; font-size:0.82rem; margin:0;">Bassin de fusion</label>
                            <label style="font-size:0.78rem; cursor:pointer; display:flex; align-items:center; gap:0.3rem; margin:0;">
                                <input type="checkbox" id="c_pool_visible" checked onchange="togglePoolFields()">
                                <span>Visible</span>
                            </label>
                        </div>
                        <div id="pool-fields" class="grid grid-2" style="gap:0.5rem;">
                            <div class="form-group" style="margin-bottom:0;"><label style="font-size:0.72rem;">Diam√®tre (mm)</label><input type="number" class="form-control" id="c_pool" step="0.1" placeholder="Ex: 60"></div>
                            <div class="form-group" style="margin-bottom:0;"><label style="font-size:0.72rem;">Profondeur (mm)</label><input type="number" class="form-control" id="c_pool_depth" step="0.1" placeholder="Ex: 8"></div>
                        </div>
                        <div id="pool-not-visible" style="display:none;">
                            <p class="text-muted" style="font-size:0.78rem; font-style:italic; margin:0.3rem 0 0;">Bassin non visible ‚Äî cire opaque ou non form√©</p>
                        </div>
                    </div>
                    <div class="grid grid-2">
                        <div class="form-group"><label>Hauteur flamme (mm)</label><input type="number" class="form-control" id="c_flame" step="0.1"></div>
                    </div>
                    <div class="grid grid-3">
                        <div class="form-group"><label>Stabilit√© flamme</label><select class="form-control" id="c_stability"><option value="">‚Äî</option><option>stable</option><option>instable</option><option>vacillante</option></select></div>
                        <div class="form-group"><label>Fum√©e</label><select class="form-control" id="c_smoke"><option value="">‚Äî</option><option>aucune</option><option>l√©g√®re</option><option>moyenne</option><option>forte</option></select></div>
                        <div class="form-group"><label>Suie</label><select class="form-control" id="c_soot"><option value="">‚Äî</option><option>aucune</option><option>l√©g√®re</option><option>moyenne</option><option>forte</option></select></div>
                    </div>
                    <div class="grid grid-3">
                        <div class="form-group"><label>Champignonnage</label><select class="form-control" id="c_mushroom"><option value="">‚Äî</option><option>aucun</option><option>l√©ger</option><option>mod√©r√©</option><option>important</option></select></div>
                        <div class="form-group"><label>Effet tunnel</label><select class="form-control" id="c_tunnel"><option value="">‚Äî</option><option>aucun</option><option>l√©ger</option><option>mod√©r√©</option><option>important</option></select></div>
                        <div class="form-group"><label>Diffusion parfum</label><select class="form-control" id="c_scent"><option value="">‚Äî</option><option>faible</option><option>mod√©r√©e</option><option>bonne</option><option>excellente</option></select></div>
                    </div>
                    <div class="form-section">Notes</div>
                    <div class="form-group"><textarea class="form-control" id="c_notes" rows="2" placeholder="Observations..."></textarea></div>

                    <div class="form-section" style="background:#fff3e0;color:#e65100;padding:0.4rem 0.75rem;border-radius:var(--radius);margin:0.75rem 0 0.5rem;">üîß Modifications mati√®res (si changement par rapport √† la formulation)</div>
                    <div style="background:#fff8f0;border:1px solid #ffe0b2;border-radius:var(--radius);padding:0.75rem;margin-bottom:0.5rem;">
                        <p style="font-size:0.72rem;color:#e65100;margin:0 0 0.5rem;">Remplir uniquement si vous avez modifi√© un param√®tre pendant ce cycle</p>
                        <div class="grid grid-2" style="gap:0.5rem;">
                            <div class="form-group" style="margin-bottom:0.4rem;"><label style="font-size:0.72rem;">Changement m√®che</label><input type="text" class="form-control" id="c_mod_wick" placeholder="Ex: CL-130 ‚Üí CL-140"></div>
                            <div class="form-group" style="margin-bottom:0.4rem;"><label style="font-size:0.72rem;">Nouveau % parfum</label><input type="number" class="form-control" id="c_mod_frag" step="0.5" placeholder="Ex: 10"></div>
                        </div>
                        <div class="form-group" style="margin-bottom:0.4rem;"><label style="font-size:0.72rem;">Modification cires</label><input type="text" class="form-control" id="c_mod_wax" placeholder="Ex: ajout 10% C48 paraffine, r√©duction Kerasoy"></div>
                        <div class="form-group" style="margin-bottom:0.4rem;"><label style="font-size:0.72rem;">Modification colorant</label><input type="text" class="form-control" id="c_mod_color" placeholder="Ex: chang√© pour Pantone 485C, dosage 0.25%"></div>
                        <div class="form-group" style="margin-bottom:0.4rem;"><label style="font-size:0.72rem;">Autre modification</label><input type="text" class="form-control" id="c_mod_other" placeholder="Ex: ajout additif, changement contenant..."></div>
                        <div class="form-group" style="margin-bottom:0;"><label style="font-size:0.72rem;">Raison du changement</label><textarea class="form-control" id="c_mod_notes" rows="2" placeholder="Ex: le parfum ne se m√©langeait pas bien avec la cire, j'ai augment√© √† 10%..."></textarea></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCycleModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveCycle()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        let tests = [], formulations = [], currentTest = null;

        function toast(m, t='success') {
            const c = document.getElementById('toast-container'), d = document.createElement('div');
            d.className = `toast toast-${t}`; d.textContent = m; c.appendChild(d);
            setTimeout(() => d.remove(), 3500);
        }
        function fmtTime(m) { return m ? Math.floor(m/60) + 'h' + (m%60 ? String(m%60).padStart(2,'0') : '') : '‚Äî'; }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadFormulations() {
            const r = await fetch('/api/formulations'); formulations = await r.json();
            const s = document.getElementById('formulation_id');
            s.innerHTML = '<option value="">S√©lectionner une formulation...</option>';
            formulations.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.textContent = `${f.code} ‚Äî ${f.name} (${f.total_mass}g)`; s.appendChild(o); });
        }

        async function loadTests() {
            const st = document.getElementById('filter-status').value;
            let url = '/api/burn-tests'; 
            if (st === 'valid√©_client' || st === 'refus√©_client') url += '?status=termin√©';
            else if (st) url += '?status=' + st;
            const r = await fetch(url); let allTests = await r.json();
            // Filter by client_status if needed
            if (st === 'valid√©_client') allTests = allTests.filter(t => t.client_status === 'valid√©');
            else if (st === 'refus√©_client') allTests = allTests.filter(t => t.client_status === 'refus√©');
            tests = allTests; renderTests();
        }

        function renderTests() {
            const tb = document.getElementById('tests-table');
            if (!tests.length) { tb.innerHTML = '<tr><td colspan="10"><div class="empty-state"><div class="icon">üî•</div><p>Aucun test</p><button class="btn btn-primary" onclick="openNewTestModal()">Cr√©er le premier test</button></div></td></tr>'; return; }
            tb.innerHTML = tests.map(t => `
                <tr onclick="viewTest(${t.id})" style="cursor:pointer;">
                    <td><strong style="color:var(--mfc-cire);">${t.test_number}</strong>${t.version > 1 ? '<br><span style="font-size:0.62rem;color:#1565c0;font-weight:600;">V'+t.version+'</span>' : ''}</td>
                    <td>${t.sample_number || '‚Äî'}</td>
                    <td>${t.client_name || '‚Äî'} ${t.client_company ? '<span class="text-muted">('+t.client_company+')</span>' : ''}</td>
                    <td>${t.formulation_code || '‚Äî'}</td>
                    <td><strong>${t.wick_reference || '‚Äî'}</strong></td>
                    <td>${t.initial_mass ? t.initial_mass + ' g' : '‚Äî'}</td>
                    <td id="cmass-${t.id}">‚Äî</td>
                    <td id="ccycles-${t.id}">‚Äî</td>
                    <td><span class="badge badge-${t.status}">${t.status}</span>${t.client_status ? '<br><span class="badge" style="margin-top:2px;font-size:0.62rem;background:'+(t.client_status==='valid√©'?'#e8f5e9;color:#2e7d32':'#fbe9e7;color:#c62828')+';">üë§ '+(t.client_status==='valid√©'?'Valid√©':'Refus√©')+'</span>' : ''}</td>
                    <td class="actions" onclick="event.stopPropagation()">
                        <button class="btn btn-sm" onclick="window.open('/print.html?type=test&id='+${t.id},'_blank')" style="background:#666;color:#fff;" title="Imprimer fiche test">üñ®Ô∏è</button>
                        <button class="btn btn-secondary btn-sm" onclick="viewTest(${t.id})">D√©tails</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTest(${t.id})">‚úï</button>
                    </td>
                </tr>
            `).join('');
            // Fetch cycle info for each test
            tests.forEach(async t => {
                try {
                    const r = await fetch('/api/burn-tests/' + t.id); const d = await r.json();
                    const cy = d.cycles || [];
                    const massEl = document.getElementById('cmass-' + t.id);
                    const cycEl = document.getElementById('ccycles-' + t.id);
                    if (cy.length > 0) {
                        const last = cy[cy.length-1];
                        if (massEl) massEl.innerHTML = last.mass_after ? '<strong>' + last.mass_after + ' g</strong>' : '‚Äî';
                        if (cycEl) cycEl.textContent = cy.length + ' / 4';
                    } else {
                        if (massEl) massEl.textContent = t.initial_mass ? t.initial_mass + ' g' : '‚Äî';
                        if (cycEl) cycEl.textContent = '0 / 4';
                    }
                } catch(e) {}
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEW TEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function openNewTestModal() {
            document.getElementById('test-form').reset();
            document.getElementById('inherited-data').style.display = 'none';
            document.getElementById('auto-test-number').textContent = 'S√©lectionnez une formulation...';
            const d = new Date();
            document.getElementById('start_date').value = d.toISOString().slice(0,10);
            const p = new URLSearchParams(location.search);
            if (p.get('formulation')) { document.getElementById('formulation_id').value = p.get('formulation'); await onFormulationSelect(); }
            document.getElementById('new-test-modal').classList.add('active');
        }
        function closeNewTestModal() { document.getElementById('new-test-modal').classList.remove('active'); }

        async function onFormulationSelect() {
            const fid = document.getElementById('formulation_id').value;
            const div = document.getElementById('inherited-data');
            if (!fid) { div.style.display = 'none'; document.getElementById('auto-test-number').textContent = 'S√©lectionnez une formulation...'; return; }
            const r = await fetch('/api/formulations/' + fid); const f = await r.json();
            if (f.error) { div.style.display = 'none'; return; }
            div.style.display = 'block';

            // Auto-generate test number from formulation code: ECH-0206-001-F1 ‚Üí ECH-0206-001-F1-T1
            try {
                const tr = await fetch('/api/burn-tests?formulation_id=' + fid);
                const existingTests = await tr.json();
                const num = (existingTests.length || 0) + 1;
                document.getElementById('auto-test-number').textContent = f.code + '-T' + num;
            } catch(e) {
                document.getElementById('auto-test-number').textContent = f.code + '-T1';
            }
            document.getElementById('inh_sample').textContent = f.sample_number || '‚Äî';
            document.getElementById('inh_client').textContent = (f.client_name || '‚Äî') + (f.client_company ? ' (' + f.client_company + ')' : '');
            document.getElementById('inh_request').textContent = f.client_request || '‚Äî';
            document.getElementById('inh_mass').textContent = f.total_mass ? f.total_mass + ' g' : '‚Äî';
            document.getElementById('inh_wick').textContent = f.wick_reference || '‚Äî';
            document.getElementById('inh_type').textContent = f.container_type || f.sample_type || '‚Äî';
            document.getElementById('inh_dims').textContent = (f.diameter||f.sample_diameter) && (f.height||f.sample_height) ? (f.diameter||f.sample_diameter) + ' √ó ' + (f.height||f.sample_height) + ' mm' : '‚Äî';
            document.getElementById('inh_fragrance').textContent = (f.fragrance_name||f.sample_fragrance) ? (f.fragrance_name||f.sample_fragrance) + (f.fragrance_ref ? ' ['+f.fragrance_ref+']' : '') + ' (' + (f.fragrance_percentage||f.sample_fragrance_pct) + '%)' + (f.fragrance_supplier ? ' ‚Äî '+f.fragrance_supplier : '') : '‚Äî';
            document.getElementById('inh_formcode').textContent = f.code || '‚Äî';
            const cp = document.getElementById('inh_color');
            const hex = f.pantone_hex || f.sample_pantone_hex;
            if (hex) { cp.style.backgroundColor = hex; cp.style.display = 'inline-block'; } else { cp.style.display = 'none'; }
            document.getElementById('inh_pantone').textContent = f.pantone_code || f.sample_pantone_code || '‚Äî';
        }

        async function saveNewTest() {
            const fid = document.getElementById('formulation_id').value;
            if (!fid) { toast('S√©lectionnez une formulation','error'); return; }
            const f = formulations.find(x => x.id == fid);
            const data = {
                test_number: document.getElementById('auto-test-number').textContent,
                formulation_id: parseInt(fid),
                sample_id: f ? f.sample_id : null,
                initial_mass: f ? f.total_mass : null,
                wick_reference: f ? f.wick_reference : null,
                start_date: document.getElementById('start_date').value,
                notes: document.getElementById('test_notes').value
            };
            const r = await fetch('/api/burn-tests', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            const res = await r.json();
            if (res.error) { toast(res.error,'error'); return; }
            mfcLogActivity('test_lanc√©', 'test', res.id, data.test_number || '', data.notes || '');
            closeNewTestModal(); loadTests(); toast('Test cr√©√©');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIEW TEST DETAIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function viewTest(id) {
            const r = await fetch('/api/burn-tests/' + id); currentTest = await r.json();
            if (currentTest.error) { toast('Test non trouv√©','error'); return; }
            document.getElementById('detail-title').textContent = 'Test ' + currentTest.test_number + (currentTest.version > 1 ? ' (V' + currentTest.version + ')' : '');

            const cy = currentTest.cycles || [];
            const lastMass = cy.length ? cy[cy.length-1].mass_after : currentTest.initial_mass;
            const totalConsumed = cy.reduce((s,c) => s + (c.mass_consumed||0), 0);
            const pctConsumed = currentTest.initial_mass ? ((currentTest.initial_mass - (lastMass||currentTest.initial_mass)) / currentTest.initial_mass * 100) : 0;

            let html = `
                <!-- Tra√ßabilit√© compl√®te -->
                <div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:1rem; margin-bottom:1rem;">
                    <p style="font-size:0.68rem; text-transform:uppercase; letter-spacing:1px; color:var(--texte-muted); font-weight:600; margin-bottom:0.5rem;">Tra√ßabilit√© compl√®te</p>
                    <div class="grid grid-4" style="gap:0.75rem;">
                        <div><span class="text-muted" style="font-size:0.7rem;">Client</span><br><strong>${currentTest.client_name||'‚Äî'}</strong> ${currentTest.client_company?'<span class="text-muted">('+currentTest.client_company+')</span>':''}</div>
                        <div><span class="text-muted" style="font-size:0.7rem;">√âchantillon</span><br><strong style="color:var(--mfc-cire);">${currentTest.sample_number||'‚Äî'}</strong></div>
                        <div><span class="text-muted" style="font-size:0.7rem;">Formulation</span><br><strong>${currentTest.formulation_code||'‚Äî'}</strong> ${currentTest.formulation_name||''}</div>
                        <div><span class="text-muted" style="font-size:0.7rem;">Statut</span><br><span class="badge badge-${currentTest.status}">${currentTest.status}</span>${currentTest.version > 1 ? '<br><span class="badge" style="margin-top:2px;font-size:0.62rem;background:#e3f2fd;color:#1565c0;">V'+currentTest.version+'</span>' : ''}</div>
                    </div>
                </div>

                <!-- CHA√éNE DE VERSIONS (si reprise) -->
                ${currentTest.retry_from_test_id || currentTest.version > 1 ? '<div id="version-chain" style="background:#e3f2fd;border:1px solid #90caf9;border-radius:var(--radius);padding:0.8rem;margin-bottom:1rem;"><p style="font-size:0.68rem;text-transform:uppercase;color:#1565c0;font-weight:600;margin:0 0 0.4rem;">üîó Cha√Æne de versions</p><div id="version-chain-body" style="font-size:0.82rem;">Chargement...</div></div>' : ''}

                <!-- SUIVI DE MASSE PRINCIPAL -->
                <div style="background:linear-gradient(135deg, var(--fond-surface) 0%, #fff 100%); border:2px solid var(--mfc-cire); border-radius:var(--radius); padding:1.25rem; margin-bottom:1rem;">
                    <p style="font-size:0.72rem; text-transform:uppercase; letter-spacing:1.5px; color:var(--mfc-cire); font-weight:700; margin-bottom:0.75rem;">üìä Suivi de masse de l'√©chantillon</p>
                    
                    <div style="display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap; margin-bottom:1rem;">
                        <div style="background:var(--mfc-cire); color:#fff; padding:0.5rem 0.75rem; border-radius:var(--radius); text-align:center; min-width:90px;">
                            <p style="font-size:0.6rem; text-transform:uppercase; opacity:0.8;">Initiale</p>
                            <p style="font-size:1.3rem; font-weight:700;">${currentTest.initial_mass} g</p>
                        </div>`;
            
            cy.forEach((c, i) => {
                const consumed = c.mass_consumed ? c.mass_consumed.toFixed(1) : (c.mass_before - c.mass_after).toFixed(1);
                html += `
                        <div style="text-align:center; color:var(--mfc-cire);">
                            <span style="font-size:0.65rem; display:block;">C${c.cycle_number}</span>
                            <span style="font-size:1.1rem;">‚Üí</span>
                            <span style="font-size:0.6rem; display:block; color:var(--rouge);">-${consumed}g</span>
                        </div>
                        <div style="background:${i===cy.length-1?'var(--mfc-cire)':'var(--fond-surface)'}; color:${i===cy.length-1?'#fff':'var(--texte)'}; padding:0.5rem 0.75rem; border-radius:var(--radius); text-align:center; min-width:90px; border:1px solid ${i===cy.length-1?'var(--mfc-cire)':'var(--bordure-legere)'};">
                            <p style="font-size:0.6rem; text-transform:uppercase; opacity:0.8;">Apr√®s C${c.cycle_number}</p>
                            <p style="font-size:1.3rem; font-weight:700;">${c.mass_after} g</p>
                        </div>`;
            });
            
            if (cy.length < 4) {
                for (let i = cy.length; i < 4; i++) {
                    html += `
                        <div style="text-align:center; color:var(--bordure-legere);"><span style="font-size:1.1rem;">‚Üí</span></div>
                        <div style="background:var(--fond-page); padding:0.5rem 0.75rem; border-radius:var(--radius); text-align:center; min-width:90px; border:1px dashed var(--bordure-legere);">
                            <p style="font-size:0.6rem; text-transform:uppercase; color:var(--texte-muted);">C${i+1}</p>
                            <p style="font-size:1.3rem; font-weight:700; color:var(--bordure-legere);">? g</p>
                        </div>`;
                }
            }
            
            html += `</div>

                    <!-- Stats r√©sum√© -->
                    <div class="grid grid-4" style="gap:0.5rem; text-align:center;">
                        <div><p style="font-size:0.62rem; text-transform:uppercase; color:var(--texte-muted);">Masse actuelle</p><p style="font-size:1.1rem; font-weight:700;">${lastMass ? lastMass + ' g' : '‚Äî'}</p></div>
                        <div><p style="font-size:0.62rem; text-transform:uppercase; color:var(--texte-muted);">Total consomm√©</p><p style="font-size:1.1rem; font-weight:700; color:var(--rouge);">${totalConsumed ? totalConsumed.toFixed(1) + ' g' : '‚Äî'}</p></div>
                        <div><p style="font-size:0.62rem; text-transform:uppercase; color:var(--texte-muted);">% consomm√©</p><p style="font-size:1.1rem; font-weight:700;">${pctConsumed.toFixed(1)}%</p></div>
                        <div><p style="font-size:0.62rem; text-transform:uppercase; color:var(--texte-muted);">M√®che</p><p style="font-size:1.1rem; font-weight:700; color:var(--mfc-cire);">${currentTest.wick_reference||'‚Äî'}</p></div>
                    </div>
                </div>

                <!-- Barre progression -->
                <div style="background:var(--bordure-legere); border-radius:6px; height:12px; overflow:hidden; margin-bottom:0.5rem; position:relative;">
                    <div style="height:100%; border-radius:6px; background:var(--mfc-cire); width:${pctConsumed}%; transition:width 0.5s;"></div>`;
            // Markers for each cycle
            cy.forEach(c => {
                const cycPct = currentTest.initial_mass ? ((currentTest.initial_mass - c.mass_after) / currentTest.initial_mass * 100) : 0;
                html += `<div style="position:absolute; top:-2px; left:${cycPct}%; width:2px; height:16px; background:var(--texte-secondary); opacity:0.5;" title="Apr√®s C${c.cycle_number}: ${c.mass_after}g"></div>`;
            });
            html += `</div>
                <p class="text-muted text-center" style="font-size:0.75rem; margin-bottom:1rem;">
                    <strong style="color:var(--mfc-cire);">${cy.length} / 4 cycles</strong> effectu√©s ‚Äî 
                    ${cy.length < 4 ? `<span style="color:var(--rouge);">${4 - cy.length} cycle${4-cy.length>1?'s':''} restant${4-cy.length>1?'s':''}</span>` : '<span style="color:var(--vert);">‚úì Test complet</span>'}
                    ‚Äî ${pctConsumed.toFixed(1)}% de masse consomm√©e
                </p>
            `;

            // Cycles
            if (cy.length) {
                html += `<div style="margin-bottom:0.8rem;padding:0.5rem;background:#f3e5f5;border-radius:6px;"><strong style="font-size:0.78rem;">üì∑ Photos du test</strong><div id="photos-grid" style="margin-top:0.4rem;min-height:30px;"></div></div>`;
                html += `<h4 style="font-family:var(--font-display); font-weight:500; margin-bottom:0.75rem;">Cycles de combustion (${cy.length} / 4)</h4>
                <div class="table-container"><table><thead><tr>
                    <th>Cycle</th><th>Masse avant</th><th>Masse apr√®s</th><th>Consomm√©</th>
                    <th>Bain fusion ‚åÄ</th><th>Profondeur</th><th>Hauteur flamme</th><th>Stabilit√©</th><th>Qualit√©</th><th>Diffusion</th>
                </tr></thead><tbody>`;
                cy.forEach((c,i) => {
                    const isAuto = i > 0;
                    const poolInfo = c.pool_visible === 0 ? '<span class="text-muted" style="font-size:0.72rem;">non visible</span>' : (c.pool_diameter ? c.pool_diameter + ' mm' : '‚Äî');
                    const depthInfo = c.pool_visible === 0 ? '' : (c.pool_depth ? c.pool_depth + ' mm' : '‚Äî');
                    html += `<tr>
                        <td><strong style="color:var(--mfc-cire);">Cycle ${c.cycle_number}</strong></td>
                        <td>${c.mass_before} g ${isAuto ? '<span style="font-size:0.7rem; color:var(--vert-texte);" title="Report√© automatiquement du cycle pr√©c√©dent">‚Üê auto</span>' : '<span style="font-size:0.7rem; color:var(--mfc-cire);" title="Masse initiale de la formulation">‚Üê formulation</span>'}</td>
                        <td><strong>${c.mass_after} g</strong></td>
                        <td style="color:var(--rouge); font-weight:600;">${c.mass_consumed ? c.mass_consumed.toFixed(1) + ' g' : '‚Äî'}</td>
                        <td>${poolInfo}</td>
                        <td>${depthInfo}</td>
                        <td>${c.flame_height ? (isNaN(parseFloat(c.flame_height)) ? c.flame_height : c.flame_height + ' mm') : '‚Äî'}</td>
                        <td>${c.flame_stability || '‚Äî'}</td>
                        <td>
                            ${c.mushrooming && c.mushrooming!=='aucun' ? 'üçÑ '+c.mushrooming+' ' : ''}
                            ${c.tunneling && c.tunneling!=='aucun' ? 'üï≥Ô∏è '+c.tunneling+' ' : ''}
                            ${c.smoke_level && c.smoke_level!=='aucune' ? 'üí® '+c.smoke_level : ''}
                            ${(!c.mushrooming||c.mushrooming==='aucun')&&(!c.tunneling||c.tunneling==='aucun')&&(!c.smoke_level||c.smoke_level==='aucune') ? '<span class="text-success">‚úì OK</span>' : ''}
                        </td>
                        <td>${c.scent_throw ? 'üëÉ '+c.scent_throw : '‚Äî'}</td>
                    </tr>`;
                    if (c.notes) html += `<tr><td colspan="9" class="text-muted" style="padding:0.25rem 0.85rem 0.6rem; font-size:0.8rem; font-style:italic;">üìù ${c.notes}</td></tr>`;
                    // Show modifications if any
                    if (c.mod_wick || c.mod_fragrance_pct || c.mod_wax_changes || c.mod_colorant || c.mod_other) {
                        html += `<tr><td colspan="9" style="padding:0.25rem 0.85rem 0.6rem; font-size:0.78rem; background:#fff3e0; border-left:3px solid #e65100;">
                            <strong style="color:#e65100;">üîß Modifications :</strong>
                            ${c.mod_wick ? ' <span style="background:#fff;padding:1px 5px;border-radius:4px;margin:0 2px;">M√®che ‚Üí <strong>'+c.mod_wick+'</strong></span>' : ''}
                            ${c.mod_fragrance_pct ? ' <span style="background:#fff;padding:1px 5px;border-radius:4px;margin:0 2px;">Parfum ‚Üí <strong>'+c.mod_fragrance_pct+'%</strong></span>' : ''}
                            ${c.mod_wax_changes ? ' <span style="background:#fff;padding:1px 5px;border-radius:4px;margin:0 2px;">Cires: <strong>'+c.mod_wax_changes+'</strong></span>' : ''}
                            ${c.mod_colorant ? ' <span style="background:#fff;padding:1px 5px;border-radius:4px;margin:0 2px;">Colorant: <strong>'+c.mod_colorant+'</strong></span>' : ''}
                            ${c.mod_other ? ' <span style="background:#fff;padding:1px 5px;border-radius:4px;margin:0 2px;">'+c.mod_other+'</span>' : ''}
                            ${c.mod_notes ? '<br><span style="font-style:italic;color:#e65100;">Raison : '+c.mod_notes+'</span>' : ''}
                        </td></tr>`;
                    }
                });
                html += '</tbody></table></div>';

                // R√©sum√© de la cha√Æne de masse
                html += `<div style="background:var(--fond-surface); border:1px solid var(--bordure-legere); border-radius:var(--radius); padding:0.75rem 1rem; margin-top:1rem;">
                    <p style="font-size:0.72rem; text-transform:uppercase; letter-spacing:1px; color:var(--texte-muted); font-weight:600; margin-bottom:0.4rem;">Cha√Æne de masse automatique</p>
                    <p style="font-size:0.85rem; color:var(--texte-secondary);">`;
                html += `<strong style="color:var(--mfc-cire);">${currentTest.initial_mass}g</strong> <span class="text-muted">(formulation)</span>`;
                cy.forEach(c => { html += ` ‚Üí <strong>${c.mass_after}g</strong> <span class="text-muted">(apr√®s C${c.cycle_number})</span>`; });
                html += `</p></div>`;
            } else {
                html += '<div class="empty-state" style="padding:2rem;"><div class="icon">‚è±Ô∏è</div><p>Aucun cycle ‚Äî Cliquez ¬´ Ajouter un cycle ¬ª pour commencer</p></div>';
            }

            if (currentTest.conclusion) html += `<div class="divider"></div><p class="text-muted" style="font-size:0.68rem; text-transform:uppercase;">Conclusion</p><p>${currentTest.conclusion}</p>`;

            // Client validation status banner
            if (currentTest.client_status) {
                const isVal = currentTest.client_status === 'valid√©';
                html += `<div class="divider"></div>
                    <div style="background:${isVal?'#e8f5e9':'#fbe9e7'};border:1px solid ${isVal?'#a5d6a7':'#ef9a9a'};border-radius:var(--radius);padding:1rem;margin-top:0.5rem;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem;">
                            <strong style="color:${isVal?'#2e7d32':'#c62828'};">${isVal?'‚úì Valid√© par le client':'‚úó Refus√© par le client'}</strong>
                            <span class="text-muted" style="font-size:0.7rem;">${currentTest.client_decision_date||''}</span>
                        </div>
                        <p style="font-size:0.85rem;line-height:1.5;margin:0;font-style:italic;">¬´ ${currentTest.client_feedback||''} ¬ª</p>
                        ${currentTest.retry_from_test_id ? '<p style="font-size:0.72rem;color:var(--texte-muted);margin:0.3rem 0 0;">üîÑ Reprise du test pr√©c√©dent</p>' : ''}
                    </div>`;
            }

            document.getElementById('detail-body').innerHTML = html;
            const cyclesDone = cy.length;
            const remaining = 4 - cyclesDone;
            const isTermin√© = currentTest.status === 'termin√©';
            const hasClientDecision = !!currentTest.client_status;
            const isRefus√© = currentTest.client_status === 'refus√©';

            // Cycle add button: hide if 4 cycles done or test finished
            document.getElementById('btn-add-cycle').style.display = (currentTest.status === 'en_cours' && cyclesDone < 4) ? '' : 'none';
            document.getElementById('btn-add-cycle').innerHTML = remaining > 0 ? `+ Cycle ${cyclesDone+1}/4` : '';
            // Finish button: only after at least 1 cycle
            document.getElementById('btn-finish').style.display = (currentTest.status === 'en_cours' && cyclesDone > 0) ? '' : 'none';
            // Report button: visible when 4 cycles done or test terminated
            document.getElementById('btn-report').style.display = (cyclesDone === 4 || isTermin√©) ? '' : 'none';
            document.getElementById('btn-pdf').style.display = (cyclesDone === 4 || isTermin√©) ? '' : 'none';
            loadPhotos();
            // Client validation buttons: when termin√© and no decision yet, OR to change decision
            document.getElementById('btn-client-val').style.display = (isTermin√© && (!hasClientDecision || isRefus√©)) ? '' : 'none';
            document.getElementById('btn-client-ref').style.display = (isTermin√© && (!hasClientDecision || currentTest.client_status === 'valid√©')) ? '' : 'none';
            // Change label if already has decision
            if (hasClientDecision) {
                document.getElementById('btn-client-val').innerHTML = isRefus√© ? 'üîÑ Finalement valid√©' : 'üë§ Client valide';
                document.getElementById('btn-client-ref').innerHTML = currentTest.client_status === 'valid√©' ? 'üîÑ Finalement refus√©' : 'üë§ Client refuse';
            } else {
                document.getElementById('btn-client-val').innerHTML = 'üë§ Client valide';
                document.getElementById('btn-client-ref').innerHTML = 'üë§ Client refuse';
            }
            // Retry button: when client refused
            document.getElementById('btn-retry').style.display = isRefus√© ? '' : 'none';

            document.getElementById('detail-modal').classList.add('active');
            
            // Load version chain if needed
            if (currentTest.retry_from_test_id || currentTest.version > 1) {
                loadVersionChain(currentTest.id);
            }
        }

        function closeDetailModal() { document.getElementById('detail-modal').classList.remove('active'); currentTest = null; }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CYCLE ‚Äî MASSE AUTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openCycleModal() {
            if (!currentTest) return;
            document.getElementById('cycle-form').reset();
            document.getElementById('c_consumed').value = '';
            document.getElementById('consumed-pct').textContent = '';
            const cy = currentTest.cycles || [];
            const n = cy.length + 1;
            
            if (n > 4) { toast('4 cycles maximum atteints', 'error'); return; }
            
            document.getElementById('cycle-title').textContent = `Cycle ${n} ‚Äî ${currentTest.test_number}`;
            document.getElementById('cycle-num').textContent = n;

            // MASSE AUTOMATIQUE
            let autoMass;
            if (cy.length === 0) {
                autoMass = currentTest.initial_mass;
                document.getElementById('mass-hint').innerHTML = '‚Üê <strong>Masse initiale</strong> de la formulation';
            } else {
                autoMass = cy[cy.length-1].mass_after;
                document.getElementById('mass-hint').innerHTML = `‚Üê <strong>Masse apr√®s cycle ${cy.length}</strong> (report automatique)`;
            }
            document.getElementById('c_pool_visible').checked = true;
            togglePoolFields();
            document.getElementById('c_mass_before').value = autoMass || '';
            document.getElementById('mass-before-display').textContent = (autoMass || '‚Äî') + ' g';
            document.getElementById('cycle-modal').classList.add('active');
            // Focus on mass_after
            setTimeout(() => document.getElementById('c_mass_after').focus(), 200);
        }
        function closeCycleModal() { document.getElementById('cycle-modal').classList.remove('active'); }

        function togglePoolFields() {
            const visible = document.getElementById('c_pool_visible').checked;
            document.getElementById('pool-fields').style.display = visible ? '' : 'none';
            document.getElementById('pool-not-visible').style.display = visible ? 'none' : '';
            if (!visible) {
                document.getElementById('c_pool').value = '';
                document.getElementById('c_pool_depth').value = '';
            }
        }

        function calcConsumed() {
            const b = parseFloat(document.getElementById('c_mass_before').value);
            const a = parseFloat(document.getElementById('c_mass_after').value);
            if (!isNaN(b) && !isNaN(a) && a < b) {
                const consumed = b - a;
                document.getElementById('c_consumed').value = consumed.toFixed(1) + ' g';
                const pct = currentTest.initial_mass ? (consumed / currentTest.initial_mass * 100).toFixed(1) : '?';
                document.getElementById('consumed-pct').textContent = `soit ${pct}% de la masse initiale (${currentTest.initial_mass}g)`;
            } else {
                document.getElementById('c_consumed').value = '';
                document.getElementById('consumed-pct').textContent = '';
            }
        }

        async function saveCycle() {
            if (!currentTest) return;
            const mb = parseFloat(document.getElementById('c_mass_before').value);
            const ma = parseFloat(document.getElementById('c_mass_after').value);
            if (isNaN(mb)||isNaN(ma)) { toast('Masses obligatoires','error'); return; }
            if (ma >= mb) { toast('Masse apr√®s doit √™tre < masse avant','error'); return; }
            const cy = currentTest.cycles || [];
            const data = {
                cycle_number: cy.length + 1, duration_minutes: 240,
                mass_before: mb, mass_after: ma,
                pool_diameter: parseFloat(document.getElementById('c_pool').value) || null,
                pool_depth: parseFloat(document.getElementById('c_pool_depth').value) || null,
                pool_visible: document.getElementById('c_pool_visible').checked ? 1 : 0,
                flame_height: parseFloat(document.getElementById('c_flame').value) || null,
                flame_stability: document.getElementById('c_stability').value || null,
                smoke_level: document.getElementById('c_smoke').value || null,
                soot_level: document.getElementById('c_soot').value || null,
                mushrooming: document.getElementById('c_mushroom').value || null,
                tunneling: document.getElementById('c_tunnel').value || null,
                scent_throw: document.getElementById('c_scent').value || null,
                notes: document.getElementById('c_notes').value || null,
                mod_wick: document.getElementById('c_mod_wick').value || null,
                mod_fragrance_pct: parseFloat(document.getElementById('c_mod_frag').value) || null,
                mod_wax_changes: document.getElementById('c_mod_wax').value || null,
                mod_colorant: document.getElementById('c_mod_color').value || null,
                mod_other: document.getElementById('c_mod_other').value || null,
                mod_notes: document.getElementById('c_mod_notes').value || null
            };
            const r = await fetch(`/api/burn-tests/${currentTest.id}/cycles`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            const res = await r.json();
            if (res.error) { toast(res.error,'error'); return; }
            closeCycleModal();
            const modMsg = res.has_modifications ? ' ‚Äî Modifications enregistr√©es en base IA' : '';
            mfcLogActivity('cycle_enregistr√©', 'cycle', currentTest.id, currentTest.test_number, 'Cycle ' + data.cycle_number + ' ‚Äî ' + ma + 'g');
            toast(`Cycle ${data.cycle_number} enregistr√© ‚Äî ${ma}g${modMsg}`);
            await viewTest(currentTest.id); loadTests();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FINISH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function finishTest() {
            if (!currentTest) return;
            const conc = prompt('Conclusion du test (optionnel) :');
            await fetch(`/api/burn-tests/${currentTest.id}`, { method:'PUT', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ status:'termin√©', end_date:new Date().toISOString().slice(0,10), conclusion:conc||null, notes:currentTest.notes }) });
            toast('Test termin√©'); closeDetailModal(); loadTests();
        }

        async function deleteTest(id) {
            if (confirm('Supprimer ce test et ses cycles ?')) { await fetch('/api/burn-tests/'+id,{method:'DELETE'}); loadTests(); toast('Supprim√©'); }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RAPPORT IA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function closeReportModal() { document.getElementById('report-modal').classList.remove('active'); }

        function downloadPDF() {
            const testId = currentTestId;
            if (!testId) return;
            window.open('/api/burn-tests/' + testId + '/pdf', '_blank');
        }

        async function uploadPhotos(files) {
            if (!files.length || !currentTestId) return;
            const formData = new FormData();
            for (const f of files) formData.append('photos', f);
            try {
                const r = await fetch('/api/photos/cycle/' + currentTestId, { method: 'POST', body: formData });
                const d = await r.json();
                if (d.success) { toast(d.files.length + ' photo(s) ajout√©e(s)'); loadPhotos(); }
                else toast(d.error || 'Erreur upload', 'error');
            } catch(e) { toast('Erreur upload: ' + e.message, 'error'); }
            document.getElementById('photo-input').value = '';
        }

        async function loadPhotos() {
            if (!currentTestId) return;
            try {
                const r = await fetch('/api/photos/cycle/' + currentTestId);
                const photos = await r.json();
                const container = document.getElementById('photos-grid');
                if (!container) return;
                if (!photos.length) { container.innerHTML = '<em style="color:#999;font-size:0.8rem;">Aucune photo</em>'; return; }
                container.innerHTML = photos.map(p => `
                    <div style="display:inline-block;margin:4px;position:relative;">
                        <img src="${p.filepath}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #ddd;cursor:pointer;" onclick="window.open('${p.filepath}','_blank')">
                        <button onclick="deletePhoto(${p.id})" style="position:absolute;top:-4px;right:-4px;background:#c62828;color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:10px;cursor:pointer;line-height:18px;">√ó</button>
                    </div>
                `).join('');
            } catch(e) {}
        }

        async function deletePhoto(id) {
            if (!confirm('Supprimer cette photo ?')) return;
            await fetch('/api/photos/' + id, { method: 'DELETE' });
            loadPhotos();
        }

        async function generateReport() {
            if (!currentTest) return;
            const t = currentTest;
            const cy = t.cycles || [];
            if (cy.length === 0) { toast('Aucun cycle √† analyser', 'error'); return; }
            const clientMode = document.getElementById('client-mode').checked;

            let form = null, waxes = [];
            if (t.formulation_id) {
                try { const r = await fetch('/api/formulations/' + t.formulation_id); form = await r.json(); waxes = form.waxes || []; } catch(e) {}
            }

            // ‚îÄ‚îÄ ANALYSE ‚îÄ‚îÄ
            const avgPool = cy.reduce((s,c) => s + (c.pool_diameter||0), 0) / cy.length;
            const depthVals = cy.filter(c => c.pool_depth && c.pool_visible !== 0);
            const avgDepth = depthVals.length ? depthVals.reduce((s,c) => s + c.pool_depth, 0) / depthVals.length : 0;
            const avgFlame = cy.reduce((s,c) => s + (c.flame_height||0), 0) / cy.length;
            const consumptions = cy.map(c => c.mass_before - c.mass_after);
            const avgConsumed = consumptions.reduce((a,b) => a+b, 0) / consumptions.length;
            const totalConsumed = t.initial_mass - (cy[cy.length-1]?.mass_after || t.initial_mass);
            const pctConsumed = (totalConsumed / t.initial_mass * 100);
            const avgC = consumptions.reduce((a,b) => a+b, 0) / consumptions.length;
            const variance = consumptions.reduce((s,c) => s + Math.pow(c - avgC, 2), 0) / consumptions.length;
            const stdDev = Math.sqrt(variance);
            const stabilityScore = Math.max(0, 10 - stdDev * 2);
            const flameScores = cy.map(c => { let s=5; if(c.flame_stability==='stable')s+=3;else if(c.flame_stability==='instable')s-=2; if(c.flame_height&&c.flame_height>=15&&c.flame_height<=30)s+=2;else if(c.flame_height)s-=1; return Math.min(10,Math.max(0,s)); });
            const flameScore = flameScores.reduce((a,b)=>a+b,0)/flameScores.length;
            const qualityScores = cy.map(c => { let s=10; if(c.mushrooming==='l√©ger')s-=1;else if(c.mushrooming==='mod√©r√©')s-=3;else if(c.mushrooming==='important')s-=5; if(c.tunneling==='l√©ger')s-=1;else if(c.tunneling==='mod√©r√©')s-=3;else if(c.tunneling==='important')s-=5; if(c.smoke_level==='l√©g√®re')s-=1;else if(c.smoke_level==='moyenne')s-=2;else if(c.smoke_level==='forte')s-=4; if(c.soot_level==='l√©g√®re')s-=1;else if(c.soot_level==='moyenne')s-=2;else if(c.soot_level==='forte')s-=4; return Math.max(0,s); });
            const qualityScore = qualityScores.reduce((a,b)=>a+b,0)/qualityScores.length;
            const scentMap={'faible':3,'mod√©r√©e':5,'bonne':8,'excellente':10};
            const scentScores=cy.map(c=>scentMap[c.scent_throw]||5);
            const scentScore=scentScores.reduce((a,b)=>a+b,0)/scentScores.length;
            const diam=form?(form.diameter||form.sample_diameter):null;
            let poolScore=5;
            if(diam){const ratio=avgPool/diam;if(ratio>=0.9)poolScore=10;else if(ratio>=0.8)poolScore=8;else if(ratio>=0.7)poolScore=6;else poolScore=4;}else if(avgPool>50)poolScore=7;
            const weights={stability:0.20,flame:0.15,quality:0.25,scent:0.20,pool:0.20};
            const globalScore=(stabilityScore*weights.stability+flameScore*weights.flame+qualityScore*weights.quality+scentScore*weights.scent+poolScore*weights.pool);

            // ‚îÄ‚îÄ DUR√âE DE COMBUSTION TH√âORIQUE ‚îÄ‚îÄ
            const consumPerHour = avgConsumed / 4;
            const totalBurnableInitial = t.initial_mass * 0.92;
            const theoreticalHours = consumPerHour > 0 ? totalBurnableInitial / consumPerHour : 0;
            const hoursCompleted = cy.length * 4;
            const regularityCoeff = avgConsumed > 0 ? Math.max(0, 1 - (stdDev / avgConsumed)) : 0;

            // Wax data (internal)
            let waxAnalysis='',congealInfo='',penetrationInfo='',oilInfo='',waxDetailRows='';
            if(waxes.length&&!clientMode){
                waxAnalysis=waxes.map(w=>'<strong>'+(w.wax_name||w.reference||'?')+'</strong> ‚Äî '+w.percentage+'%'+(w.supplier_name?' ('+w.supplier_name+')':'')).join('<br>');
                try{
                    const wr=await fetch('/api/waxes');const allW=await wr.json();
                    const wd=waxes.map(fw=>({...fw,...(allW.find(w=>w.id===fw.wax_id)||{})}));
                    let cpW=0,cpT=0,pnW=0,pnT=0,olW=0,olT=0;
                    wd.forEach((w,i)=>{
                        // Moyennes pond√©r√©es
                        if(w.congealing_point_min&&w.congealing_point_max){cpW+=((w.congealing_point_min+w.congealing_point_max)/2)*(w.percentage/100);cpT+=w.percentage;}
                        else if(w.congealing_point){cpW+=w.congealing_point*(w.percentage/100);cpT+=w.percentage;}
                        if(w.penetration_min&&w.penetration_max){pnW+=((w.penetration_min+w.penetration_max)/2)*(w.percentage/100);pnT+=w.percentage;}
                        else if(w.penetration){pnW+=w.penetration*(w.percentage/100);pnT+=w.percentage;}
                        if(w.oil_content_min!=null&&w.oil_content_max!=null){olW+=((w.oil_content_min+w.oil_content_max)/2)*(w.percentage/100);olT+=w.percentage;}
                        else if(w.oil_content!=null){olW+=w.oil_content*(w.percentage/100);olT+=w.percentage;}
                        // Tableau d√©taill√©
                        const bg=i%2===0?'#fff':'#f8f5f0';
                        const cpRange=(w.congealing_point_min&&w.congealing_point_max)?w.congealing_point_min+'‚Äì'+w.congealing_point_max+'¬∞C':(w.congealing_point?w.congealing_point+'¬∞C':'‚Äî');
                        const pnRange=(w.penetration_min&&w.penetration_max)?w.penetration_min+'‚Äì'+w.penetration_max:(w.penetration?''+w.penetration:'‚Äî');
                        const olRange=(w.oil_content_min!=null&&w.oil_content_max!=null)?w.oil_content_min+'‚Äì'+w.oil_content_max+'%':(w.oil_content!=null?w.oil_content+'%':'‚Äî');
                        const mp=w.melting_point?w.melting_point+'¬∞C':'‚Äî';
                        waxDetailRows+='<tr style="background:'+bg+';"><td style="padding:4px 8px;border-bottom:1px solid #eee;font-weight:600;">'+(w.wax_name||w.reference||'?')+'<br><span style="font-size:0.68rem;color:#888;">R√©f: '+(w.reference||'‚Äî')+'</span></td><td style="border-bottom:1px solid #eee;text-align:center;">'+(w.type||'‚Äî')+'</td><td style="border-bottom:1px solid #eee;text-align:center;font-weight:700;">'+w.percentage+'%</td><td style="border-bottom:1px solid #eee;text-align:center;">'+cpRange+'</td><td style="border-bottom:1px solid #eee;text-align:center;">'+pnRange+'</td><td style="border-bottom:1px solid #eee;text-align:center;">'+olRange+'</td><td style="border-bottom:1px solid #eee;text-align:center;">'+mp+'</td></tr>';
                    });
                    if(cpT>0)congealInfo=cpW.toFixed(1)+'¬∞C';
                    if(pnT>0)penetrationInfo=pnW.toFixed(1)+' (0.1mm)';
                    if(olT>0)oilInfo=olW.toFixed(2)+'%';
                }catch(e){console.error('Erreur d√©tails cires:',e);}
            }

            // Avis
            let avis='';
            if(globalScore>=8)avis=clientMode?'Excellente performance. Cette bougie offre une combustion r√©guli√®re, un bassin de fusion homog√®ne et une diffusion olfactive remarquable. Formulation pr√™te pour production.':'Excellent r√©sultat. Formulation valid√©e pour production.';
            else if(globalScore>=6.5)avis=clientMode?'Bonne performance globale. La bougie br√ªle de mani√®re satisfaisante avec quelques optimisations mineures possibles.':'Bon r√©sultat avec points d\'am√©lioration mineurs.';
            else if(globalScore>=5)avis=clientMode?'Performance correcte. Des ajustements sont en cours pour am√©liorer la combustion et la restitution olfactive.':'R√©sultat moyen. Ajustements n√©cessaires.';
            else avis=clientMode?'Cette formulation n√©cessite des modifications compl√©mentaires. Notre laboratoire travaille activement √† son optimisation.':'R√©sultat insuffisant. R√©vision n√©cessaire.';

            let recos=[];
            if(qualityScore<7&&cy.some(c=>c.tunneling&&c.tunneling!=='aucun'))recos.push(clientMode?'Effet tunnel d√©tect√© ‚Äî des ajustements techniques sont pr√©vus.':'Effet tunnel ‚Äî m√®che calibre sup√©rieur ou duret√© cire.');
            if(qualityScore<7&&cy.some(c=>c.mushrooming&&c.mushrooming!=='aucun'))recos.push(clientMode?'Champignonnage observ√© ‚Äî ajustement en cours.':'Champignonnage ‚Äî v√©rifier m√®che et charge parfum.');
            if(scentScore<6)recos.push(clientMode?'Diffusion parfum √† optimiser.':'Diffusion insuffisante ‚Äî augmenter % ou meilleur diffusion √† chaud.');
            if(stabilityScore<7)recos.push(clientMode?'R√©gularit√© de combustion √† am√©liorer.':'Consommation irr√©guli√®re ‚Äî homog√©n√©it√© m√©lange.');
            if(poolScore<6)recos.push(clientMode?'Bassin de fusion √† optimiser.':'Bassin incomplet ‚Äî m√®che plus large.');
            if(flameScore<6)recos.push(clientMode?'Flamme √† stabiliser.':'Flamme instable ‚Äî ajuster m√®che ou point √©clair.');
            if(!recos.length)recos.push(clientMode?'Aucun d√©faut majeur. Formulation valid√©e.':'Aucun d√©faut. Valid√©e pour production.');

            const sc=(s)=>s>=8?'#388e3c':s>=6.5?'#e67e22':s>=4?'#d84315':'#c62828';
            const scoreBar=(s,label)=>'<div style="margin-bottom:0.5rem;"><div style="display:flex;justify-content:space-between;margin-bottom:2px;"><span style="font-size:0.75rem;">'+label+'</span><strong style="color:'+sc(s)+';font-size:0.85rem;">'+s.toFixed(1)+'/10</strong></div><div style="background:#e8e4de;border-radius:4px;height:7px;overflow:hidden;"><div style="height:100%;width:'+(s*10)+'%;background:'+sc(s)+';border-radius:4px;"></div></div></div>';
            const clientName=form?(form.client_name||''):(t.client_name||'');
            const candleDiam=diam||'‚Äî';
            const candleHeight=form?(form.height||form.sample_height||'‚Äî'):'‚Äî';
            const candleType=form?(form.container_type||form.sample_type||''):'';

            let rhtml='<div style="font-family:Open Sans,sans-serif;color:#2c2c2c;line-height:1.5;">';

            // ‚îÄ‚îÄ EN-T√äTE ‚îÄ‚îÄ
            if(clientMode){
                rhtml+='<div style="background:linear-gradient(135deg,#1a1a1a,#333);color:#fff;padding:1.2rem 1.5rem;border-radius:8px;margin-bottom:1.5rem;"><div style="display:flex;justify-content:space-between;align-items:center;"><div><p style="font-size:0.6rem;text-transform:uppercase;letter-spacing:3px;color:#c9a96e;margin:0;">Maison Fran√ßaise des Cires ‚Äî Ma√Ætre Cirier depuis 1904</p><h2 style="font-family:Playfair Display,serif;margin:0.3rem 0 0;font-size:1.5rem;color:#f0e6d3;">Rapport d\'essai</h2></div><div style="text-align:right;"><p style="font-size:0.7rem;color:#999;margin:0;">R√©f. '+t.test_number.replace(/-F\d+(-T\d+)?$/,'')+'</p><p style="font-size:0.7rem;color:#999;margin:0;">'+new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'})+'</p></div></div></div>';
                if(clientName)rhtml+='<p style="font-size:0.82rem;color:#666;margin-bottom:1rem;">Client : <strong>'+clientName+'</strong></p>';
                rhtml+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem;"><div style="background:#faf8f5;border:1px solid #e8e4de;border-radius:8px;padding:1rem;text-align:center;"><p style="font-size:0.55rem;text-transform:uppercase;letter-spacing:1px;color:#999;margin:0 0 0.3rem;">Type</p><p style="font-size:1rem;font-weight:600;margin:0;">'+(candleType||'Container')+'</p></div><div style="background:#faf8f5;border:1px solid #e8e4de;border-radius:8px;padding:1rem;text-align:center;"><p style="font-size:0.55rem;text-transform:uppercase;letter-spacing:1px;color:#999;margin:0 0 0.3rem;">Dimensions</p><p style="font-size:1rem;font-weight:600;margin:0;">'+candleDiam+' √ó '+candleHeight+' mm</p></div><div style="background:#faf8f5;border:1px solid #e8e4de;border-radius:8px;padding:1rem;text-align:center;"><p style="font-size:0.55rem;text-transform:uppercase;letter-spacing:1px;color:#999;margin:0 0 0.3rem;">Masse</p><p style="font-size:1rem;font-weight:600;margin:0;">'+t.initial_mass+' g</p></div></div>';
            } else {
                rhtml+='<div style="background:#c62828;color:#fff;text-align:center;padding:0.5rem;border-radius:6px;margin-bottom:1rem;font-size:0.72rem;letter-spacing:1px;text-transform:uppercase;">‚ö† Document interne ‚Äî Donn√©es confidentielles</div>';
                rhtml+='<div style="text-align:center;margin-bottom:1rem;"><p style="font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:#888;">MFC Laboratoire ‚Äî Rapport de test</p><h2 style="color:#a32d03;margin:0.3rem 0;">'+t.test_number+'</h2><p style="font-size:0.8rem;color:#666;">'+(form?form.name||'':'')+' ‚Äî '+(t.wick_reference||'')+'</p><p style="font-size:0.7rem;color:#999;">G√©n√©r√© le '+new Date().toLocaleDateString('fr-FR')+' ‚Äî '+cy.length+' cycles</p></div>';
            }

            // ‚îÄ‚îÄ SCORE GLOBAL ‚îÄ‚îÄ
            rhtml+='<div style="text-align:center;margin-bottom:1.5rem;"><div style="display:inline-block;width:130px;height:130px;border-radius:50%;border:6px solid '+sc(globalScore)+';position:relative;"><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;"><p style="font-size:2.4rem;font-weight:700;color:'+sc(globalScore)+';line-height:1;margin:0;">'+globalScore.toFixed(1)+'</p><p style="font-size:0.55rem;text-transform:uppercase;color:#999;margin:0;">/10</p></div></div><p style="font-size:0.9rem;font-weight:600;margin-top:0.5rem;color:'+sc(globalScore)+';">'+(globalScore>=8?'EXCELLENT':globalScore>=6.5?'BON':globalScore>=5?'MOYEN':'INSUFFISANT')+'</p></div>';

            // ‚îÄ‚îÄ DUR√âE DE COMBUSTION TH√âORIQUE ‚îÄ‚îÄ
            rhtml+='<div style="background:linear-gradient(135deg,#faf8f5,#f0ece5);border:1px solid #d4cfc6;border-radius:8px;padding:1.2rem;margin-bottom:1.5rem;">';
            rhtml+='<p style="font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:#888;margin:0 0 0.8rem;font-weight:600;">‚è± Estimation de la dur√©e de combustion</p>';
            rhtml+='<div style="display:grid;grid-template-columns:repeat('+(clientMode?3:4)+',1fr);gap:1rem;text-align:center;">';
            rhtml+='<div><p style="font-size:1.6rem;font-weight:700;color:#1a1a1a;margin:0;">'+theoreticalHours.toFixed(0)+'<span style="font-size:0.8rem;font-weight:400;color:#666;">h</span></p><p style="font-size:0.62rem;color:#888;margin:0;">Dur√©e totale estim√©e</p></div>';
            rhtml+='<div><p style="font-size:1.6rem;font-weight:700;color:#a32d03;margin:0;">'+consumPerHour.toFixed(1)+'<span style="font-size:0.8rem;font-weight:400;color:#666;">g/h</span></p><p style="font-size:0.62rem;color:#888;margin:0;">Consommation horaire</p></div>';
            rhtml+='<div><p style="font-size:1.6rem;font-weight:700;color:'+(regularityCoeff>=0.8?'#388e3c':'#e67e22')+';margin:0;">'+(regularityCoeff*100).toFixed(0)+'<span style="font-size:0.8rem;font-weight:400;color:#666;">%</span></p><p style="font-size:0.62rem;color:#888;margin:0;">Indice de r√©gularit√©</p></div>';
            if(!clientMode)rhtml+='<div><p style="font-size:1.6rem;font-weight:700;color:#555;margin:0;">'+hoursCompleted+'<span style="font-size:0.8rem;font-weight:400;color:#666;">h</span> / '+theoreticalHours.toFixed(0)+'h</p><p style="font-size:0.62rem;color:#888;margin:0;">Test√©es / total</p></div>';
            rhtml+='</div>';
            rhtml+='<div style="margin-top:0.8rem;background:#e8e4de;border-radius:4px;height:8px;overflow:hidden;"><div style="height:100%;width:'+Math.min(100,(theoreticalHours>0?hoursCompleted/theoreticalHours*100:0))+'%;background:linear-gradient(90deg,#a32d03,#c9a96e);border-radius:4px;"></div></div>';
            rhtml+='<p style="font-size:0.65rem;color:#999;margin:0.3rem 0 0;text-align:center;">Protocole : cycles de 4h ‚Äî '+cy.length+' cycles r√©alis√©s ('+hoursCompleted+'h) ‚Äî '+pctConsumed.toFixed(1)+'% de masse consomm√©e</p></div>';

            // ‚îÄ‚îÄ SCORES D√âTAILL√âS ‚îÄ‚îÄ
            rhtml+='<div style="margin-bottom:1.5rem;"><p style="font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:#888;margin:0 0 0.8rem;font-weight:600;border-bottom:2px solid #e8e4de;padding-bottom:0.3rem;">Analyse d√©taill√©e</p><div style="background:#faf8f5;border:1px solid #e8e4de;border-radius:8px;padding:1rem;">';
            rhtml+=scoreBar(stabilityScore,'üîÑ R√©gularit√© de combustion ('+weights.stability*100+'%)');
            rhtml+=scoreBar(flameScore,'üî• Comportement de flamme ('+weights.flame*100+'%)');
            rhtml+=scoreBar(qualityScore,'‚ú® Qualit√© ‚Äî absence de d√©fauts ('+weights.quality*100+'%)');
            rhtml+=scoreBar(scentScore,'üëÉ Restitution olfactive ('+weights.scent*100+'%)');
            rhtml+=scoreBar(poolScore,'ü´† Bassin de fusion ('+weights.pool*100+'%)');
            rhtml+='</div></div>';

            // ‚îÄ‚îÄ MATI√àRES (interne) ‚îÄ‚îÄ
            if(!clientMode&&(congealInfo||penetrationInfo||oilInfo||waxAnalysis)){
                rhtml+='<div style="margin-bottom:1.5rem;"><p style="font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:#888;margin:0 0 0.8rem;font-weight:600;border-bottom:2px solid #e8e4de;padding-bottom:0.3rem;">Caract√©ristiques mati√®res</p><div style="background:#faf8f5;border:1px solid #e8e4de;border-radius:8px;padding:1rem;">';
                
                // Moyennes pond√©r√©es du m√©lange
                rhtml+='<p style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:#888;margin:0 0 0.5rem;font-weight:600;">Moyennes pond√©r√©es du m√©lange</p>';
                rhtml+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;text-align:center;margin-bottom:1rem;">';
                rhtml+='<div><p style="font-size:0.55rem;text-transform:uppercase;color:#999;">Point de cong√©lation</p><p style="font-size:1.1rem;font-weight:700;color:#a32d03;">'+(congealInfo||'‚Äî')+'</p></div>';
                rhtml+='<div><p style="font-size:0.55rem;text-transform:uppercase;color:#999;">P√©n√©tration</p><p style="font-size:1.1rem;font-weight:700;color:#a32d03;">'+(penetrationInfo||'‚Äî')+'</p></div>';
                rhtml+='<div><p style="font-size:0.55rem;text-transform:uppercase;color:#999;">Teneur en huile</p><p style="font-size:1.1rem;font-weight:700;color:#a32d03;">'+(oilInfo||'‚Äî')+'</p></div></div>';
                
                // Tableau d√©taill√© par cire
                if(waxDetailRows){
                    rhtml+='<p style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:#888;margin:0.5rem 0;font-weight:600;border-top:1px solid #e8e4de;padding-top:0.75rem;">D√©tail par cire</p>';
                    rhtml+='<table style="font-size:0.76rem;border-collapse:collapse;width:100%;"><thead><tr style="background:#e8e2d8;"><th style="padding:5px 8px;text-align:left;">Cire</th><th>Type</th><th>%</th><th>Pt cong√©lation</th><th>P√©n√©tration</th><th>Teneur huile</th><th>Pt fusion</th></tr></thead><tbody>';
                    rhtml+=waxDetailRows;
                    rhtml+='</tbody></table>';
                }
                
                rhtml+='</div></div>';
            }

            // ‚îÄ‚îÄ CYCLES ‚îÄ‚îÄ
            rhtml+='<div style="margin-bottom:1.5rem;"><p style="font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:#888;margin:0 0 0.8rem;font-weight:600;border-bottom:2px solid #e8e4de;padding-bottom:0.3rem;">R√©sultats par cycle</p><div class="table-container"><table style="font-size:0.78rem;border-collapse:collapse;width:100%;"><thead><tr style="background:#1a1a1a;color:#f0e6d3;"><th style="padding:6px 8px;border:none;">Cycle</th><th style="border:none;">Masse av.</th><th style="border:none;">Masse ap.</th><th style="border:none;">Consomm√©</th><th style="border:none;">Bain fusion ‚åÄ</th>'+(clientMode?'':'<th style="border:none;">Profondeur</th>')+'<th style="border:none;">Hauteur flamme</th><th style="border:none;">Stabilit√©</th><th style="border:none;">Diffusion</th><th style="border:none;">Score</th></tr></thead><tbody>';
            cy.forEach((c,i)=>{
                const cons=c.mass_before-c.mass_after;
                const cycleScore=(qualityScores[i]*0.4+flameScores[i]*0.2+scentScores[i]*0.3+stabilityScore*0.1);
                const poolCell=c.pool_visible===0?'<span style="color:#bbb;">n/v</span>':(c.pool_diameter?c.pool_diameter+' mm':'‚Äî');
                const depthCell=c.pool_visible===0?'':(c.pool_depth?c.pool_depth+' mm':'‚Äî');
                const isNumFlame=c.flame_height&&!isNaN(parseFloat(c.flame_height));
                const flameCell=c.flame_height?(isNumFlame?c.flame_height+' mm':c.flame_height):'‚Äî';
                const stabilityCell=c.flame_stability||'‚Äî';
                const bg=i%2===0?'#fff':'#faf8f5';
                rhtml+='<tr style="background:'+bg+';"><td style="padding:5px 8px;border-bottom:1px solid #eee;font-weight:700;">C'+c.cycle_number+'</td><td style="border-bottom:1px solid #eee;">'+c.mass_before+'g</td><td style="border-bottom:1px solid #eee;font-weight:600;">'+c.mass_after+'g</td><td style="border-bottom:1px solid #eee;color:#c62828;font-weight:600;">-'+cons.toFixed(1)+'g</td><td style="border-bottom:1px solid #eee;">'+poolCell+'</td>'+(clientMode?'':'<td style="border-bottom:1px solid #eee;">'+depthCell+'</td>')+'<td style="border-bottom:1px solid #eee;">'+flameCell+'</td><td style="border-bottom:1px solid #eee;color:#666;">'+stabilityCell+'</td><td style="border-bottom:1px solid #eee;">'+(c.scent_throw||'‚Äî')+'</td><td style="border-bottom:1px solid #eee;font-weight:700;color:'+sc(cycleScore)+';">'+cycleScore.toFixed(1)+'</td></tr>';
            });
            const avgPoolDisp=isNaN(avgPool)?'‚Äî':avgPool.toFixed(0)+' mm';
            const avgFlameDisp=isNaN(avgFlame)||avgFlame===0?'‚Äî':avgFlame.toFixed(0)+' mm';
            rhtml+='<tr style="background:#f0ece5;font-weight:700;"><td style="padding:6px 8px;">MOY.</td><td>'+t.initial_mass+'g</td><td>'+cy[cy.length-1].mass_after+'g</td><td style="color:#c62828;">-'+avgConsumed.toFixed(1)+'g/cyc</td><td>'+avgPoolDisp+'</td>'+(clientMode?'':'<td>'+(avgDepth>0?avgDepth.toFixed(1)+' mm':'‚Äî')+'</td>')+'<td>'+avgFlameDisp+'</td><td>‚Äî</td><td>‚Äî</td><td style="color:'+sc(globalScore)+';">'+globalScore.toFixed(1)+'</td></tr></tbody></table></div></div>';

            // ‚îÄ‚îÄ CHA√éNE DE MASSE ‚îÄ‚îÄ
            rhtml+='<div style="background:#faf8f5;border:1px solid #e8e4de;border-radius:8px;padding:0.8rem;margin-bottom:1.5rem;"><p style="font-size:0.55rem;text-transform:uppercase;letter-spacing:1px;color:#999;margin:0 0 0.3rem;">√âvolution de la masse</p><p style="font-size:0.88rem;margin:0;"><strong style="color:#a32d03;">'+t.initial_mass+'g</strong>';
            cy.forEach(c => { rhtml += ' ‚Üí <strong>' + c.mass_after + 'g</strong>'; });
            rhtml+=' = <strong style="color:#c62828;">-'+totalConsumed.toFixed(1)+'g ('+pctConsumed.toFixed(1)+'%)</strong></p></div>';

            // ‚îÄ‚îÄ AVIS ‚îÄ‚îÄ
            rhtml+='<div style="margin-bottom:1.5rem;"><p style="font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:#888;margin:0 0 0.8rem;font-weight:600;border-bottom:2px solid #e8e4de;padding-bottom:0.3rem;">'+(clientMode?'Notre analyse':'Avis IA')+'</p><div style="background:'+(globalScore>=6.5?'rgba(56,142,60,0.06)':'rgba(198,40,40,0.06)')+';border-left:4px solid '+sc(globalScore)+';border-radius:4px;padding:1rem;"><p style="font-size:0.85rem;line-height:1.6;margin:0;">'+avis+'</p></div></div>';

            // ‚îÄ‚îÄ RECOMMANDATIONS ‚îÄ‚îÄ
            if(recos.length){
                rhtml+='<div style="margin-bottom:1rem;"><p style="font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:#888;margin:0 0 0.8rem;font-weight:600;border-bottom:2px solid #e8e4de;padding-bottom:0.3rem;">'+(clientMode?'Points d\'attention':'Recommandations techniques')+'</p><div style="background:#faf8f5;border:1px solid #e8e4de;border-radius:8px;padding:1rem;">';
                recos.forEach(r=>{rhtml+='<p style="font-size:0.8rem;margin:0 0 0.4rem;padding-left:1.2rem;position:relative;"><span style="position:absolute;left:0;color:#a32d03;">‚Ä∫</span> '+r+'</p>';});
                rhtml+='</div></div>';
            }

            // ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ
            rhtml+='<div style="text-align:center;padding-top:1rem;border-top:1px solid #e8e4de;margin-top:1rem;"><p style="font-size:0.6rem;color:#bbb;letter-spacing:1px;">'+(clientMode?'MAISON FRAN√áAISE DES CIRES ‚Äî LABORATOIRE D\'ESSAIS ‚Äî Ma√Ætre Cirier depuis 1904':'MFC Laboratoire ‚Äî Document interne')+'</p>';
            if(clientMode)rhtml+='<p style="font-size:0.55rem;color:#ccc;margin-top:0.2rem;">Ce rapport est √©tabli sur la base de tests normalis√©s en cycles de 4 heures. Les r√©sultats sont indicatifs et peuvent varier selon les conditions d\'utilisation.</p>';
            rhtml+='</div></div>';

            document.getElementById('report-body').innerHTML = rhtml;
            document.getElementById('report-modal').classList.add('active');
        }

        async function printReport() {
            const content = document.getElementById('report-body').innerHTML;
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Rapport MFC</title>
                <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                <style>body{font-family:'Open Sans',sans-serif;max-width:800px;margin:2rem auto;color:#2c2c2c;font-size:13px;line-height:1.5;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
                table{width:100%;border-collapse:collapse;margin:0.5rem 0;page-break-inside:avoid;}th,td{border:1px solid #eee;padding:5px 8px;text-align:left;}
                th{background:#1a1a1a !important;color:#f0e6d3 !important;border:none !important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
                strong{font-weight:700;}.grid{display:grid;gap:1rem;}.grid-3{grid-template-columns:repeat(3,1fr);}
                @media print{body{margin:1cm;}@page{margin:1.5cm;}}</style></head><body>${content}<scr` + `ipt src="/js/cache-buster.js"></scr` + `ipt><scr` + `ipt>fetch("/api/version").then(r=>r.json()).then(d=>{var v="v"+d.version;if(document.getElementById("mfc-v"))document.getElementById("mfc-v").textContent=v;if(document.getElementById("mfc-vf"))document.getElementById("mfc-vf").textContent=v;document.title=document.title.replace(/MFC Laboratoire/,"MFC Laboratoire "+v)}).catch(()=>{})</scr` + `ipt>
</body></html>`);
            w.document.close();
            setTimeout(() => w.print(), 500);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VALIDATION CLIENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openClientModal(decision) {
            document.getElementById('client-decision-type').value = decision;
            document.getElementById('client-feedback').value = '';
            const banner = document.getElementById('client-decision-banner');
            if (decision === 'valid√©') {
                document.getElementById('client-modal-title').textContent = '‚úì Validation client';
                banner.style.background = '#e8f5e9'; banner.style.color = '#2e7d32';
                banner.textContent = 'Le client valide cette formulation';
                document.getElementById('btn-save-client-decision').style.background = '#388e3c';
            } else {
                document.getElementById('client-modal-title').textContent = '‚úó Refus client';
                banner.style.background = '#fbe9e7'; banner.style.color = '#c62828';
                banner.textContent = 'Le client refuse cette formulation';
                document.getElementById('btn-save-client-decision').style.background = '#c62828';
            }
            document.getElementById('client-modal').classList.add('active');
        }

        async function saveClientDecision() {
            if (!currentTest) return;
            const decision = document.getElementById('client-decision-type').value;
            const feedback = document.getElementById('client-feedback').value.trim();
            if (!feedback) { toast('Commentaire client obligatoire', 'error'); return; }
            const r = await fetch('/api/burn-tests/' + currentTest.id + '/client-decision', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ client_status: decision, client_feedback: feedback })
            });
            const res = await r.json();
            if (res.error) { toast(res.error, 'error'); return; }
            document.getElementById('client-modal').classList.remove('active');
            toast(decision === 'valid√©' ? 'Valid√© ‚Äî commentaire ajout√© en base de connaissances' : 'Refus enregistr√© ‚Äî commentaire ajout√© en base de connaissances');
            closeDetailModal(); loadTests();
        }

        async function retryTest() {
            if (!currentTest) return;
            const adjustNotes = prompt('Quels ajustements pr√©voyez-vous pour cette reprise ?\n(m√®che, % parfum, composition cires, etc.)\n\nLaissez vide si non d√©fini.');
            if (adjustNotes === null) return; // cancelled
            const r = await fetch('/api/burn-tests/' + currentTest.id + '/retry', { 
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ adjust_notes: adjustNotes || '' })
            });
            const res = await r.json();
            if (res.error) { toast(res.error, 'error'); return; }
            toast('Reprise V' + res.version + ' cr√©√©e : ' + res.test_number);
            closeDetailModal(); loadTests();
            setTimeout(() => viewTest(res.id), 500);
        }

        async function loadVersionChain(testId) {
            try {
                const r = await fetch('/api/burn-tests/' + testId + '/history');
                const data = await r.json();
                const el = document.getElementById('version-chain-body');
                if (!el) return;
                let html = '';
                // Previous test
                if (data.previous) {
                    html += '<p style="margin:0 0 0.3rem;"><span style="color:#1565c0;cursor:pointer;text-decoration:underline;" onclick="closeDetailModal();setTimeout(()=>viewTest('+data.previous.id+'),200);">‚Üê ' + data.previous.test_number + '</span>';
                    html += data.previous.client_status ? ' <span style="font-size:0.7rem;color:'+(data.previous.client_status==='valid√©'?'#2e7d32':'#c62828')+';">('+data.previous.client_status+')</span>' : '';
                    if (data.previous.client_feedback) html += '<br><span style="font-size:0.72rem;color:#666;font-style:italic;">¬´ ' + data.previous.client_feedback.substring(0,80) + (data.previous.client_feedback.length>80?'...':'') + ' ¬ª</span>';
                    html += '</p>';
                }
                // Current
                html += '<p style="margin:0.3rem 0;font-weight:700;color:#1565c0;">‚ñ∏ ' + currentTest.test_number + ' (actuel)</p>';
                // Next versions
                if (data.next_versions && data.next_versions.length) {
                    data.next_versions.forEach(nv => {
                        html += '<p style="margin:0.2rem 0 0;"><span style="color:#1565c0;cursor:pointer;text-decoration:underline;" onclick="closeDetailModal();setTimeout(()=>viewTest('+nv.id+'),200);">‚Üí ' + nv.test_number + '</span>';
                        html += ' <span class="badge badge-'+nv.status+'" style="font-size:0.6rem;">'+nv.status+'</span>';
                        if (nv.client_status) html += ' <span style="font-size:0.65rem;color:'+(nv.client_status==='valid√©'?'#2e7d32':'#c62828')+';">('+nv.client_status+')</span>';
                        html += '</p>';
                    });
                }
                // History events
                if (data.history && data.history.length) {
                    html += '<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #90caf9;">';
                    html += '<p style="font-size:0.62rem;text-transform:uppercase;color:#1565c0;font-weight:600;margin:0 0 0.3rem;">Historique</p>';
                    data.history.forEach(h => {
                        const d = h.event_data ? JSON.parse(h.event_data) : {};
                        const dt = new Date(h.created_at).toLocaleDateString('fr-FR', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
                        let icon = 'üìã';
                        if (h.event_type === 'client_decision') icon = d.status === 'valid√©' ? '‚úì' : '‚úó';
                        else if (h.event_type === 'client_changement_avis') icon = 'üîÑ';
                        else if (h.event_type === 'reprise_lanc√©e') icon = '‚û°Ô∏è';
                        else if (h.event_type === 'cr√©√©_depuis_reprise') icon = 'üÜï';
                        html += '<p style="font-size:0.72rem;margin:0.15rem 0;color:#555;">' + icon + ' <span style="color:#999;">' + dt + '</span> ‚Äî ';
                        if (h.event_type === 'client_decision') html += 'Client ' + (d.status === 'valid√©' ? 'valide' : 'refuse');
                        else if (h.event_type === 'client_changement_avis') html += '<strong>Changement avis</strong> : ' + d.previous_status + ' ‚Üí ' + d.status;
                        else if (h.event_type === 'reprise_lanc√©e') html += 'Reprise lanc√©e ‚Üí ' + (d.nouveau_test || d.nouveau_numero || '');
                        else if (h.event_type === 'cr√©√©_depuis_reprise') html += 'Cr√©√© depuis ' + (d.original || d.test_original || '');
                        else html += h.event_type;
                        html += '</p>';
                    });
                    html += '</div>';
                }
                el.innerHTML = html;
            } catch(e) { console.error(e); }
        }

        // ESCAPE
        document.addEventListener('keydown', e => { if (e.key==='Escape') { closeNewTestModal(); closeDetailModal(); closeCycleModal(); closeReportModal(); document.getElementById('client-modal').classList.remove('active'); } });
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target===o) o.classList.remove('active'); }));

        // INIT
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFormulations(); await loadTests();
            document.getElementById('filter-status').addEventListener('change', loadTests);
            // Auto-open if coming from formulation
            const p = new URLSearchParams(location.search);
            if (p.get('formulation')) { await openNewTestModal(); }
        });
    </script>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL RAPPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="report-modal">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <h2 style="font-family:var(--font-display);">üìä Rapport de test ‚Äî Analyse IA</h2>
                <button class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body" id="report-body" style="max-height:75vh; overflow-y:auto;"></div>
            <div class="modal-footer" style="display:flex; align-items:center; gap:1rem;">
                <label style="display:flex; align-items:center; gap:0.4rem; font-size:0.82rem; cursor:pointer; margin-right:auto;">
                    <input type="checkbox" id="client-mode" onchange="generateReport()">
                    <span>üîí Mode client</span>
                    <span style="font-size:0.7rem; color:var(--texte-muted);">(caviarde mati√®res, m√®ches, fournisseurs)</span>
                </label>
                <button class="btn btn-secondary" onclick="closeReportModal()">Fermer</button>
                <button class="btn btn-primary" onclick="printReport()">üñ®Ô∏è Imprimer</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL RETOUR CLIENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="client-modal">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h2 id="client-modal-title">Retour client</h2>
                <button class="modal-close" onclick="document.getElementById('client-modal').classList.remove('active')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="client-decision-type">
                <div id="client-decision-banner" style="padding:0.6rem;border-radius:6px;text-align:center;font-weight:600;margin-bottom:1rem;"></div>
                <div class="form-group">
                    <label>Commentaire du client *</label>
                    <textarea class="form-control" id="client-feedback" rows="4" placeholder="Ex: Le parfum manque de puissance, la couleur ne correspond pas, bonne combustion mais souhait de plus de diffusion..."></textarea>
                </div>
                <p style="font-size:0.72rem;color:var(--texte-muted);">üí° Ce commentaire sera automatiquement ajout√© √† la base de connaissances IA pour am√©liorer les futures formulations.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('client-modal').classList.remove('active')">Annuler</button>
                <button class="btn btn-primary" id="btn-save-client-decision" onclick="saveClientDecision()">Enregistrer</button>
            </div>
        </div>
    </div>
<script src="/js/operator-selector.js"></script>
<script src="/js/cache-buster.js"></script>
<script>fetch("/api/version").then(r=>r.json()).then(d=>{var v="v"+d.version;if(document.getElementById("mfc-v"))document.getElementById("mfc-v").textContent=v;if(document.getElementById("mfc-vf"))document.getElementById("mfc-vf").textContent=v;document.title=document.title.replace(/MFC Laboratoire/,"MFC Laboratoire "+v)}).catch(()=>{})</script>
</body>
</html>
